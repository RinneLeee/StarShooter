<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Split Balance</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #fafafa;
            color: #171717;
            -webkit-font-smoothing: antialiased;
        }
        @media (max-width: 640px) { html { font-size: 14px; } }
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e5e5; border-radius: 3px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 10s linear infinite; padding-right: 2rem; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    </style>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const CURRENCIES = {
            'USD': { symbol: '$' }, 'RM': { symbol: 'RM' }, 'YEN': { symbol: '¥' }, 'TWD': { symbol: 'NT$' },
            'HKD': { symbol: 'HK$' }, 'SGD': { symbol: 'S$' }, 'IDR': { symbol: 'Rp' }, 'THB': { symbol: '฿' }, 'AUD': { symbol: 'A$' }
        };

        const Icon = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Receipt = (props) => <Icon {...props}><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M16 8h-6"/><path d="M16 12h-6"/><path d="M10 16h-6"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18M6 6l12 12"/></Icon>;
        const ArrowRight = (props) => <Icon {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></Icon>;

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white border border-gray-100 rounded-xl shadow-[0_2px_8px_-4px_rgba(0,0,0,0.05)] ${className}`}>{children}</div>
        );

        const MarqueeText = ({ text }) => {
            const containerRef = useRef(null);
            const [shouldMarquee, setShouldMarquee] = useState(false);
            useEffect(() => { if (containerRef.current) setShouldMarquee(text.length > 12); }, [text]);
            if (!shouldMarquee) return <span className="font-semibold text-gray-900 truncate block">{text}</span>;
            return <div className="marquee-container w-full" ref={containerRef}><div className="marquee-content font-semibold text-gray-900">{text} <span className="text-transparent">____</span> {text} <span className="text-transparent">____</span></div></div>;
        };

        const ModalOverlay = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-white/80 backdrop-blur-sm transition-opacity" onClick={onClose} />
                    <div className="relative w-full max-w-md bg-white rounded-2xl shadow-2xl border border-gray-100 animate-slide-up overflow-hidden max-h-[90vh] overflow-y-auto">
                        {children}
                    </div>
                </div>
            );
        };

        const SettlementDetailModal = ({ user, transactions, onClose, currencySymbol }) => {
            if (!user) return null;
            const owedToUser = transactions.filter(t => t.to === user);
            const userOwes = transactions.filter(t => t.from === user);
            const netBalance = owedToUser.reduce((a, t) => a + parseFloat(t.amount), 0) - userOwes.reduce((a, t) => a + parseFloat(t.amount), 0);

            return (
                <ModalOverlay isOpen={true} onClose={onClose}>
                    <div className="border-b border-gray-100 p-4 flex items-center justify-between bg-white sticky top-0 z-10">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Balance Details</span>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-900 transition-colors"><X size={18} /></button>
                    </div>
                    <div className="p-6 space-y-6">
                        <div className="text-center">
                            <h2 className="text-2xl font-bold text-gray-900">{user}</h2>
                            <p className={`text-sm font-medium mt-1 ${netBalance >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                {netBalance >= 0 ? `Net: +${currencySymbol}${netBalance.toFixed(2)}` : `Net: -${currencySymbol}${Math.abs(netBalance).toFixed(2)}`}
                            </p>
                        </div>
                        <div className="space-y-6">
                            <div><h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Outgoing (Must pay)</h3>{userOwes.length === 0 ? <p className="text-sm text-gray-400 italic bg-gray-50 p-3 rounded-lg border border-gray-100">{user} owes nothing.</p> : (<div className="space-y-3">{userOwes.map((t, idx) => (<div key={idx} className="flex justify-between items-center p-3 bg-red-50/50 rounded-lg border border-red-100"><div className="flex flex-col"><span className="text-xs text-red-400 font-bold uppercase mb-0.5">Owe</span><span className="text-sm font-bold text-gray-900">{t.to}</span></div><span className="text-sm font-bold text-red-700">-{currencySymbol}{t.amount}</span></div>))}</div>)}</div>
                            <div><h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Incoming (Get back)</h3>{owedToUser.length === 0 ? <p className="text-sm text-gray-400 italic bg-gray-50 p-3 rounded-lg border border-gray-100">No one owes {user} money.</p> : (<div className="space-y-3">{owedToUser.map((t, idx) => (<div key={idx} className="flex justify-between items-center p-3 bg-emerald-50/50 rounded-lg border border-emerald-100"><div className="flex flex-col"><span className="text-xs text-emerald-500 font-bold uppercase mb-0.5">From</span><span className="text-sm font-bold text-gray-900">{t.from}</span></div><span className="text-sm font-bold text-emerald-700">+{currencySymbol}{t.amount}</span></div>))}</div>)}</div>
                        </div>
                    </div>
                </ModalOverlay>
            );
        };

        const App = () => {
            const [data, setData] = useState(null);
            const [error, setError] = useState(null);
            const [selectedUserForSettlement, setSelectedUserForSettlement] = useState(null);
            const [sharedTime, setSharedTime] = useState(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const compressedData = params.get('data');
                const time = params.get('time');

                if (time) {
                    const date = new Date(parseInt(time));
                    const formatter = new Intl.DateTimeFormat('en-MY', {
                        timeZone: 'Asia/Kuala_Lumpur',
                        dateStyle: 'medium',
                        timeStyle: 'short'
                    });
                    setSharedTime(formatter.format(date));
                }

                if (compressedData) {
                    try {
                        const json = LZString.decompressFromEncodedURIComponent(compressedData);
                        if (json) {
                            setData(JSON.parse(json));
                        } else {
                            setError("Failed to decompress data.");
                        }
                    } catch (e) {
                        setError("Invalid data link.");
                    }
                } else {
                    setError("No data found in link.");
                }
            }, []);

            /* * PAIRWISE DEBT LOGIC
             * Consistent with the main dashboard to ensure A->B and B->C doesn't vanish.
             */
            const settlement = useMemo(() => {
                if (!data) return [];
                
                // 1. Calculate raw pairwise debts
                const debtMatrix = {}; 
                data.travelers.forEach(t1 => {
                    debtMatrix[t1] = {};
                    data.travelers.forEach(t2 => { if(t1 !== t2) debtMatrix[t1][t2] = 0; });
                });

                data.receipts.forEach(r => {
                    const payer = r.payer;
                    r.splitDetails.forEach(split => {
                        const debtor = split.name;
                        const amount = parseFloat(split.amount);
                        if (payer !== debtor && debtMatrix[debtor] && debtMatrix[debtor][payer] !== undefined) {
                            debtMatrix[debtor][payer] += amount;
                        }
                    });
                });

                // 2. Simplify Pairwise (Netting)
                const transactions = [];
                const processedPairs = new Set();

                data.travelers.forEach(p1 => {
                    data.travelers.forEach(p2 => {
                        if (p1 === p2) return;
                        const pairKey = [p1, p2].sort().join('-');
                        if (processedPairs.has(pairKey)) return;
                        processedPairs.add(pairKey);

                        const p1OwesP2 = debtMatrix[p1][p2] || 0;
                        const p2OwesP1 = debtMatrix[p2][p1] || 0;
                        const net = p1OwesP2 - p2OwesP1;

                        if (net > 0.01) {
                            transactions.push({ from: p1, to: p2, amount: net.toFixed(2) });
                        } else if (net < -0.01) {
                            transactions.push({ from: p2, to: p1, amount: Math.abs(net).toFixed(2) });
                        }
                    });
                });
                return transactions;
            }, [data]);

            if (error) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 gap-4">
                        <div className="text-center text-gray-500">
                            <AlertTriangle className="mx-auto mb-2 text-gray-400" size={32}/>
                            <p>{error}</p>
                        </div>
                        <a href="TravelSplit.html" className="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center gap-1">
                            Go to App <ArrowRight size={14} />
                        </a>
                    </div>
                );
            }

            if (!data) return <div className="min-h-screen flex items-center justify-center text-gray-400">Loading...</div>;

            const currencySymbol = CURRENCIES[data.currencyCode]?.symbol || '$';

            return (
                <div className="min-h-screen bg-[#fafafa] flex flex-col">
                    <nav className="sticky top-0 z-20 bg-[#fafafa]/90 backdrop-blur-md border-b border-gray-100 px-6 py-4">
                        <div className="flex justify-between items-center max-w-4xl mx-auto">
                            <a href="TravelSplit.html" className="flex items-center gap-2 font-bold text-xl tracking-tight text-gray-900 hover:opacity-80 transition-opacity">
                                <div className="w-8 h-8 bg-gray-900 text-white rounded-lg flex items-center justify-center"><Receipt size={18}/></div>
                                TravelSplit <span className="text-gray-400 font-normal text-sm ml-2 hidden sm:inline">Shared Receipt</span>
                            </a>
                            <div className="text-xs text-gray-400 text-right">
                                <p>Shared on</p>
                                <p className="font-medium text-gray-600">{sharedTime || 'Unknown'}</p>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto p-6 md:p-12 space-y-10 animate-fade-in flex-1 w-full">
                        {/* Summary Headers */}
                        <div className="grid grid-cols-2 gap-4">
                            <Card className="p-6"><p className="text-xs font-semibold text-gray-500 uppercase">Total Spent</p><p className="text-3xl font-bold text-gray-900 mt-2">{currencySymbol}{data.receipts.filter(r => r.type !== 'payment').reduce((acc, r) => acc + parseFloat(r.total), 0).toFixed(0)}</p></Card>
                            <Card className="p-6"><p className="text-xs font-semibold text-gray-500 uppercase">Transactions</p><p className="text-3xl font-bold text-gray-900 mt-2">{data.receipts.length}</p></Card>
                        </div>

                        {/* Balances Section - Split View Cards */}
                        <section className="space-y-4">
                            <div className="flex justify-between items-center"><h2 className="text-sm font-bold text-gray-400 uppercase tracking-widest">Balances</h2><span className="text-xs text-gray-400">Scroll to see more &rarr;</span></div>
                            <div className="flex gap-4 overflow-x-auto pb-4 snap-x">
                                {data.travelers.length === 0 ? (<div className="w-full bg-white border border-dashed border-gray-200 rounded-xl p-8 text-center text-sm text-gray-400">No travelers found.</div>) : (data.travelers.map(user => { 
                                    const myIncoming = settlement.filter(t => t.to === user);
                                    const myOutgoing = settlement.filter(t => t.from === user);
                                    const totalIn = myIncoming.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                                    const totalOut = myOutgoing.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                                    const isSettled = totalIn === 0 && totalOut === 0;

                                    return (
                                        <Card key={user} onClick={() => setSelectedUserForSettlement(user)} className="min-w-[160px] max-w-[160px] p-4 flex-shrink-0 snap-center cursor-pointer hover:border-gray-400 transition-all group">
                                            <div className="mb-4">
                                                <div className="w-10 h-10 rounded-full bg-gray-50 border border-gray-100 flex items-center justify-center text-sm font-bold text-gray-600 mb-3 group-hover:bg-gray-100 transition-colors">{user.charAt(0)}</div>
                                                <MarqueeText text={user} />
                                            </div>
                                            <div className="space-y-2 pt-2 border-t border-gray-50">
                                                {totalOut > 0 && (
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-[10px] font-bold text-red-400 uppercase tracking-wider">Owes</span>
                                                        <span className="text-sm font-bold text-red-600">-{currencySymbol}{totalOut.toFixed(2)}</span>
                                                    </div>
                                                )}
                                                {totalIn > 0 && (
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-[10px] font-bold text-emerald-500 uppercase tracking-wider">Gets</span>
                                                        <span className="text-sm font-bold text-emerald-600">+{currencySymbol}{totalIn.toFixed(2)}</span>
                                                    </div>
                                                )}
                                                {isSettled && (
                                                    <div className="text-center py-1">
                                                       <span className="text-xs font-bold text-gray-300 uppercase tracking-widest">Settled</span>
                                                    </div>
                                                )}
                                            </div>
                                        </Card>
                                    ); 
                                }))}
                            </div>
                        </section>

                        {/* Full History */}
                        <section className="space-y-4 pt-8 border-t border-gray-100">
                            <h2 className="text-sm font-bold text-gray-400 uppercase tracking-widest">Full History</h2>
                            <div className="space-y-3">
                                {data.receipts.map(r => (
                                    <div key={r.id} className="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center opacity-80 hover:opacity-100 transition-opacity">
                                        <div className="flex items-center gap-4">
                                            {r.type === 'payment' ? (
                                                <div className="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center border border-emerald-100"><CheckCircle size={14} /></div>
                                            ) : (
                                                <div className="w-8 h-8 rounded-full bg-gray-50 text-gray-600 flex items-center justify-center text-xs font-bold border border-gray-100">{r.payer.charAt(0)}</div>
                                            )}
                                            <div>
                                                <h3 className="font-semibold text-gray-900 text-sm">{r.title}</h3>
                                                <p className="text-[10px] text-gray-500 uppercase tracking-wide">{new Date(r.date).toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                        <span className={`font-mono text-sm font-medium ${r.type === 'payment' ? 'text-emerald-600' : 'text-gray-900'}`}>{currencySymbol}{r.total}</span>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>

                    {/* Footer CTA */}
                    <footer className="py-8 text-center bg-gray-50 border-t border-gray-100 mt-auto">
                        <p className="text-gray-500 text-sm mb-2">Try for yourself?</p>
                        <a href="TravelSplit.html" className="inline-flex items-center gap-2 text-gray-900 font-bold hover:text-black hover:underline transition-all">
                            Use Expense Splitter <ArrowRight size={16} />
                        </a>
                    </footer>

                    <SettlementDetailModal user={selectedUserForSettlement} transactions={settlement} onClose={() => setSelectedUserForSettlement(null)} currencySymbol={currencySymbol} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
