<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan & Savings Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        .transaction-log::-webkit-scrollbar {
            width: 6px;
        }
        .transaction-log::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .transaction-log::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .transaction-log::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* A subtle animation for new elements */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        /* Style for the notification toast */
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            z-index: 1000;
        }
        #notification.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-full mx-auto px-4">
        <header class="text-center mb-8">
            <div class="mt-4 bg-white p-3 rounded-xl shadow-md inline-block">
                <h3 class="text-lg font-bold text-gray-700">Months Passed: <span id="months-passed" class="text-purple-600">0</span></h3>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Left Column: Controls -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Savings Account Card -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Savings Account</h2>
                    <div class="text-3xl font-bold mb-4" id="savings-balance">
                        $0.00
                    </div>
                    <form id="set-balance-form" class="space-y-3 mb-4">
                        <label for="initial-balance" class="block text-sm font-medium text-gray-600">Set Starting Balance</label>
                        <input type="number" id="initial-balance" placeholder="Enter amount" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <button type="submit" class="w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors duration-300 shadow">
                            Set Balance
                        </button>
                    </form>
                    <hr class="my-4">
                    <form id="add-savings-form" class="space-y-3">
                        <label for="savings-amount" class="block text-sm font-medium text-gray-600">Add to Savings</label>
                        <input type="number" id="savings-amount" placeholder="Enter amount" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
                        <button type="submit" class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-300 shadow">
                            Add Funds
                        </button>
                    </form>
                </div>

                <!-- Add Loan Card -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Add a New Loan</h2>
                    <form id="add-loan-form" class="space-y-4">
                        <div>
                            <label for="loan-name" class="block text-sm font-medium text-gray-600">Loan Name</label>
                            <input type="text" id="loan-name" placeholder="e.g., Car Loan" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="loan-amount" class="block text-sm font-medium text-gray-600">Total Loan Amount</label>
                            <input type="number" id="loan-amount" placeholder="e.g., 20000" min="1" step="0.01" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="monthly-installment" class="block text-sm font-medium text-gray-600">Monthly Installment</label>
                            <input type="number" id="monthly-installment" placeholder="e.g., 500" min="1" step="0.01" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label for="rental-income" class="block text-sm font-medium text-gray-600">Monthly Rental Income (Optional)</label>
                            <input type="number" id="rental-income" placeholder="e.g., 200" min="0" step="0.01" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300 shadow">
                            Add Loan
                        </button>
                    </form>
                </div>
                
                <!-- Clear Data Card -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Settings</h2>
                    <button id="clear-data-btn" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-300 shadow">
                        Clear All Data
                    </button>
                </div>
            </div>

            <!-- Right Column: Loans Display -->
            <div class="lg:col-span-3">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                     <h2 class="text-2xl font-bold text-gray-800">Your Loans</h2>
                     <button id="process-month-btn" class="w-full sm:w-auto mt-2 sm:mt-0 bg-purple-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-purple-700 transition-colors duration-300 shadow">
                        Process Next Month
                    </button>
                </div>
               
                <div id="loans-container" class="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-6">
                    <!-- Loan cards will be injected here -->
                    <p id="no-loans-message" class="text-center text-gray-500 bg-white p-6 rounded-xl shadow-md xl:col-span-2 2xl:col-span-3">You have no active loans. Add one to get started!</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Toast -->
    <div id="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const savingsBalanceEl = document.getElementById('savings-balance');
            const monthsPassedEl = document.getElementById('months-passed');
            const addSavingsForm = document.getElementById('add-savings-form');
            const savingsAmountInput = document.getElementById('savings-amount');
            const setBalanceForm = document.getElementById('set-balance-form');
            const initialBalanceInput = document.getElementById('initial-balance');

            const addLoanForm = document.getElementById('add-loan-form');
            const loanNameInput = document.getElementById('loan-name');
            const loanAmountInput = document.getElementById('loan-amount');
            const monthlyInstallmentInput = document.getElementById('monthly-installment');
            const rentalIncomeInput = document.getElementById('rental-income');

            const loansContainer = document.getElementById('loans-container');
            const noLoansMessage = document.getElementById('no-loans-message');
            const notificationEl = document.getElementById('notification');
            const processMonthBtn = document.getElementById('process-month-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');

            let state = {
                savingsBalance: 0,
                loans: [],
                monthsPassed: 0,
            };

            // --- UTILITY FUNCTIONS ---
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                }).format(amount);
            };
            
            const formatDate = (date) => {
                const d = new Date(date);
                return d.toLocaleString();
            };
            
            const showNotification = (message, type = 'success') => {
                notificationEl.textContent = message;
                notificationEl.className = ''; // Clear previous classes
                notificationEl.classList.add('show');
                if (type === 'success') {
                    notificationEl.classList.add('bg-green-500');
                } else if (type === 'error') {
                    notificationEl.classList.add('bg-red-500');
                } else {
                    notificationEl.classList.add('bg-blue-500');
                }

                setTimeout(() => {
                    notificationEl.classList.remove('show');
                }, 3000);
            };

            // --- DATA PERSISTENCE ---
            const saveData = () => {
                localStorage.setItem('loanTrackerState', JSON.stringify(state));
            };

            const loadData = () => {
                const savedState = localStorage.getItem('loanTrackerState');
                if (savedState) {
                    state = JSON.parse(savedState);
                    // Backward compatibility for new properties
                    if (state.loans) {
                        state.loans.forEach(loan => {
                            if (loan.prepaidThisMonth === undefined) {
                                loan.prepaidThisMonth = false;
                            }
                        });
                    }
                }
            };

            // --- RENDERING ---
            const render = () => {
                // Render Savings and Month Counter
                savingsBalanceEl.textContent = formatCurrency(state.savingsBalance);
                savingsBalanceEl.classList.toggle('text-red-600', state.savingsBalance < 0);
                savingsBalanceEl.classList.toggle('text-green-600', state.savingsBalance >= 0);

                monthsPassedEl.textContent = state.monthsPassed;

                // Render Loans
                loansContainer.innerHTML = '';
                if (state.loans.length === 0) {
                    loansContainer.appendChild(noLoansMessage);
                } else {
                    state.loans.forEach(loan => {
                        const loanCard = document.createElement('div');
                        loanCard.className = 'bg-white p-6 rounded-xl shadow-md fade-in flex flex-col';
                        loanCard.dataset.id = loan.id;

                        const paidAmount = loan.totalAmount - loan.remainingAmount;
                        const progressPercentage = loan.totalAmount > 0 ? (paidAmount / loan.totalAmount) * 100 : 0;

                        // Transaction log helpers
                        const getTransactionBgClass = (type) => {
                            if (type === 'in') return 'bg-green-100';
                            if (type === 'out') return 'bg-red-100';
                            return 'bg-blue-100'; // For 'info' type
                        };
                         const getTransactionTextClass = (type) => {
                            if (type === 'in') return 'text-green-800';
                            if (type === 'out') return 'text-red-800';
                            return 'text-blue-800';
                        };
                        const getTransactionPrefix = (type, amount) => {
                            if (type === 'in') return `+${formatCurrency(amount)}`;
                            if (type === 'out') return `-${formatCurrency(amount)}`;
                            return `To: ${formatCurrency(amount)}`; // For rental updates
                        };

                        loanCard.innerHTML = `
                            <div>
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">${loan.name}</h3>
                                        <p class="text-sm text-gray-500">Monthly Installment: ${formatCurrency(loan.monthlyPayment)}</p>
                                        <div class="rental-section mt-1" data-id="${loan.id}">
                                            <div class="rental-display-mode">
                                                <p class="text-sm ${loan.rentalIncome > 0 ? 'text-green-600 font-medium' : 'text-gray-500'}">
                                                    Monthly Rental: ${loan.rentalIncome > 0 ? formatCurrency(loan.rentalIncome) : 'None'}
                                                    <button class="edit-rental-btn text-indigo-500 hover:text-indigo-700 text-xs font-semibold ml-2 p-1">(${loan.rentalIncome > 0 ? 'Edit' : 'Add'})</button>
                                                </p>
                                            </div>
                                            <div class="rental-edit-mode hidden mt-2">
                                                <form class="update-rental-form flex items-center gap-2" data-id="${loan.id}">
                                                    <input type="number" value="${loan.rentalIncome}" min="0" step="0.01" required class="flex-grow text-sm px-2 py-1 border border-gray-300 rounded-md focus:ring-1 focus:ring-indigo-500">
                                                    <button type="submit" class="text-sm bg-indigo-500 text-white font-semibold py-1 px-2 rounded-md hover:bg-indigo-600">Save</button>
                                                    <button type="button" class="cancel-edit-btn text-sm text-gray-600 hover:text-gray-800">Cancel</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="delete-loan-btn text-red-400 hover:text-red-600 transition-colors" data-id="${loan.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="mt-4">
                                    <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                                        <span>Progress</span>
                                        <span>${formatCurrency(paidAmount)} / ${formatCurrency(loan.totalAmount)}</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 text-center">
                                    <span class="text-gray-600">Remaining Balance</span>
                                    <p class="text-2xl font-bold ${loan.remainingAmount <= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${formatCurrency(loan.remainingAmount)}
                                    </p>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                    <!-- Advance Payment Section -->
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-gray-700">Advance Payment Pool</h4>
                                        <p class="text-lg font-bold text-blue-600">${formatCurrency(loan.advancePayment)}</p>
                                        <form class="advance-payment-form mt-2 space-y-2" data-id="${loan.id}">
                                            <input type="number" min="0.01" step="0.01" placeholder="Amount" required class="w-full text-sm px-3 py-1.5 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                            <button type="submit" class="w-full text-sm bg-blue-100 text-blue-700 font-semibold py-1.5 px-3 rounded-md hover:bg-blue-200 transition-colors">Add to Advance</button>
                                        </form>
                                    </div>
                                    <!-- Monthly Payment Section -->
                                    <div class="bg-gray-50 p-4 rounded-lg flex flex-col justify-center">
                                        <h4 class="font-semibold text-gray-700 text-center">Pre-pay to Advance Pool</h4>
                                        <button class="pay-loan-btn mt-2 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors disabled:bg-gray-400" data-id="${loan.id}" ${loan.remainingAmount <= 0 || loan.prepaidThisMonth ? 'disabled' : ''}>
                                            ${loan.remainingAmount <= 0 ? 'Loan Paid' : (loan.prepaidThisMonth ? 'Pre-paid This Month' : `Pre-pay ${formatCurrency(loan.monthlyPayment)}`)}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Transaction Log -->
                            <div class="mt-6 flex-grow flex flex-col">
                                <h4 class="font-semibold text-gray-700 mb-2">Transaction History</h4>
                                <div class="transaction-log flex-grow h-40 overflow-y-auto bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2 text-sm">
                                    ${loan.transactions.length > 0 ? loan.transactions.map(t => `
                                        <div class="flex justify-between items-center p-2 rounded-md ${getTransactionBgClass(t.type)}">
                                            <div>
                                                <p class="font-medium ${getTransactionTextClass(t.type)}">${getTransactionPrefix(t.type, t.amount)}</p>
                                                <p class="text-xs text-gray-500">Source: ${t.source}</p>
                                            </div>
                                            <p class="text-xs text-gray-500">${formatDate(t.date)}</p>
                                        </div>
                                    `).join('') : '<p class="text-center text-gray-400 pt-10">No transactions yet.</p>'}
                                </div>
                            </div>
                        `;
                        loansContainer.appendChild(loanCard);
                    });
                }
                saveData();
            };

            // --- EVENT HANDLERS ---
            setBalanceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(initialBalanceInput.value);
                if(isNaN(amount)) {
                     showNotification('Please enter a valid balance.', 'error');
                    return;
                }
                state.savingsBalance = amount;
                showNotification(`Savings balance set to ${formatCurrency(amount)}`, 'success');
                setBalanceForm.reset();
                render();
            });

            addSavingsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(savingsAmountInput.value);
                if (isNaN(amount)) {
                    showNotification('Please enter a valid amount.', 'error');
                    return;
                }
                state.savingsBalance += amount;
                showNotification(`${formatCurrency(amount)} added to savings!`, 'success');
                addSavingsForm.reset();
                render();
            });

            addLoanForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = loanNameInput.value.trim();
                const totalAmount = parseFloat(loanAmountInput.value);
                const monthlyPayment = parseFloat(monthlyInstallmentInput.value);
                const rentalIncome = parseFloat(rentalIncomeInput.value) || 0;

                if (!name || isNaN(totalAmount) || totalAmount <= 0 || isNaN(monthlyPayment) || monthlyPayment <= 0) {
                    showNotification('Please fill all required fields with valid values.', 'error');
                    return;
                }

                const newLoan = {
                    id: Date.now().toString(),
                    name: name,
                    totalAmount: totalAmount,
                    remainingAmount: totalAmount,
                    monthlyPayment: monthlyPayment,
                    advancePayment: 0,
                    rentalIncome: rentalIncome,
                    transactions: [],
                    prepaidThisMonth: false,
                };

                state.loans.push(newLoan);
                showNotification(`Loan "${name}" has been added.`, 'info');
                addLoanForm.reset();
                render();
            });
            
            clearDataBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                    localStorage.removeItem('loanTrackerState');
                    state = {
                        savingsBalance: 0,
                        loans: [],
                        monthsPassed: 0,
                    };
                    showNotification('All data has been cleared.', 'info');
                    render();
                }
            });

            processMonthBtn.addEventListener('click', () => {
                let totalRentalIncome = 0;
                let totalPaid = 0;

                // 1. Collect all rental income and add to savings
                state.loans.forEach(loan => {
                    if (loan.rentalIncome > 0 && loan.remainingAmount > 0) {
                        state.savingsBalance += loan.rentalIncome;
                        totalRentalIncome += loan.rentalIncome;
                        // Log this income in the respective loan's transaction history
                        loan.transactions.unshift({
                            date: new Date().toISOString(),
                            amount: loan.rentalIncome,
                            source: `Rental income (to savings)`,
                            type: 'in'
                        });
                    }
                });

                if (totalRentalIncome > 0) {
                    showNotification(`Added ${formatCurrency(totalRentalIncome)} in rentals to savings.`, 'success');
                }

                // 2. Pay installments for each loan
                state.loans.forEach(loan => {
                    if (loan.remainingAmount <= 0) return; // Skip paid loans

                    let paymentAmount = Math.min(loan.monthlyPayment, loan.remainingAmount);
                    let paidFromAdvance = 0;
                    let paidFromSavings = 0;
                    
                    // Use Advance Payment first
                    if (loan.advancePayment > 0) {
                        const amountToTakeFromAdvance = Math.min(paymentAmount, loan.advancePayment);
                        loan.advancePayment -= amountToTakeFromAdvance;
                        paidFromAdvance = amountToTakeFromAdvance;
                        paymentAmount -= amountToTakeFromAdvance;
                    }

                    // Use Savings for the rest (allow savings to go negative)
                    if (paymentAmount > 0) {
                        paidFromSavings = paymentAmount;
                        state.savingsBalance -= paymentAmount;
                    }

                    const monthlyTotalPaid = paidFromAdvance + paidFromSavings;
                    if (monthlyTotalPaid > 0) {
                        loan.remainingAmount -= monthlyTotalPaid;
                        totalPaid += monthlyTotalPaid;

                         if (paidFromAdvance > 0) {
                            loan.transactions.unshift({ date: new Date().toISOString(), amount: paidFromAdvance, source: 'Advance Payment', type: 'out' });
                        }
                        if (paidFromSavings > 0) {
                            loan.transactions.unshift({ date: new Date().toISOString(), amount: paidFromSavings, source: 'Savings Account', type: 'out' });
                        }
                    }

                    if (loan.remainingAmount <= 0) {
                        loan.remainingAmount = 0;
                        showNotification(`Congratulations! "${loan.name}" is fully paid off!`, 'success');
                    }
                });
                
                // Reset pre-payment status for the new month
                state.loans.forEach(loan => {
                    loan.prepaidThisMonth = false;
                });
                
                state.monthsPassed++;
                showNotification(`Month ${state.monthsPassed} processed. Total paid: ${formatCurrency(totalPaid)}`, 'info');
                render();
            });
            
            loansContainer.addEventListener('click', (e) => {
                const target = e.target;
                const button = target.closest('button');
                if (!button) return;
                
                // --- Handle Toggling Rental Edit Form ---
                if (button.classList.contains('edit-rental-btn') || button.classList.contains('cancel-edit-btn')) {
                    const rentalSection = button.closest('.rental-section');
                    if (rentalSection) {
                        const displayMode = rentalSection.querySelector('.rental-display-mode');
                        const editMode = rentalSection.querySelector('.rental-edit-mode');
                        displayMode.classList.toggle('hidden');
                        editMode.classList.toggle('hidden');
                    }
                }
                
                // --- Handle Deleting a Loan ---
                if (button.classList.contains('delete-loan-btn')) {
                    const loanId = button.dataset.id;
                    const loanIndex = state.loans.findIndex(l => l.id === loanId);
                    if (loanIndex > -1) {
                         if (confirm(`Are you sure you want to delete the "${state.loans[loanIndex].name}" loan?`)) {
                            state.loans.splice(loanIndex, 1);
                            showNotification('Loan deleted.', 'info');
                            render();
                        }
                    }
                }
                
                // --- Handle Making a Pre-Payment ---
                if (button.classList.contains('pay-loan-btn')) {
                    const loanId = button.dataset.id;
                    const loan = state.loans.find(l => l.id === loanId);
                    if (!loan || loan.remainingAmount <= 0 || loan.prepaidThisMonth) return;

                    let paymentAmount = loan.monthlyPayment;
                    
                    if (state.savingsBalance < paymentAmount) {
                        showNotification('Insufficient savings to pre-pay.', 'error');
                        return;
                    }
                    
                    // Deduct from savings and add to advance pool
                    state.savingsBalance -= paymentAmount;
                    loan.advancePayment += paymentAmount;
                    loan.prepaidThisMonth = true;

                    // Log the transaction as an 'in' to the advance pool
                    loan.transactions.unshift({ date: new Date().toISOString(), amount: paymentAmount, source: 'Savings (Manual Pre-payment)', type: 'in' });
                    
                    showNotification(`Pre-payment for "${loan.name}" moved to advance pool.`, 'success');
                    render();
                }
            });

            loansContainer.addEventListener('submit', (e) => {
                 e.preventDefault();
                const form = e.target;
                
                // --- Handle Adding to Advance Payment ---
                if (form.classList.contains('advance-payment-form')) {
                    const loanId = form.dataset.id;
                    const loan = state.loans.find(l => l.id === loanId);
                    const input = form.querySelector('input[type="number"]');
                    const amount = parseFloat(input.value);

                    if (!loan || isNaN(amount) || amount <= 0) {
                        showNotification('Please enter a valid amount.', 'error');
                        return;
                    }
                    
                    if (state.savingsBalance < amount) {
                        showNotification('Insufficient savings to add to advance pool.', 'error');
                        return;
                    }

                    state.savingsBalance -= amount;
                    loan.advancePayment += amount;

                    loan.transactions.unshift({ date: new Date().toISOString(), amount: amount, source: 'Savings Deposit', type: 'in' });
                    
                    showNotification(`${formatCurrency(amount)} added to "${loan.name}" advance payments.`, 'success');
                    form.reset();
                    render();
                }

                // --- Handle Updating Rental Income ---
                if (form.classList.contains('update-rental-form')) {
                    const loanId = form.dataset.id;
                    const loan = state.loans.find(l => l.id === loanId);
                    const input = form.querySelector('input[type="number"]');
                    const newRentalAmount = parseFloat(input.value);

                    if (!loan || isNaN(newRentalAmount) || newRentalAmount < 0) {
                        showNotification('Please enter a valid rental amount.', 'error');
                        return;
                    }

                    loan.rentalIncome = newRentalAmount;
                    loan.transactions.unshift({ date: new Date().toISOString(), amount: newRentalAmount, source: 'Rental amount updated', type: 'info' });

                    showNotification(`Rental income for "${loan.name}" updated.`, 'success');
                    render();
                }
            });


            // --- INITIALIZATION ---
            loadData();
            render();
        });
    </script>
</body>
</html>


