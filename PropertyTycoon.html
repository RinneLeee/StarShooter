<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; 
            color: #1f2937; 
        }
        .game-container {
            max-width: 1280px; 
            margin: 20px auto;
            padding: 20px;
            background-color: #f9fafb; 
            border-radius: 16px; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.15); 
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #e5e7eb; 
            position: relative; /* For golden glow positioning */
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.12);
        }
        .card.golden-opportunity {
            border: 2px solid #fbbf24; /* Amber-400 border */
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.6); /* Amber glow */
        }
        .card.golden-opportunity::before {
            content: '⭐ Golden Opportunity!';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fbbf24;
            color: #422006; /* Dark brown text */
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 10;
        }

        .card h3 {
            font-size: 1.25rem; 
            font-weight: 700; 
            margin-bottom: 12px;
            color: #3730a3; 
        }
        .card p {
            font-size: 0.9rem; 
            margin-bottom: 6px;
            color: #4b5563;
        }
        .card .price, .card .rent-estimate, .card .asking-price {
            font-size: 1.05rem;
            font-weight: 700;
        }
        .card .price { color: #16a34a; }
        .card .rent-estimate { color: #c026d3; } 
        .card .asking-price { color: #d97706; } 


        .button {
            color: white;
            padding: 10px 16px; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s ease;
            border: none;
            font-size: 0.9rem;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .button:active {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .button-main-action { 
             padding: 12px 24px;
             font-size: 1.1rem;
             background-color: #4f46e5; 
        }
        .button-main-action:hover { background-color: #4338ca; }
        
        .button-external-loan { /* New button style */
            background-color: #0891b2; /* Cyan */
        }
        .button-external-loan:hover { background-color: #0e7490; }


        .button-secondary { background-color: #64748b; } 
        .button-secondary:hover { background-color: #475569; }

        .button-buy { background-color: #16a34a; } 
        .button-buy:hover { background-color: #15803d; }

        .button-list-sell { 
            background-color: #db2777; 
        }
        .button-list-sell:hover { background-color: #be185d; }


        .button-rent { background-color: #f59e0b; } 
        .button-rent:hover { background-color: #d97706; }

        .button-renovate { background-color: #7c3aed; } 
        .button-renovate:hover { background-color: #6d28d9; }

        .button-disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            text-shadow: none;
            box-shadow: none;
        }
        .button-disabled:hover { transform: none; }

        .section-title {
            font-size: 1.75rem; 
            font-weight: 700;
            margin-bottom: 20px;
            color: #1e293b; 
            border-bottom: 3px solid #6366f1; 
            padding-bottom: 10px;
        }
        .player-stats {
            background-color: #fff; 
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .player-stats div {
            background-color: #e0e7ff; 
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            border-left: 4px solid #4f46e5; 
        }
        .player-stats strong {
            color: #3730a3; 
            font-weight: 700;
        }
        .game-log {
            background-color: #f8fafc; 
            border-radius: 12px;
            padding: 10px; 
        }
        .game-log li {
            padding: 8px 12px; 
            border-bottom: 1px solid #e2e8f0; 
            font-size: 0.875rem;
        }
        .game-log li:last-child { border-bottom: none; }

        .property-status { font-weight: 600; } 
        .status-rented { color: #16a34a; }
        .status-listed-rent { color: #f59e0b; } 
        .status-vacant { color: #6b7280; }
        .status-delinquent { color: #ef4444; font-weight: 700; } 
        .status-listed-sale { color: #db2777; font-weight: 700; } 


        .condition-good { color: #16a34a; }
        .condition-fair { color: #f59e0b; }
        .condition-poor { color: #ef4444; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(30, 41, 59, 0.6); backdrop-filter: blur(4px);  }
        .modal-content { background-color: #ffffff; margin: 8% auto; padding: 28px; border: 1px solid #cbd5e1; width: 90%; max-width: 550px; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); }
        .modal-content h2 { font-size: 1.35rem; font-weight: 700; margin-bottom: 20px; text-align: center; color: #4f46e5; }
        .modal-content p { font-size: 1rem; margin-bottom: 12px; }
        .modal-content .details p { margin-bottom: 6px; font-size: 0.9rem;}
        .modal-input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #94a3b8; border-radius: 6px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: space-around; margin-top: 24px; }
        .modal-button { padding: 12px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; border: none; font-size: 0.95rem; text-shadow: 0 1px 1px rgba(0,0,0,0.1);}
        .modal-button:hover { transform: translateY(-1px); }
        .modal-confirm-button { background-color: #4f46e5; color: white; }
        .modal-confirm-button:hover { background-color: #4338ca; }
        .modal-accept-offer-button { background-color: #16a34a; color: white; }
        .modal-accept-offer-button:hover { background-color: #15803d; }
        .modal-counter-offer-button { background-color: #f59e0b; color: white; }
        .modal-counter-offer-button:hover { background-color: #d97706; }
        .modal-cancel-button { background-color: #64748b; color: white; }
        .modal-cancel-button:hover { background-color: #475569; }
        .loan-term-option { margin-bottom: 12px; }
        .loan-term-option label { margin-left: 10px; font-size: 0.95rem; }
        #sellModalOfferDetails p { margin-bottom: 8px; }
        .quick-loan-buttons button { margin: 0 5px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="game-container">
        <header class="mb-10 text-center">
            <h1 class="text-5xl font-bold text-indigo-700">Property Tycoon</h1>
            <p class="text-xl text-slate-600 mt-2">Your Journey to Real Estate Riches!</p>
        </header>

        <section class="mb-10 player-stats">
            <h2 class="section-title">Your Financial Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                <div><strong>Age:</strong> <span id="player-age">18 years</span></div>
                <div><strong>Cash:</strong> $<span id="player-cash">20000</span></div>
                <div><strong>Salary (Monthly):</strong> $<span id="player-salary">2500</span></div>
                <div><strong>Net Worth:</strong> $<span id="player-net-worth">20000</span></div>
            </div>
        </section>

        <section class="mb-10 text-center space-x-4">
            <button id="next-month-btn" class="button button-main-action">Advance to Next Month</button>
            <button id="external-loan-btn" class="button button-external-loan">External Loans</button>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <section class="lg:col-span-2">
                <h2 class="section-title">Property Market Listings</h2>
                <div id="property-listings" class="space-y-5 max-h-[650px] overflow-y-auto p-3 bg-slate-100 rounded-lg">
                    <p class="text-slate-500 text-center py-12">No properties listed this month. Click "Next Month".</p>
                </div>
            </section>
            <section>
                <h2 class="section-title">Your Portfolio</h2>
                <div id="owned-properties" class="space-y-5 max-h-[650px] overflow-y-auto p-3 bg-slate-100 rounded-lg">
                    <p class="text-slate-500 text-center py-12" id="no-owned-properties-msg">You don't own any properties yet.</p>
                </div>
            </section>
        </div>

        <section class="mt-10">
            <h2 class="section-title">Activity Log</h2>
            <ul id="game-log" class="list-none p-3 bg-slate-100 rounded-lg max-h-56 overflow-y-auto">
                <li class="text-slate-500">Game started. Good luck!</li>
            </ul>
        </section>
    </div>

    <div id="messageModal" class="modal"><div class="modal-content"><h2 id="modalTitle">Notification</h2><p id="modalMessage">Msg</p><div class="modal-buttons"><button id="modalCloseBtn" class="modal-button modal-confirm-button">OK</button></div></div></div>
    <div id="renovationModal" class="modal"><div class="modal-content"><h2 id="renovationModalTitle">Renovate</h2><p id="renovationModalText">Info</p><input type="number" id="renovationAmountInput" class="modal-input" placeholder="e.g., 5000"><p id="renovationModalEstImprovement"></p><div class="modal-buttons"><button id="confirmRenovationBtn" class="modal-button modal-confirm-button">Renovate</button><button id="cancelRenovationBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="loanTermModal" class="modal"><div class="modal-content"><h2 id="loanTermModalTitle">Select Loan</h2><div id="loanPropertyDetails" class="details mb-4"></div><p>Choose duration:</p><div id="loanTermOptionsContainer" class="my-4"></div><p><strong>Monthly Payment:</strong> $<span id="loanTermSelectedPayment">0</span></p><div class="modal-buttons"><button id="confirmLoanBtn" class="modal-button modal-confirm-button">Confirm</button><button id="cancelLoanBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="listSaleModal" class="modal"><div class="modal-content"><h2 id="listSaleModalTitle">List Property</h2><div id="listSalePropertyInfo" class="details mb-3"></div><p><strong>Market Value:</strong> $<span id="listSaleMarketValue">0</span></p><div><label for="askingPriceInput" class="block mb-1 font-medium">Asking Price:</label><input type="number" id="askingPriceInput" class="modal-input" placeholder="Desired price"></div><div class="modal-buttons"><button id="confirmListSaleBtn" class="modal-button modal-confirm-button">List</button><button id="cancelListSaleBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="offerModal" class="modal"><div class="modal-content"><h2 id="offerModalTitle">Offer Received!</h2><div id="offerPropertyInfo" class="details mb-3"></div><div id="offerModalDetails" class="mb-3"><p><strong>Asking:</strong> $<span id="offerAskingPrice">0</span></p><p><strong>Buyer's Offer:</strong> $<span id="offerBuyerOfferValue">0</span></p></div><div id="offerModalCounterOfferSection" class="mb-3"><label for="offerCounterInput" class="block mb-1 font-medium">Your Counter:</label><input type="number" id="offerCounterInput" class="modal-input" placeholder="Counter price"></div><div class="modal-buttons"><button id="acceptOfferBtn" class="modal-button modal-accept-offer-button">Accept</button><button id="submitOfferCounterBtn" class="modal-button modal-counter-offer-button">Counter</button><button id="rejectOfferBtn" class="modal-button modal-cancel-button">Reject</button></div></div></div>

    <div id="externalLoanModal" class="modal">
        <div class="modal-content">
            <h2 id="externalLoanModalTitle">Take External Loan</h2>
            <p>Borrow funds at undisclosed high interest rates. Repay over 36 months. This is risky!</p>
            <div>
                <label for="externalLoanAmountInput" class="block mb-1 font-medium">Loan Amount:</label>
                <input type="number" id="externalLoanAmountInput" class="modal-input" placeholder="Enter amount">
            </div>
            <div class="quick-loan-buttons text-center mb-4">
                <button class="button button-secondary" onclick="setExternalLoanAmount(10000)">$10,000</button>
                <button class="button button-secondary" onclick="setExternalLoanAmount(50000)">$50,000</button>
                <button class="button button-secondary" onclick="setExternalLoanAmount(100000)">$100,000</button>
            </div>
            <p>Estimated Monthly Payment: $<span id="externalLoanEstPayment">0</span> (approx.)</p>
            <div class="modal-buttons">
                <button id="confirmExternalLoanBtn" class="modal-button modal-confirm-button">Take Loan</button>
                <button id="cancelExternalLoanBtn" class="modal-button modal-cancel-button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- Game Configuration ---
        const INITIAL_CASH = 20000;
        const INITIAL_SALARY = 2500;
        const SALARY_INCREASE_INTERVAL_MONTHS = 12;
        const SALARY_INCREASE_PERCENTAGE = 0.07;
        const PROPERTY_DOWN_PAYMENT_PERCENTAGE = 0.20;
        const AVAILABLE_LOAN_TERMS = [ { years: 10, months: 120 }, { years: 15, months: 180 }, { years: 20, months: 240 }, { years: 30, months: 360 }];
        const PROPERTY_FEES_PERCENTAGE_ANNUAL = 0.01;
        const MAX_LOG_ENTRIES = 35; // Increased log slightly
        const PROPERTIES_PER_MONTH_MIN = 1;
        const PROPERTIES_PER_MONTH_MAX = 3;
        const GOLDEN_OPPORTUNITY_CHANCE = 0.015; // 1.5% chance for a golden deal

        const CONDITION_DECAY_VACANT_PER_MONTH = 0.1;
        const CONDITION_DECAY_RENTED_PER_MONTH = 0.3; 
        const MIN_TENANT_STAY_MONTHS = 6;
        const CHANCE_TENANT_LEAVES_AFTER_MIN = 0.1;
        const CLEANING_FEE_MIN = 100;
        const CLEANING_FEE_MAX = 500;
        const RENOVATION_COST_PER_CONDITION_POINT = 100;
        const RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL = 0.03;
        const RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL = 0.08;
        const BASE_TENANT_FIND_CHANCE = 0.3;
        const RANDOM_DAMAGE_EVENT_CHANCE = 0.03;
        const RANDOM_DAMAGE_MIN_PERCENT = 3;
        const RANDOM_DAMAGE_MAX_PERCENT = 10;

        // Market & Selling Config
        const ANNUAL_APPRECIATION_MIN = 0.02;
        const ANNUAL_APPRECIATION_MAX = 0.10;
        const ANNUAL_APPRECIATION_TYPICAL_BIAS_STRENGTH = 3; 
        const ANNUAL_APPRECIATION_TYPICAL = 0.05; 
        const BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET = 0.05; 
        const BUYER_OFFER_CONDITION_PENALTY_MAX = 0.10; 
        const COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL = 1.02; 
        const COUNTER_OFFER_REJECT_THRESHOLD_BAD_DEAL = 1.15; 
        const BASE_CHANCE_OF_RECEIVING_OFFER = 0.15; 
        const ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE = 0.1; 
        const CONDITION_SENSITIVITY_FOR_OFFER_CHANCE = 0.002; 

        // Bad Tenant Config
        const BAD_TENANT_CONDITION_THRESHOLD = 35; 
        const CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION = 0.20; 
        const DELINQUENT_NON_PAYMENT_BASE_CHANCE = 0.25; 
        const DELINQUENT_NON_PAYMENT_ESCALATION_PER_MONTH = 0.15; 
        const DELINQUENT_MAX_NON_PAYMENT_CHANCE = 0.90; 
        const CONDITION_THRESHOLD_TO_CURE_DELINQUENCY = 50; 
        const CHANCE_CURE_DELINQUENCY_IF_RENOVATED = 0.75; 

        // External Loan Config
        const EXTERNAL_LOAN_MIN_MONTHLY_INTEREST = 0.01; // 1% per month
        const EXTERNAL_LOAN_MAX_MONTHLY_INTEREST = 0.15; // 15% per month
        const EXTERNAL_LOAN_TERM_MONTHS = 36; // 3 years


        const PROPERTY_TYPES = [ 
            { name: "Studio Apartment", basePrice: 80000, priceRange: 70000, baseRentability: 0.7 },
            { name: "2-Bedroom Condo", basePrice: 150000, priceRange: 150000, baseRentability: 0.8 },
            { name: "Townhouse", basePrice: 250000, priceRange: 250000, baseRentability: 0.75 },
            { name: "Detached House", basePrice: 400000, priceRange: 400000, baseRentability: 0.85 },
            { name: "Luxury Penthouse", basePrice: 750000, priceRange: 1250000, baseRentability: 0.6 }
        ];

        // --- Game State ---
        let player = { 
            ageMonths: 18 * 12, 
            cash: INITIAL_CASH, 
            salary: INITIAL_SALARY, 
            netWorth: INITIAL_CASH, 
            properties: [],
            externalLoans: [] // To store external loans
        };
        let availableProperties = [];
        let gameLog = ["Game started. Good luck!"];
        let currentMonth = 0;
        let propertyToManageIndex = -1; 
        let currentOfferForProperty = null; 
        let selectedLoanTermMonths = AVAILABLE_LOAN_TERMS.find(t => t.years === 20).months;

        // --- UI Elements ---
        const ageEl = document.getElementById('player-age');
        const cashEl = document.getElementById('player-cash');
        const salaryEl = document.getElementById('player-salary');
        const netWorthEl = document.getElementById('player-net-worth');
        const propertyListingsEl = document.getElementById('property-listings');
        const ownedPropertiesEl = document.getElementById('owned-properties');
        const noOwnedPropertiesMsgEl = document.getElementById('no-owned-properties-msg');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const externalLoanBtn = document.getElementById('external-loan-btn'); // New button
        const gameLogEl = document.getElementById('game-log');
        // Message Modal
        const messageModal = document.getElementById('messageModal');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalMessageEl = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        // Renovation Modal
        const renovationModal = document.getElementById('renovationModal');
        const renovationModalTitleEl = document.getElementById('renovationModalTitle');
        const renovationModalTextEl = document.getElementById('renovationModalText');
        const renovationAmountInput = document.getElementById('renovationAmountInput');
        const renovationModalEstImprovementEl = document.getElementById('renovationModalEstImprovement');
        const confirmRenovationBtn = document.getElementById('confirmRenovationBtn');
        const cancelRenovationBtn = document.getElementById('cancelRenovationBtn');
        // Loan Term Modal
        const loanTermModal = document.getElementById('loanTermModal');
        const loanTermModalTitleEl = document.getElementById('loanTermModalTitle');
        const loanPropertyDetailsEl = document.getElementById('loanPropertyDetails');
        const loanTermOptionsContainerEl = document.getElementById('loanTermOptionsContainer');
        const loanTermSelectedPaymentEl = document.getElementById('loanTermSelectedPayment');
        const confirmLoanBtn = document.getElementById('confirmLoanBtn');
        const cancelLoanBtn = document.getElementById('cancelLoanBtn');
        // List for Sale Modal
        const listSaleModal = document.getElementById('listSaleModal');
        const listSaleModalTitleEl = document.getElementById('listSaleModalTitle');
        const listSalePropertyInfoEl = document.getElementById('listSalePropertyInfo');
        const listSaleMarketValueEl = document.getElementById('listSaleMarketValue');
        const askingPriceInputEl = document.getElementById('askingPriceInput');
        const confirmListSaleBtn = document.getElementById('confirmListSaleBtn');
        const cancelListSaleBtn = document.getElementById('cancelListSaleBtn');
        // Offer Received Modal
        const offerModal = document.getElementById('offerModal');
        const offerModalTitleEl = document.getElementById('offerModalTitle');
        const offerPropertyInfoEl = document.getElementById('offerPropertyInfo');
        const offerAskingPriceEl = document.getElementById('offerAskingPrice');
        const offerBuyerOfferValueEl = document.getElementById('offerBuyerOfferValue');
        const offerCounterInputEl = document.getElementById('offerCounterInput');
        const acceptOfferBtn = document.getElementById('acceptOfferBtn');
        const submitOfferCounterBtn = document.getElementById('submitOfferCounterBtn');
        const rejectOfferBtn = document.getElementById('rejectOfferBtn');
        // External Loan Modal
        const externalLoanModal = document.getElementById('externalLoanModal');
        const externalLoanModalTitleEl = document.getElementById('externalLoanModalTitle');
        const externalLoanAmountInputEl = document.getElementById('externalLoanAmountInput');
        const externalLoanEstPaymentEl = document.getElementById('externalLoanEstPayment');
        const confirmExternalLoanBtn = document.getElementById('confirmExternalLoanBtn');
        const cancelExternalLoanBtn = document.getElementById('cancelExternalLoanBtn');


        // --- Utility Functions ---
        function formatCurrency(amount) { return Math.round(amount).toLocaleString(); }
        function showModal(title, message) { modalTitleEl.textContent = title; modalMessageEl.textContent = message; messageModal.style.display = "block"; }
        modalCloseBtn.onclick = function() { messageModal.style.display = "none"; }
        window.onclick = function(event) {
            if (event.target == messageModal) messageModal.style.display = "none";
            if (event.target == renovationModal) renovationModal.style.display = "none";
            if (event.target == loanTermModal) loanTermModal.style.display = "none";
            if (event.target == listSaleModal) listSaleModal.style.display = "none";
            if (event.target == offerModal) offerModal.style.display = "none";
            if (event.target == externalLoanModal) externalLoanModal.style.display = "none";
        }
        function addLogEntry(message) { gameLog.unshift(message); if (gameLog.length > MAX_LOG_ENTRIES) gameLog.pop(); renderGameLog(); }
        function getConditionClass(condition) { if (condition >= 70) return 'condition-good'; if (condition >= 40) return 'condition-fair'; return 'condition-poor'; }

        // --- Rendering Functions ---
        function renderPlayerStats() { 
            ageEl.textContent = `${Math.floor(player.ageMonths / 12)} years, ${player.ageMonths % 12} months`;
            cashEl.textContent = formatCurrency(player.cash);
            salaryEl.textContent = formatCurrency(player.salary);
            netWorthEl.textContent = formatCurrency(calculateNetWorth());
        }

        function renderPropertyListings() { 
            propertyListingsEl.innerHTML = '';
            if (availableProperties.length === 0) {
                propertyListingsEl.innerHTML = '<p class="text-slate-500 text-center py-12">No new properties listed this month.</p>';
                return;
            }
            availableProperties.forEach((prop, index) => {
                const downPayment = prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
                const card = document.createElement('div');
                card.className = `card ${prop.isGolden ? 'golden-opportunity' : ''}`; // Add golden class if applicable
                card.innerHTML = `
                    <h3>${prop.name} (ID: ${prop.id})</h3>
                    <p class="price">Price: $${formatCurrency(prop.price)}</p>
                    <p class="rent-estimate">Est. Monthly Rent: $${formatCurrency(prop.estimatedRent)}</p>
                    <p>Initial Condition: <span class="${getConditionClass(prop.initialCondition)} font-semibold">${prop.initialCondition.toFixed(1)}%</span></p>
                    <p>Down Payment (20%): $${formatCurrency(downPayment)}</p>
                    <button class="button button-buy mt-3 w-full ${player.cash < downPayment ? 'button-disabled' : ''}" 
                            onclick="openLoanTermModal(${index})" 
                            ${player.cash < downPayment ? 'disabled' : ''}>
                        ${player.cash < downPayment ? 'Not Enough Cash' : 'Consider Purchase'}
                    </button>
                `;
                propertyListingsEl.appendChild(card);
            });
        }

        function renderOwnedProperties() { 
            ownedPropertiesEl.innerHTML = '';
            if (player.properties.length === 0) { noOwnedPropertiesMsgEl.style.display = 'block'; return; }
            noOwnedPropertiesMsgEl.style.display = 'none';

            player.properties.forEach((prop, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                let statusHTML = '', rentalActionButtonHTML = '', saleActionButtonHTML = '';

                if (prop.isListedForSale) {
                    statusHTML = `<span class="property-status status-listed-sale">LISTED FOR SALE</span><br>Asking: <span class="asking-price">$${formatCurrency(prop.askingPrice)}</span><br>On Market: ${prop.timeOnMarket} months`;
                    saleActionButtonHTML = `
                        <button class="button button-secondary w-full" onclick="openListSaleModal(${index}, true)">Adjust Price</button>
                        <button class="button button-secondary w-full" onclick="deListProperty(${index})">De-list Property</button>
                    `;
                     rentalActionButtonHTML = `<button class="button button-rent mt-2 w-full" disabled title="Property is listed for sale">List for Rent (Blocked)</button>`;

                } else if (prop.isDelinquent) {
                    statusHTML = `<span class="property-status status-delinquent">TENANT DELINQUENT (${prop.delinquentMonths} months unpaid)</span>`;
                    rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" disabled title="Tenant is delinquent. Renovate.">Manage Rental (Blocked)</button>`;
                    saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                } else if (prop.isRented) {
                    statusHTML = `<span class="property-status status-rented">Rented: $${formatCurrency(prop.currentRent)}/month</span> (Tenant for ${prop.tenantMonths} months)`;
                    rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" disabled title="Property is currently rented">Manage Rental (Soon)</button>`;
                    saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                } else if (prop.isListedForRent) { 
                    statusHTML = `<span class="property-status status-listed-rent">Listed for Rent</span>`; 
                    rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" onclick="toggleListingStatus(${index})">Cancel Rent Listing</button>`;
                    saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                } else { 
                    statusHTML = `<span class="property-status status-vacant">Vacant</span>`;
                    rentalActionButtonHTML = `<button class="button button-rent mt-2 w-full" onclick="toggleListingStatus(${index})">List for Rent</button>`;
                    saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                }

                card.innerHTML = `
                    <h3>${prop.name} (ID: ${prop.id})</h3>
                    <p>Market Value: $${formatCurrency(prop.currentMarketValue)} (Bought for $${formatCurrency(prop.purchasePrice)})</p>
                    <p>Loan: $${formatCurrency(prop.remainingLoan)} (${prop.monthsPaid}/${prop.loanTermMonths} paid)</p>
                    <p>Monthly Installment: $${formatCurrency(prop.monthlyInstallment)}</p>
                    <p>Monthly Fees: $${formatCurrency(prop.monthlyFees)}</p>
                    <p>Condition: <span class="${getConditionClass(prop.condition)} font-semibold">${prop.condition.toFixed(1)}%</span></p>
                    <p>${statusHTML}</p>
                    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        ${rentalActionButtonHTML}
                        <button class="button button-renovate w-full" onclick="openRenovationModal(${index})">Renovate</button>
                        ${saleActionButtonHTML}
                    </div>
                    ${prop.remainingLoan <= 0 ? '<p class="font-bold text-green-600 mt-2">Fully Paid Off!</p>' : ''}
                `;
                ownedPropertiesEl.appendChild(card);
            });
        }

        function renderGameLog() { 
            gameLogEl.innerHTML = '';
            gameLog.forEach(entry => {
                const li = document.createElement('li');
                li.textContent = entry;
                if (entry.toLowerCase().includes("bought") || entry.toLowerCase().includes("salary increase") || entry.toLowerCase().includes("rented out") || entry.toLowerCase().includes("rental income") || entry.toLowerCase().includes("sold") || entry.toLowerCase().includes("resumed payment") || entry.toLowerCase().includes("offer accepted") || entry.toLowerCase().includes("golden opportunity")) {
                    li.classList.add("text-green-700", "font-semibold");
                } else if (entry.toLowerCase().includes("paid") || entry.toLowerCase().includes("expenses") || entry.toLowerCase().includes("fee") || entry.toLowerCase().includes("renovation") || entry.toLowerCase().includes("external loan payment")) {
                    li.classList.add("text-red-700");
                } else if (entry.toLowerCase().includes("tenant left") || entry.toLowerCase().includes("damage") || entry.toLowerCase().includes("deal fell through") || entry.toLowerCase().includes("offer rejected") || entry.toLowerCase().includes("delinquent") || entry.toLowerCase().includes("stopped paying") || entry.toLowerCase().includes("no offers") || entry.toLowerCase().includes("took external loan")) {
                    li.classList.add("text-amber-700", "font-semibold");
                }
                gameLogEl.appendChild(li);
            });
        }

        // --- Game Logic Functions ---
        function generateNewProperties() { 
            availableProperties = [];
            const numPropsToGenerate = Math.floor(Math.random() * (PROPERTIES_PER_MONTH_MAX - PROPERTIES_PER_MONTH_MIN + 1)) + PROPERTIES_PER_MONTH_MIN;
            
            for (let i = 0; i < numPropsToGenerate; i++) {
                const typeIndex = Math.floor(Math.random() * PROPERTY_TYPES.length);
                const type = PROPERTY_TYPES[typeIndex];
                let price, initialCondition, estimatedRent;
                let isGolden = false;

                if (Math.random() < GOLDEN_OPPORTUNITY_CHANCE && i === 0) { // Only one golden deal per month max, for simplicity
                    isGolden = true;
                    // Golden deal: Lower price, high condition
                    price = Math.round(type.basePrice * (0.65 + Math.random() * 0.15)); // 65-80% of base price
                    initialCondition = 85 + Math.random() * 15; // 85-100% condition
                    addLogEntry(`⭐ A Golden Opportunity appeared: ${type.name}!`);
                } else {
                    price = type.basePrice + Math.floor(Math.random() * type.priceRange);
                    let conditionFactor = type.priceRange > 0 ? (price - type.basePrice) / type.priceRange : 1;
                    conditionFactor = Math.max(0, Math.min(1, conditionFactor));
                    let baseRandomCondition = 60 + Math.random() * 40; 
                    initialCondition = baseRandomCondition - (1 - conditionFactor) * 40;
                    initialCondition = Math.max(20, Math.min(100, initialCondition)); 
                }
                
                const annualRentMin = price * RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL;
                const annualRentMax = price * RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL;
                estimatedRent = (annualRentMin + Math.random() * (annualRentMax - annualRentMin)) / 12;
                // For golden deals, ensure rent is on the higher side of the range for its (low) price
                let rentConditionFactor = isGolden ? (0.75 + Math.random() * 0.25) : (0.5 + initialCondition / 200);
                estimatedRent *= rentConditionFactor; 
                estimatedRent = Math.max(50, Math.round(estimatedRent));

                availableProperties.push({
                    id: `P${Date.now().toString().slice(-4)}${i}`, name: type.name, price: price,
                    baseRentability: type.baseRentability, initialCondition: initialCondition,
                    estimatedRent: estimatedRent, isGolden: isGolden
                });
            }
            addLogEntry(`Market update: ${availableProperties.length} new properties listed.`);
        }

        function calculateNetWorth() { 
            let propertyMarketValues = player.properties.reduce((sum, prop) => sum + prop.currentMarketValue, 0);
            let totalPropertyLoan = player.properties.reduce((sum, prop) => sum + prop.remainingLoan, 0);
            let totalExternalLoan = player.externalLoans.reduce((sum, loan) => sum + loan.remainingBalance, 0);
            player.netWorth = player.cash + propertyMarketValues - totalPropertyLoan - totalExternalLoan;
            return player.netWorth;
        }

        function advanceMonth() {
            currentMonth++;
            player.ageMonths++;
            player.cash += player.salary;
            addLogEntry(`Payday! Received $${formatCurrency(player.salary)} salary.`);

            // External Loan Payments
            let totalExternalLoanPayments = 0;
            for (let i = player.externalLoans.length - 1; i >= 0; i--) {
                const loan = player.externalLoans[i];
                const payment = loan.monthlyPayment;
                player.cash -= payment;
                loan.remainingBalance -= (payment - (loan.remainingBalance * loan.monthlyInterestRate)); // Simplified principal reduction for now
                loan.remainingBalance = Math.max(0, loan.remainingBalance); // Don't go negative
                loan.monthsPaid++;
                totalExternalLoanPayments += payment;

                if (loan.remainingBalance <= 0 || loan.monthsPaid >= loan.termMonths) {
                    addLogEntry(`External Loan (ID: ${loan.id}) of $${formatCurrency(loan.principal)} has been fully paid off!`);
                    showModal("External Loan Paid Off!", `Your external loan (ID: ${loan.id}) is now fully paid.`);
                    player.externalLoans.splice(i, 1);
                }
            }
            if (totalExternalLoanPayments > 0) {
                addLogEntry(`Paid $${formatCurrency(totalExternalLoanPayments)} for external loan installments.`);
            }


            if (currentMonth > 0 && currentMonth % 12 === 0) {
                addLogEntry("Annual market review...");
                player.properties.forEach(prop => {
                    const appreciationRates = [ANNUAL_APPRECIATION_MIN, ANNUAL_APPRECIATION_MAX];
                    for(let k=0; k<ANNUAL_APPRECIATION_TYPICAL_BIAS_STRENGTH; k++) appreciationRates.push(ANNUAL_APPRECIATION_TYPICAL);
                    const randomAppreciationRate = appreciationRates[Math.floor(Math.random() * appreciationRates.length)];
                    prop.currentMarketValue = Math.round(prop.currentMarketValue * (1 + randomAppreciationRate));
                    addLogEntry(`${prop.name} market value appreciated by ${(randomAppreciationRate * 100).toFixed(1)}% to $${formatCurrency(prop.currentMarketValue)}.`);
                });
                 showModal("Market Update", "Property values updated based on annual market appreciation.");
            }

            let totalPropertyExpenses = 0, totalRentalIncome = 0;
            player.properties.forEach((prop, index) => { 
                if (prop.remainingLoan > 0) {
                    const paymentThisMonth = Math.min(prop.monthlyInstallment, prop.remainingLoan);
                    player.cash -= paymentThisMonth; prop.remainingLoan -= paymentThisMonth; prop.monthsPaid++;
                    totalPropertyExpenses += paymentThisMonth;
                    if (prop.remainingLoan <= 0) { addLogEntry(`${prop.name} is fully paid off!`); showModal("Property Paid Off!", `${prop.name} is now fully yours!`); }
                }
                player.cash -= prop.monthlyFees; totalPropertyExpenses += prop.monthlyFees;
                if (Math.random() < RANDOM_DAMAGE_EVENT_CHANCE) {
                    let incidentDamage = RANDOM_DAMAGE_MIN_PERCENT + Math.random() * (RANDOM_DAMAGE_MAX_PERCENT - RANDOM_DAMAGE_MIN_PERCENT);
                    prop.condition -= incidentDamage;
                    addLogEntry(`ALERT! ${prop.name} suffered damage, losing ${incidentDamage.toFixed(1)}% condition.`);
                    showModal("Property Incident!", `${prop.name} condition dropped by ${incidentDamage.toFixed(1)}%! Consider renovating.`);
                }
                prop.condition -= (prop.isRented ? CONDITION_DECAY_RENTED_PER_MONTH : CONDITION_DECAY_VACANT_PER_MONTH);
                prop.condition = Math.max(0, prop.condition);

                if (prop.isListedForSale) {
                    prop.timeOnMarket++;
                    let offerChance = BASE_CHANCE_OF_RECEIVING_OFFER;
                    const priceRatio = prop.askingPrice / prop.currentMarketValue;
                    if (priceRatio > 1) offerChance -= (priceRatio - 1) * ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE * 5; 
                    else offerChance += (1 - priceRatio) * ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE * 2; 
                    offerChance += (prop.condition / 100 - 0.5) * CONDITION_SENSITIVITY_FOR_OFFER_CHANCE * 100; 
                    offerChance = Math.max(0.01, Math.min(0.9, offerChance)); 

                    if (Math.random() < offerChance) {
                        let buyerOffer = prop.currentMarketValue * (1 - BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET);
                        const conditionPenaltyFactor = (100 - prop.condition) / 100;
                        buyerOffer *= (1 - (BUYER_OFFER_CONDITION_PENALTY_MAX * conditionPenaltyFactor));
                        if (prop.askingPrice < buyerOffer) buyerOffer = prop.askingPrice + Math.random() * (buyerOffer - prop.askingPrice);
                        currentOfferForProperty = Math.round(Math.max(0, buyerOffer));
                        addLogEntry(`OFFER RECEIVED for ${prop.name}! Buyer offers $${formatCurrency(currentOfferForProperty)} (Asking: $${formatCurrency(prop.askingPrice)}).`);
                        openOfferModal(index, currentOfferForProperty); 
                    }
                }
                if (!prop.isListedForSale) {
                    if (prop.isRented) {
                        let tenantPaidThisMonth = true;
                        if (prop.isDelinquent) {
                            let nonPaymentChance = DELINQUENT_NON_PAYMENT_BASE_CHANCE + (prop.delinquentMonths * DELINQUENT_NON_PAYMENT_ESCALATION_PER_MONTH);
                            nonPaymentChance = Math.min(nonPaymentChance, DELINQUENT_MAX_NON_PAYMENT_CHANCE);
                            if (Math.random() < nonPaymentChance) {
                                tenantPaidThisMonth = false; prop.delinquentMonths++;
                                addLogEntry(`BAD TENANT: ${prop.name} did not pay rent (Cond: ${prop.condition.toFixed(1)}%). ${prop.delinquentMonths} months unpaid.`);
                                showModal("Rent Not Paid!", `Tenant at ${prop.name} is delinquent and did not pay rent. Improve property condition!`);
                            } else { player.cash += prop.currentRent; totalRentalIncome += prop.currentRent; addLogEntry(`Delinquent tenant at ${prop.name} paid $${formatCurrency(prop.currentRent)}.`); }
                        } else if (prop.condition < BAD_TENANT_CONDITION_THRESHOLD && Math.random() < CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION) {
                            prop.isDelinquent = true; prop.delinquentMonths = 1; tenantPaidThisMonth = false;
                            addLogEntry(`WARNING: Tenant at ${prop.name} became delinquent (Cond: ${prop.condition.toFixed(1)}%) and stopped paying!`);
                            showModal("Tenant Delinquent!", `Tenant at ${prop.name} became delinquent due to poor condition and has not paid rent!`);
                        }

                        if (tenantPaidThisMonth && !prop.isDelinquent) { player.cash += prop.currentRent; totalRentalIncome += prop.currentRent; }
                        
                        if (prop.isDelinquent && prop.condition >= CONDITION_THRESHOLD_TO_CURE_DELINQUENCY) {
                            if (Math.random() < CHANCE_CURE_DELINQUENCY_IF_RENOVATED) {
                                prop.isDelinquent = false; prop.delinquentMonths = 0;
                                addLogEntry(`GOOD NEWS: Tenant at ${prop.name} resumed payments after renovation!`);
                                showModal("Tenant Recovered!", `Tenant at ${prop.name} is no longer delinquent and resumed payments.`);
                            }
                        }

                        prop.tenantMonths++; 
                        if (prop.tenantMonths >= MIN_TENANT_STAY_MONTHS && Math.random() < CHANCE_TENANT_LEAVES_AFTER_MIN) {
                            addLogEntry(`Tenant left ${prop.name}.`); showModal("Tenant Left", `Tenant at ${prop.name} moved out.`);
                            prop.isRented = false; prop.isListedForRent = true; prop.currentRent = 0; prop.tenantMonths = 0;
                            prop.isDelinquent = false; prop.delinquentMonths = 0; 
                            const cleaningFee = CLEANING_FEE_MIN + Math.random() * (CLEANING_FEE_MAX - CLEANING_FEE_MIN);
                            player.cash -= cleaningFee; totalPropertyExpenses += cleaningFee;
                            addLogEntry(`Paid $${formatCurrency(cleaningFee)} cleaning fee for ${prop.name}.`);
                            prop.condition -= Math.random() * 5; prop.condition = Math.max(0, prop.condition);
                            if (prop.condition < 30) addLogEntry(`${prop.name} poor condition (${prop.condition.toFixed(1)}%) after tenant. Renovate?`);
                        }
                    } else if (prop.isListedForRent) { 
                        const effectiveRentability = prop.baseRentability * (prop.condition / 100);
                        if (Math.random() < BASE_TENANT_FIND_CHANCE * effectiveRentability) {
                            prop.isRented = true; prop.isListedForRent = false;
                            prop.isDelinquent = false; prop.delinquentMonths = 0; 
                            const annualRentMin = prop.currentMarketValue * RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL;
                            const annualRentMax = prop.currentMarketValue * RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL;
                            let monthlyRent = (annualRentMin + Math.random() * (annualRentMax - annualRentMin)) / 12;
                            monthlyRent *= (0.5 + prop.condition / 200); monthlyRent = Math.max(50, Math.round(monthlyRent));
                            prop.currentRent = monthlyRent; prop.tenantMonths = 0;
                            addLogEntry(`${prop.name} rented for $${formatCurrency(prop.currentRent)}/month!`);
                            showModal("Tenant Found!", `Tenant for ${prop.name} at $${formatCurrency(prop.currentRent)}/month.`);
                        }
                    }
                } 
            }); 

            if (totalRentalIncome > 0) addLogEntry(`Total rental income: $${formatCurrency(totalRentalIncome)}.`);
            if (totalPropertyExpenses > 0) addLogEntry(`Total property expenses: $${formatCurrency(totalPropertyExpenses)}.`);

            if (currentMonth > 0 && currentMonth % SALARY_INCREASE_INTERVAL_MONTHS === 0) {
                player.salary = Math.round(player.salary * (1 + SALARY_INCREASE_PERCENTAGE));
                addLogEntry(`Salary increase! New: $${formatCurrency(player.salary)}.`);
                showModal("Salary Increase!", `New monthly salary: $${formatCurrency(player.salary)}.`);
            }
            generateNewProperties(); updateAllUI();

            if (player.cash < 0 && !nextMonthBtn.disabled) {
                showModal("Game Over!", `Bankrupt! Final net worth: $${formatCurrency(player.netWorth)}.`);
                addLogEntry("GAME OVER: Bankrupt!");
                nextMonthBtn.disabled = true; nextMonthBtn.classList.add('button-disabled'); nextMonthBtn.textContent = "Game Over - Refresh";
            }
            if (player.netWorth >= 1000000 && !nextMonthBtn.disabled && player.properties.some(p => p.name.toLowerCase().includes("luxury"))) {
                showModal("You Win!", `Property Tycoon! Net worth: $${formatCurrency(player.netWorth)}!`);
                addLogEntry("CONGRATULATIONS: You've won!");
                nextMonthBtn.disabled = true; nextMonthBtn.classList.add('button-disabled'); nextMonthBtn.textContent = "You Won! - Refresh";
            }
        }

        window.openLoanTermModal = function(index) { 
            propertyToManageIndex = index; 
            const prop = availableProperties[index];
            if (!prop) return;
            const downPayment = prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
            if (player.cash < downPayment) {
                showModal("Not Enough Cash", `Need $${formatCurrency(downPayment)}, have $${formatCurrency(player.cash)}.`);
                return;
            }
            loanTermModalTitleEl.textContent = `Finance Purchase: ${prop.name}`;
            loanPropertyDetailsEl.innerHTML = `<p><strong>Price:</strong> $${formatCurrency(prop.price)}</p><p><strong>Est. Rent:</strong> $${formatCurrency(prop.estimatedRent)}/month</p><p><strong>Down Payment (20%):</strong> $${formatCurrency(downPayment)}</p><p><strong>Loan Amount:</strong> $${formatCurrency(prop.price - downPayment)}</p><p><strong>Initial Condition:</strong> ${prop.initialCondition.toFixed(1)}%</p>`;
            loanTermOptionsContainerEl.innerHTML = '';
            AVAILABLE_LOAN_TERMS.forEach(term => {
                const loanAmount = prop.price - downPayment;
                const monthlyPayment = loanAmount / term.months;
                const optionDiv = document.createElement('div');
                optionDiv.className = 'loan-term-option';
                optionDiv.innerHTML = `<input type="radio" id="term-${term.months}" name="loanTerm" value="${term.months}" ${term.months === selectedLoanTermMonths ? 'checked' : ''}><label for="term-${term.months}">${term.years} Years (Monthly: $${formatCurrency(monthlyPayment)})</label>`;
                loanTermOptionsContainerEl.appendChild(optionDiv);
            });
            document.querySelectorAll('input[name="loanTerm"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedLoanTermMonths = parseInt(this.value);
                    const loanAmount = prop.price - (prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE);
                    loanTermSelectedPaymentEl.textContent = formatCurrency(loanAmount / selectedLoanTermMonths);
                });
            });
            const defaultRadio = document.querySelector('input[name="loanTerm"]:checked');
            if(defaultRadio) defaultRadio.dispatchEvent(new Event('change'));
            loanTermModal.style.display = 'block';
        }

        confirmLoanBtn.onclick = function() { 
            const propToBuy = availableProperties[propertyToManageIndex]; 
            if (!propToBuy) return;
            const downPayment = propToBuy.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
            const loanAmount = propToBuy.price - downPayment;
            const chosenTermMonths = parseInt(document.querySelector('input[name="loanTerm"]:checked').value);
            const monthlyInstallment = loanAmount / chosenTermMonths;
            const monthlyFees = (propToBuy.price * PROPERTY_FEES_PERCENTAGE_ANNUAL) / 12;

            player.cash -= downPayment;
            const newOwnedProperty = {
                id: propToBuy.id, name: propToBuy.name, purchasePrice: propToBuy.price,
                currentMarketValue: propToBuy.price, 
                baseRentability: propToBuy.baseRentability, downPaymentPaid: downPayment,
                loanAmount: loanAmount, remainingLoan: loanAmount,
                monthlyInstallment: monthlyInstallment, monthlyFees: monthlyFees,
                monthsPaid: 0, condition: propToBuy.initialCondition, 
                isRented: false, isListedForRent: false, currentRent: 0, tenantMonths: 0,
                isDelinquent: false, delinquentMonths: 0, 
                isListedForSale: false, askingPrice: 0, timeOnMarket: 0, 
                loanTermMonths: chosenTermMonths
            };
            player.properties.push(newOwnedProperty);
            addLogEntry(`Bought ${propToBuy.name} for $${formatCurrency(propToBuy.price)} (${chosenTermMonths/12}-yr loan).`);
            showModal("Purchase Successful!", `Bought ${propToBuy.name}! Cash: $${formatCurrency(player.cash)}.`);
            availableProperties.splice(propertyToManageIndex, 1);
            loanTermModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI();
        }
        cancelLoanBtn.onclick = function() { loanTermModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.toggleListingStatus = function(index) { 
            propertyToManageIndex = index;
            const prop = player.properties[propertyToManageIndex];
            if (!prop || prop.isRented || prop.isDelinquent || prop.isListedForSale) { 
                 if(prop.isDelinquent) showModal("Action Blocked", "Cannot change listing status while tenant is delinquent.");
                 if(prop.isListedForSale) showModal("Action Blocked", "Property is currently listed for sale. De-list it first to manage rentals.");
                return;
            }
            prop.isListedForRent = !prop.isListedForRent;
            addLogEntry(prop.isListedForRent ? `${prop.name} listed for rent.` : `Cancelled rent listing for ${prop.name}.`);
            updateAllUI();
        }
        window.openRenovationModal = function(index) { 
            propertyToManageIndex = index;
            const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            renovationModalTitleEl.textContent = `Renovate ${prop.name}`;
            renovationModalTextEl.textContent = `Cond: ${prop.condition.toFixed(1)}%. Max cost to 100%: $${formatCurrency((100 - prop.condition) * RENOVATION_COST_PER_CONDITION_POINT)}. Amount:`;
            renovationAmountInput.value = ''; renovationAmountInput.max = player.cash; renovationModalEstImprovementEl.textContent = '';
            renovationModal.style.display = 'block';
        }
        renovationAmountInput.addEventListener('input', function() { 
            const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            const amount = parseFloat(renovationAmountInput.value) || 0;
            const pointsToGain = Math.min(100 - prop.condition, amount / RENOVATION_COST_PER_CONDITION_POINT);
            renovationModalEstImprovementEl.textContent = `Improve by ${pointsToGain.toFixed(1)}% to ${(prop.condition + pointsToGain).toFixed(1)}%.`;
        });
        confirmRenovationBtn.onclick = function() { 
            const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            let amountSpent = Math.min(parseFloat(renovationAmountInput.value) || 0, player.cash);
            amountSpent = Math.min(amountSpent, (100 - prop.condition) * RENOVATION_COST_PER_CONDITION_POINT); 
            amountSpent = Math.max(0, amountSpent); 

            if (amountSpent <= 0 && (100 - prop.condition > 0)) { 
                 showModal("Invalid Amount", "Enter positive amount for renovation if repairs are needed."); return; 
            }
            if (amountSpent === 0 && (100 - prop.condition < 0.1)) { 
                showModal("Already Perfect", `${prop.name} is already at or near 100% condition.`);
                renovationModal.style.display = 'none'; propertyToManageIndex = -1;
                return;
            }

            player.cash -= amountSpent;
            const conditionImproved = amountSpent / RENOVATION_COST_PER_CONDITION_POINT;
            prop.condition = Math.min(100, prop.condition + conditionImproved);
            addLogEntry(`Spent $${formatCurrency(amountSpent)} renovating ${prop.name}. Cond: ${prop.condition.toFixed(1)}%.`);
            showModal("Renovation Complete", `${prop.name} cond: ${prop.condition.toFixed(1)}%.`);
            
            renovationModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI();
        }
        cancelRenovationBtn.onclick = function() { renovationModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.openListSaleModal = function(index, isAdjusting = false) {
            propertyToManageIndex = index;
            const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            if (prop.isDelinquent) {
                showModal("Cannot List", "Property has a delinquent tenant. Resolve this issue before listing for sale.");
                return;
            }
             if (prop.isRented) { 
                showModal("Cannot List", `${prop.name} is currently rented. Tenant must leave before listing for sale.`);
                return;
            }

            listSaleModalTitleEl.textContent = isAdjusting ? `Adjust Asking Price: ${prop.name}` : `List for Sale: ${prop.name}`;
            listSalePropertyInfoEl.innerHTML = `<p><strong>Original Purchase:</strong> $${formatCurrency(prop.purchasePrice)}</p><p><strong>Remaining Loan:</strong> $${formatCurrency(prop.remainingLoan)}</p><p><strong>Condition:</strong> ${prop.condition.toFixed(1)}%</p>`;
            listSaleMarketValueEl.textContent = formatCurrency(prop.currentMarketValue);
            askingPriceInputEl.value = prop.isListedForSale ? prop.askingPrice : Math.round(prop.currentMarketValue * 1.05); 
            askingPriceInputEl.placeholder = `e.g., ${formatCurrency(Math.round(prop.currentMarketValue * 1.05))}`;
            confirmListSaleBtn.textContent = isAdjusting ? "Update Asking Price" : "List Property";
            listSaleModal.style.display = 'block';
        }

        confirmListSaleBtn.onclick = function() {
            const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            const newAskingPrice = parseFloat(askingPriceInputEl.value);
            if (isNaN(newAskingPrice) || newAskingPrice <= 0) {
                showModal("Invalid Price", "Please enter a valid positive asking price."); return;
            }
            if (prop.isListedForSale) addLogEntry(`Asking price for ${prop.name} changed from $${formatCurrency(prop.askingPrice)} to $${formatCurrency(newAskingPrice)}.`);
            else { addLogEntry(`${prop.name} listed for sale with asking price $${formatCurrency(newAskingPrice)}.`); prop.timeOnMarket = 0; }
            prop.isListedForSale = true; prop.askingPrice = newAskingPrice; prop.isListedForRent = false; 
            listSaleModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI();
        }
        cancelListSaleBtn.onclick = function() { listSaleModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.deListProperty = function(index) {
            propertyToManageIndex = index;
            const prop = player.properties[propertyToManageIndex];
            if (!prop || !prop.isListedForSale) return;
            prop.isListedForSale = false; prop.askingPrice = 0; prop.timeOnMarket = 0;
            addLogEntry(`${prop.name} has been de-listed from the sale market.`);
            showModal("Property De-listed", `${prop.name} is no longer for sale.`);
            propertyToManageIndex = -1; updateAllUI();
        }
        
        window.openOfferModal = function(index, buyerOfferAmount) {
            propertyToManageIndex = index;
            currentOfferForProperty = buyerOfferAmount; 
            const prop = player.properties[propertyToManageIndex];
            if (!prop || !prop.isListedForSale) return;
            offerModalTitleEl.textContent = `Buyer's Offer for ${prop.name}!`;
            offerPropertyInfoEl.innerHTML = `<p><strong>Market Value:</strong> $${formatCurrency(prop.currentMarketValue)}</p><p><strong>Condition:</strong> ${prop.condition.toFixed(1)}%</p>`;
            offerAskingPriceEl.textContent = formatCurrency(prop.askingPrice);
            offerBuyerOfferValueEl.textContent = formatCurrency(currentOfferForProperty);
            offerCounterInputEl.value = '';
            offerCounterInputEl.placeholder = `e.g., ${formatCurrency(Math.round(currentOfferForProperty * 1.03))}`;
            offerModal.style.display = 'block';
        }

        acceptOfferBtn.onclick = function() {
            if (propertyToManageIndex === -1 || currentOfferForProperty === null) return;
            finalizeSale(propertyToManageIndex, currentOfferForProperty);
        }

        rejectOfferBtn.onclick = function() {
            if (propertyToManageIndex === -1) return;
            const prop = player.properties[propertyToManageIndex];
            addLogEntry(`You rejected offer of $${formatCurrency(currentOfferForProperty)} for ${prop.name}. Remains listed.`);
            showModal("Offer Rejected", `You rejected the buyer's offer. ${prop.name} remains on the market.`);
            offerModal.style.display = 'none'; propertyToManageIndex = -1; currentOfferForProperty = null; updateAllUI(); 
        }

        submitOfferCounterBtn.onclick = function() {
            if (propertyToManageIndex === -1 || currentOfferForProperty === null) return;
            const prop = player.properties[propertyToManageIndex];
            const playerCounter = parseFloat(offerCounterInputEl.value);
            if (isNaN(playerCounter) || playerCounter <= 0) {
                showModal("Invalid Counter", "Please enter a valid positive amount."); return;
            }
            if (playerCounter < currentOfferForProperty) {
                 showModal("Low Counter-Offer", `Buyer accepts your lower counter of $${formatCurrency(playerCounter)}!`);
                 finalizeSale(propertyToManageIndex, playerCounter); return;
            }
            addLogEntry(`Countered $${formatCurrency(playerCounter)} for ${prop.name} (Offer: $${formatCurrency(currentOfferForProperty)}).`);
            let chanceOfAcceptance = 0.5; 
            if (playerCounter <= currentOfferForProperty * COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL) chanceOfAcceptance = 0.85; 
            else if (playerCounter >= currentOfferForProperty * COUNTER_OFFER_REJECT_THRESHOLD_BAD_DEAL || playerCounter > prop.currentMarketValue * 1.1) chanceOfAcceptance = 0.1; 
            else {
                const range = COUNTER_OFFER_REJECT_THRESHOLD_BAD_DEAL - COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL;
                const positionInRange = ( (playerCounter / currentOfferForProperty) - COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL) / range;
                chanceOfAcceptance = 0.85 - (positionInRange * 0.75); 
                chanceOfAcceptance = Math.max(0.1, Math.min(0.85, chanceOfAcceptance)); 
            }
            if (prop.condition > 90) chanceOfAcceptance += 0.05;

            if (Math.random() < chanceOfAcceptance) {
                addLogEntry(`Buyer accepted counter of $${formatCurrency(playerCounter)} for ${prop.name}!`);
                finalizeSale(propertyToManageIndex, playerCounter);
            } else {
                addLogEntry(`Buyer rejected counter of $${formatCurrency(playerCounter)} for ${prop.name}. Remains listed.`);
                showModal("Counter Rejected", `The buyer rejected your counter. ${prop.name} remains on the market.`);
            }
            offerModal.style.display = 'none'; propertyToManageIndex = -1; currentOfferForProperty = null; updateAllUI(); 
        }

        function finalizeSale(propertyIndex, salePrice) { 
            const prop = player.properties[propertyIndex];
            const netCashFromSale = salePrice - prop.remainingLoan;
            player.cash += netCashFromSale;
            addLogEntry(`SOLD ${prop.name} for $${formatCurrency(salePrice)}. Net cash: $${formatCurrency(netCashFromSale)}.`);
            showModal("Property Sold!", `${prop.name} sold for $${formatCurrency(salePrice)}. Received $${formatCurrency(netCashFromSale)} after loan payoff.`);
            player.properties.splice(propertyIndex, 1); 
            propertyToManageIndex = -1; currentOfferForProperty = null;
            listSaleModal.style.display = 'none'; offerModal.style.display = 'none';
            updateAllUI();
        }

        // --- External Loan Functions ---
        externalLoanBtn.addEventListener('click', () => {
            externalLoanModalTitleEl.textContent = "Take External Loan";
            externalLoanAmountInputEl.value = '';
            externalLoanEstPaymentEl.textContent = '0';
            externalLoanModal.style.display = 'block';
        });

        window.setExternalLoanAmount = function(amount) {
            externalLoanAmountInputEl.value = amount;
            updateExternalLoanEstPayment(); // Update estimate when quick button used
        }
        
        externalLoanAmountInputEl.addEventListener('input', updateExternalLoanEstPayment);

        function updateExternalLoanEstPayment() {
            const principal = parseFloat(externalLoanAmountInputEl.value) || 0;
            if (principal <=0) {
                externalLoanEstPaymentEl.textContent = '0';
                return;
            }
            // Use an *average* expected interest for estimation, since actual is hidden
            const avgMonthlyInterest = (EXTERNAL_LOAN_MIN_MONTHLY_INTEREST + EXTERNAL_LOAN_MAX_MONTHLY_INTEREST) / 2;
            const n = EXTERNAL_LOAN_TERM_MONTHS;
            let monthlyPayment;
            if (avgMonthlyInterest === 0) { // Should not happen with current config but good for robustness
                monthlyPayment = principal / n;
            } else {
                monthlyPayment = principal * (avgMonthlyInterest * Math.pow(1 + avgMonthlyInterest, n)) / (Math.pow(1 + avgMonthlyInterest, n) - 1);
            }
            externalLoanEstPaymentEl.textContent = formatCurrency(monthlyPayment) + " (approx.)";
        }


        confirmExternalLoanBtn.onclick = function() {
            const principal = parseFloat(externalLoanAmountInputEl.value);
            if (isNaN(principal) || principal <= 0) {
                showModal("Invalid Amount", "Please enter a valid positive loan amount.");
                return;
            }
            if (principal > player.netWorth * 2 && principal > 50000) { // Arbitrary limit to prevent instant huge debt
                 showModal("Loan Too Large", "Lenders are hesitant to offer such a large loan relative to your current standing.");
                return;
            }


            const monthlyInterestRate = EXTERNAL_LOAN_MIN_MONTHLY_INTEREST + Math.random() * (EXTERNAL_LOAN_MAX_MONTHLY_INTEREST - EXTERNAL_LOAN_MIN_MONTHLY_INTEREST);
            const n = EXTERNAL_LOAN_TERM_MONTHS;
            let monthlyPayment;
            if (monthlyInterestRate === 0) { // Should not happen with current config
                 monthlyPayment = principal / n;
            } else {
                 monthlyPayment = principal * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, n)) / (Math.pow(1 + monthlyInterestRate, n) - 1);
            }
            monthlyPayment = Math.round(monthlyPayment);


            const newLoan = {
                id: `EXT${Date.now().toString().slice(-5)}`,
                principal: principal,
                remainingBalance: principal,
                monthlyInterestRate: monthlyInterestRate,
                monthlyPayment: monthlyPayment,
                termMonths: EXTERNAL_LOAN_TERM_MONTHS,
                monthsPaid: 0
            };

            player.externalLoans.push(newLoan);
            player.cash += principal;

            addLogEntry(`RISKY MOVE: Took an external loan of $${formatCurrency(principal)}. Monthly payment: $${formatCurrency(monthlyPayment)} for ${EXTERNAL_LOAN_TERM_MONTHS} months.`);
            showModal("External Loan Acquired", `You borrowed $${formatCurrency(principal)}. Good luck paying it back!`);
            
            externalLoanModal.style.display = 'none';
            updateAllUI();
        }
        cancelExternalLoanBtn.onclick = function() { externalLoanModal.style.display = 'none'; }


        function updateAllUI() { renderPlayerStats(); renderPropertyListings(); renderOwnedProperties(); renderGameLog(); }
        
        nextMonthBtn.addEventListener('click', advanceMonth);

        function initializeGame() {
            player = { 
                ageMonths: 18 * 12, cash: INITIAL_CASH, salary: INITIAL_SALARY, netWorth: INITIAL_CASH, 
                properties: [], externalLoans: [] 
            };
            availableProperties = []; gameLog = ["Game started. Good luck!"]; currentMonth = 0;
            selectedLoanTermMonths = AVAILABLE_LOAN_TERMS.find(t => t.years === 20).months;
            propertyToManageIndex = -1; currentOfferForProperty = null;
            nextMonthBtn.disabled = false; nextMonthBtn.classList.remove('button-disabled'); nextMonthBtn.textContent = "Advance to Next Month";
            generateNewProperties(); updateAllUI();
            addLogEntry(`Welcome to Property Tycoon! Start with $${formatCurrency(INITIAL_CASH)}. Manage risks & build your empire.`);
        }
        initializeGame();
    </script>
</body>
</html>
