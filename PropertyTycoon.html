<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; 
            color: #1f2937; 
            padding-bottom: 100px; 
        }
        .game-container {
            max-width: 1380px; 
            margin: 20px auto;
            padding: 20px;
            background-color: #f9fafb; 
            border-radius: 16px; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.15); 
        }
        #gameHeader {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            max-height: 200px; 
        }
        #gameHeader.header-hidden {
            max-height: 10px; 
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 5px; 
            background-color: #6366f1; 
            cursor: pointer;
        }
        #gameHeader.header-hidden h1, 
        #gameHeader.header-hidden p {
            display: none; 
        }
        #gameHeader.header-hidden:hover {
            max-height: 200px; 
            padding-top: 2rem; 
            padding-bottom: 2rem;
            margin-bottom: 2.5rem; 
            background-color: transparent; 
        }
         #gameHeader.header-hidden:hover h1, 
         #gameHeader.header-hidden:hover p {
            display: block; 
        }
        .card {
            background-color: #ffffff; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #e5e7eb; position: relative; 
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.12); }
        .card.golden-opportunity { border: 2px solid #fbbf24; box-shadow: 0 0 25px rgba(251, 191, 36, 0.6); }
        .card.golden-opportunity::before {
            content: '‚≠ê Golden Opportunity!'; position: absolute; top: -10px; left: 50%;
            transform: translateX(-50%); background-color: #fbbf24; color: #422006; 
            padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; z-index: 10;
        }
        .card h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 12px; color: #3730a3; }
        .card p { font-size: 0.9rem; margin-bottom: 6px; color: #4b5563; }
        .card .price, .card .rent-estimate, .card .asking-price, .card .job-salary { font-size: 1.05rem; font-weight: 700; }
        .card .price { color: #16a34a; }
        .card .rent-estimate { color: #c026d3; } 
        .card .asking-price { color: #d97706; } 
        .card .job-salary { color: #2563eb; } 
        .button {
            color: white; padding: 10px 16px; border-radius: 8px; font-weight: 600; 
            cursor: pointer; transition: background-color 0.2s, transform 0.1s ease;
            border: none; font-size: 0.9rem; text-shadow: 0 1px 1px rgba(0,0,0,0.2); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .button:active { transform: translateY(0px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button-main-action { padding: 12px 24px; font-size: 1.1rem; background-color: #4f46e5; }
        .button-main-action:hover { background-color: #4338ca; }
        .button-external-loan { background-color: #0891b2; }
        .button-external-loan:hover { background-color: #0e7490; }
        .button-new-life { background-color: #f43f5e; } 
        .button-new-life:hover { background-color: #e11d48; }
        .button-secondary { background-color: #64748b; } 
        .button-secondary:hover { background-color: #475569; }
        .button-buy { background-color: #16a34a; } 
        .button-buy:hover { background-color: #15803d; }
        .button-list-sell { background-color: #db2777; }
        .button-list-sell:hover { background-color: #be185d; }
        .button-rent { background-color: #f59e0b; } 
        .button-rent:hover { background-color: #d97706; }
        .button-renovate { background-color: #7c3aed; } 
        .button-renovate:hover { background-color: #6d28d9; }
        .button-apply-job { background-color: #581c87; } 
        .button-apply-job:hover { background-color: #4c1d95; }
        .button-disabled { background-color: #9ca3af; cursor: not-allowed; text-shadow: none; box-shadow: none; }
        .button-disabled:hover { transform: none; }
        .section-title {
            font-size: 1.75rem; font-weight: 700; margin-bottom: 20px; color: #1e293b; 
            border-bottom: 3px solid #6366f1; padding-bottom: 10px;
        }
        .player-stats { background-color: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 2rem; } 
        .player-stats div {
            background-color: #e0e7ff; padding: 10px; border-radius: 6px; margin-bottom: 6px; 
            font-size: 0.9rem; border-left: 3px solid #4f46e5;  
        }
        .player-stats strong { color: #3730a3; font-weight: 600; } 
        .game-log { background-color: #f8fafc; border-radius: 12px; padding: 10px; }
        .game-log li { padding: 8px 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.875rem; }
        .game-log li:last-child { border-bottom: none; }
        .property-status { font-weight: 600; } 
        .status-rented { color: #16a34a; }
        .status-listed-rent { color: #f59e0b; } 
        .status-vacant { color: #6b7280; }
        .status-delinquent { color: #ef4444; font-weight: 700; } 
        .status-listed-sale { color: #db2777; font-weight: 700; } 
        .condition-good { color: #16a34a; }
        .condition-fair { color: #f59e0b; }
        .condition-poor { color: #ef4444; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(30, 41, 59, 0.6); backdrop-filter: blur(4px);  }
        .modal-content { background-color: #ffffff; margin: 8% auto; padding: 28px; border: 1px solid #cbd5e1; width: 90%; max-width: 550px; border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); }
        .modal-content h2 { font-size: 1.35rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
        .modal-content p { font-size: 1rem; margin-bottom: 12px; }
        .modal-content .details p { margin-bottom: 6px; font-size: 0.9rem;}
        .modal-input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #94a3b8; border-radius: 6px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: space-around; margin-top: 24px; }
        .modal-button { padding: 12px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; border: none; font-size: 0.95rem; text-shadow: 0 1px 1px rgba(0,0,0,0.1);}
        .modal-button:hover { transform: translateY(-1px); }
        #messageModal .modal-content.modal-success { background-color: #f0fdf4; border-left: 6px solid #22c55e; }
        #messageModal .modal-content.modal-success h2 { color: #15803d; }
        #messageModal .modal-content.modal-success .modal-button { background-color: #22c55e; }
        #messageModal .modal-content.modal-success .modal-button:hover { background-color: #16a34a; }
        #messageModal .modal-content.modal-error { background-color: #fef2f2; border-left: 6px solid #ef4444; }
        #messageModal .modal-content.modal-error h2 { color: #b91c1c; }
        #messageModal .modal-content.modal-error .modal-button { background-color: #ef4444; }
        #messageModal .modal-content.modal-error .modal-button:hover { background-color: #dc2626; }
        #messageModal .modal-content.modal-warning { background-color: #fffbeb; border-left: 6px solid #f59e0b; }
        #messageModal .modal-content.modal-warning h2 { color: #b45309; }
        #messageModal .modal-content.modal-warning .modal-button { background-color: #f59e0b; }
        #messageModal .modal-content.modal-warning .modal-button:hover { background-color: #d97706; }
        #messageModal .modal-content.modal-info { background-color: #eff6ff; border-left: 6px solid #3b82f6; } 
        #messageModal .modal-content.modal-info h2 { color: #1d4ed8; }
        #messageModal .modal-content.modal-info .modal-button { background-color: #3b82f6; }
        #messageModal .modal-content.modal-info .modal-button:hover { background-color: #2563eb; }
        .modal-accept-offer-button { background-color: #16a34a; color: white; }
        .modal-accept-offer-button:hover { background-color: #15803d; }
        .modal-counter-offer-button { background-color: #f59e0b; color: white; }
        .modal-counter-offer-button:hover { background-color: #d97706; }
        .modal-cancel-button { background-color: #64748b; color: white; } 
        .modal-cancel-button:hover { background-color: #475569; }
        .loan-term-option { margin-bottom: 12px; }
        .loan-term-option label { margin-left: 10px; font-size: 0.95rem; }
        #sellModalOfferDetails p { margin-bottom: 8px; }
        .quick-loan-buttons button { margin: 0 5px; }
        .fixed-action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 0; 
            background-color: rgba(249, 250, 251, 0.9); backdrop-filter: blur(8px); 
            text-align: center; z-index: 1001; border-top: 1px solid #dde2e9;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
        }
        .fixed-action-bar button { margin-left: 8px; margin-right: 8px; } 
        #loanAdModal .modal-content {
            background: linear-gradient(135deg, #fef9c3 0%, #fde68a 100%); 
            border: 3px solid #facc15; color: #713f12; 
        }
        #loanAdModal .modal-content h2 { color: #a16207; font-size: 1.6rem; text-shadow: 1px 1px 2px rgba(255,255,255,0.6); }
        #loanAdModal .modal-content .modal-button.modal-confirm-button { background-color: #eab308; font-size: 1rem; }
        #loanAdModal .modal-content .modal-button.modal-confirm-button:hover { background-color: #ca8a04; }
        #loanAdModal .modal-content .modal-button.modal-cancel-button { background-color: #a16207; }
        #loanAdModal .modal-content .modal-button.modal-cancel-button:hover { background-color: #713f12; }
        .game-over-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); z-index: 2000; 
            color: white; text-align: center; justify-content: center;
            align-items: center; flex-direction: column; 
        }
        .game-over-overlay h2 { font-size: 3rem; font-weight: bold; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .game-over-overlay p { font-size: 1.25rem; margin-bottom: 30px; }
        .game-over-overlay .button-restart { padding: 15px 30px; font-size: 1.25rem; background-color: #16a34a; }
        .game-over-overlay .button-restart:hover { background-color: #15803d; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="game-container">
        <header id="gameHeader" class="mb-10 text-center"> 
            <h1 class="text-5xl font-bold text-indigo-700">Property Tycoon</h1>
            <p class="text-xl text-slate-600 mt-2">Your Journey to Real Estate Riches!</p>
        </header>

        <section class="player-stats"> 
            <h2 class="section-title">Your Financial Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4"> 
                <div><strong>Age:</strong> <span id="player-age">18 years</span></div>
                <div><strong>Cash:</strong> $<span id="player-cash">20000</span></div>
                <div><strong>Job:</strong> <span id="player-job-title">Unskilled Labor</span></div>
                <div><strong>Salary (Monthly):</strong> $<span id="player-salary">1200</span></div> 
                <div><strong>Net Worth:</strong> $<span id="player-net-worth">20000</span></div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 mt-8">
            <section class="lg:col-span-2">
                <h2 class="section-title">Property Market Listings</h2>
                <div id="property-listings" class="space-y-5 max-h-[600px] overflow-y-auto p-3 bg-slate-100 rounded-lg">
                    <p class="text-slate-500 text-center py-12">No properties listed this month. Click "Next Month".</p>
                </div>
            </section>
            
            <section class="lg:col-span-1 space-y-10"> 
                <section> 
                    <h2 class="section-title">Activity Log</h2>
                    <ul id="game-log" class="list-none p-3 bg-slate-100 rounded-lg max-h-56 overflow-y-auto">
                        <li class="text-slate-500">Game started. Good luck!</li>
                    </ul>
                </section>

                <section> 
                    <h2 class="section-title">Your Portfolio</h2>
                    <div id="owned-properties" class="grid grid-cols-1 gap-5 max-h-[600px] overflow-y-auto p-3 bg-slate-100 rounded-lg"> 
                        <p class="text-slate-500 text-center py-12 col-span-full" id="no-owned-properties-msg">You don't own any properties yet.</p> 
                    </div>
                </section>
            </section>
        </div>
        
        <section class="mt-10">
            <h2 class="section-title">Job Market</h2>
            <div id="job-market-listings" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5 max-h-[600px] overflow-y-auto p-3 bg-slate-100 rounded-lg">
                 <p class="text-slate-500 text-center py-12 col-span-full">No job openings this month. Check back later!</p>
            </div>
        </section>

        <!-- New Life Button Section -->
        <section class="mt-10 text-center">
             <button id="new-life-btn" class="button button-new-life">Start New Life</button>
        </section>

    </div>

    <div class="fixed-action-bar">
        <button id="next-month-btn" class="button button-main-action">Advance to Next Month</button>
        <button id="external-loan-btn" class="button button-external-loan">External Loans</button>
        <!-- "Start New Life" button moved from here -->
    </div>


    <div id="messageModal" class="modal"><div class="modal-content modal-info"><h2 id="modalTitle" class="text-blue-700">Notification</h2><p id="modalMessage">Msg</p><div class="modal-buttons"><button id="modalCloseBtn" class="modal-button bg-blue-600 hover:bg-blue-700">OK</button></div></div></div>
    <div id="renovationModal" class="modal"><div class="modal-content"><h2 id="renovationModalTitle">Renovate</h2><p id="renovationModalText">Info</p><input type="number" id="renovationAmountInput" class="modal-input" placeholder="e.g., 5000"><p id="renovationModalEstImprovement"></p><div class="modal-buttons"><button id="confirmRenovationBtn" class="modal-button modal-confirm-button">Renovate</button><button id="cancelRenovationBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="loanTermModal" class="modal"><div class="modal-content"><h2 id="loanTermModalTitle">Select Loan</h2><div id="loanPropertyDetails" class="details mb-4"></div><p>Choose duration:</p><div id="loanTermOptionsContainer" class="my-4"></div><p><strong>Monthly Payment:</strong> $<span id="loanTermSelectedPayment">0</span></p><div class="modal-buttons"><button id="confirmLoanBtn" class="modal-button modal-confirm-button">Confirm</button><button id="cancelLoanBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="listSaleModal" class="modal"><div class="modal-content"><h2 id="listSaleModalTitle">List Property</h2><div id="listSalePropertyInfo" class="details mb-3"></div><p><strong>Market Value:</strong> $<span id="listSaleMarketValue">0</span></p><div><label for="askingPriceInput" class="block mb-1 font-medium">Asking Price:</label><input type="number" id="askingPriceInput" class="modal-input" placeholder="Desired price"></div><div class="modal-buttons"><button id="confirmListSaleBtn" class="modal-button modal-confirm-button">List</button><button id="cancelListSaleBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="offerModal" class="modal"><div class="modal-content"><h2 id="offerModalTitle">Offer Received!</h2><div id="offerPropertyInfo" class="details mb-3"></div><div id="offerModalDetails" class="mb-3"><p><strong>Asking:</strong> $<span id="offerAskingPrice">0</span></p><p><strong>Buyer's Offer:</strong> $<span id="offerBuyerOfferValue">0</span></p></div><div id="offerModalCounterOfferSection" class="mb-3"><label for="offerCounterInput" class="block mb-1 font-medium">Your Counter:</label><input type="number" id="offerCounterInput" class="modal-input" placeholder="Counter price"></div><div class="modal-buttons"><button id="acceptOfferBtn" class="modal-button modal-accept-offer-button">Accept</button><button id="submitOfferCounterBtn" class="modal-button modal-counter-offer-button">Counter</button><button id="rejectOfferBtn" class="modal-button modal-cancel-button">Reject</button></div></div></div>
    <div id="externalLoanModal" class="modal"><div class="modal-content"><h2 id="externalLoanModalTitle">Take External Loan</h2><p>Borrow funds at undisclosed high interest rates. Repay over 36 months. This is risky!</p><div><label for="externalLoanAmountInput" class="block mb-1 font-medium">Loan Amount:</label><input type="number" id="externalLoanAmountInput" class="modal-input" placeholder="Enter amount"></div><div class="quick-loan-buttons text-center mb-4"><button class="button button-secondary" onclick="setExternalLoanAmount(10000)">$10,000</button><button class="button button-secondary" onclick="setExternalLoanAmount(50000)">$50,000</button><button class="button button-secondary" onclick="setExternalLoanAmount(100000)">$100,000</button></div><p>Estimated Monthly Payment: $<span id="externalLoanEstPayment">0</span> (approx.)</p><div class="modal-buttons"><button id="confirmExternalLoanBtn" class="modal-button modal-confirm-button">Take Loan</button><button id="cancelExternalLoanBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="loanAdModal" class="modal"><div class="modal-content"> <h2 id="loanAdModalTitle">üí∞ Feeling Lucky? Need Quick Cash? üí∞</h2><p id="loanAdModalMessage">A unique opportunity for an external loan has presented itself! Fast cash, fast terms. What could go wrong?</p><div class="modal-buttons"><button id="loanAdTakeLoanBtn" class="modal-button modal-confirm-button">Explore Loan Options!</button><button id="loanAdDismissBtn" class="modal-button modal-cancel-button">No, Thanks</button></div></div></div>
    <div id="jobApplicationConfirmModal" class="modal"><div class="modal-content"><h2 id="jobConfirmModalTitle">Confirm Job Application</h2><div id="jobConfirmDetails" class="details mb-4"></div><p>Are you sure you want to apply for this position?</p><div class="modal-buttons"><button id="confirmJobApplicationBtn" class="modal-button modal-confirm-button">Confirm Application</button><button id="cancelJobApplicationBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="resetConfirmModal" class="modal"><div class="modal-content"><h2 id="resetConfirmModalTitle">Start New Life?</h2><p>All current progress will be reset. Are you sure?</p><div class="modal-buttons"><button id="confirmResetBtn" class="modal-button modal-confirm-button">Yes, Reset</button><button id="cancelResetBtn" class="modal-button modal-cancel-button">No, Cancel</button></div></div></div>
    <div id="gameOverOverlay" class="game-over-overlay"><div> <h2 id="gameOverTitle">Game Over</h2><p id="gameOverMessage">Your journey has come to an end.</p><button id="restartGameBtn" class="button button-restart">Restart Game</button></div></div>

    <script>
        // CORE DATA DEFINITIONS AT THE TOP
        const PROPERTY_TYPES = [ 
            { name: "Studio Apartment", basePrice: 80000, priceRange: 70000, baseRentability: 0.7 },
            { name: "2-Bedroom Condo", basePrice: 150000, priceRange: 150000, baseRentability: 0.8 },
            { name: "Townhouse", basePrice: 250000, priceRange: 250000, baseRentability: 0.75 },
            { name: "Detached House", basePrice: 400000, priceRange: 400000, baseRentability: 0.85 },
            { name: "Luxury Penthouse", basePrice: 750000, priceRange: 1250000, baseRentability: 0.6 }
        ];
        const JOB_FIELDS = {
            UNSKILLED: "General Labor", IT: "Information Technology", HEALTHCARE: "Healthcare",
            BUSINESS: "Business & Finance", SERVICE: "Service Industry"
        };
        const JOBS = [
            { id: "unskilled0", title: "Unskilled Labor", field: JOB_FIELDS.UNSKILLED, level: 0, salary: 1200, annualIncrementPercent: 0.01, prerequisites: null, promotionChanceMonths: 24, promotionChance: 0.1, promotionTo: "it0" },
            { id: "it0", title: "IT Intern", field: JOB_FIELDS.IT, level: 0, salary: 2200, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.3, promotionTo: "it1" },
            { id: "it1", title: "Junior IT Support", field: JOB_FIELDS.IT, level: 1, salary: 3000, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 6 }, promotionChanceMonths: 18, promotionChance: 0.25, promotionTo: "it2" },
            { id: "it2", title: "IT Support Specialist", field: JOB_FIELDS.IT, level: 2, salary: 4200, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 18 }, promotionChanceMonths: 24, promotionChance: 0.2, promotionTo: "it3" },
            { id: "it3", title: "Senior IT Engineer", field: JOB_FIELDS.IT, level: 3, salary: 6500, annualIncrementPercent: 0.05, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 36 }, promotionChanceMonths: 36, promotionChance: 0.15, promotionTo: "it4" }, 
            { id: "it4", title: "IT Manager", field: JOB_FIELDS.IT, level: 4, salary: 9000, annualIncrementPercent: 0.03, companyAnnualBonusChance: 0.6, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 60 } },
            { id: "health0", title: "Hospital Volunteer", field: JOB_FIELDS.HEALTHCARE, level: 0, salary: 1900, annualIncrementPercent: 0.01, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.25, promotionTo: "health1"},
            { id: "health1", title: "Nursing Assistant", field: JOB_FIELDS.HEALTHCARE, level: 1, salary: 2800, annualIncrementPercent: 0.025, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 6 }, promotionChanceMonths: 18, promotionChance: 0.2, promotionTo: "health2" },
            { id: "health2", title: "Registered Nurse", field: JOB_FIELDS.HEALTHCARE, level: 2, salary: 4500, annualIncrementPercent: 0.035, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 24 }, promotionChanceMonths: 30, promotionChance: 0.15, promotionTo: "health3" },
            { id: "health3", title: "Senior Nurse Practitioner", field: JOB_FIELDS.HEALTHCARE, level: 3, salary: 7000, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 48 }, promotionChanceMonths: 36, promotionChance: 0.1, promotionTo: "health4" },
            { id: "health4", title: "Chief Nursing Officer", field: JOB_FIELDS.HEALTHCARE, level: 4, salary: 10000, annualIncrementPercent: 0.02, companyAnnualBonusChance: 0.7, companyAnnualBonusPercent: 0.12, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 72 } },
            { id: "biz0", title: "Office Intern", field: JOB_FIELDS.BUSINESS, level: 0, salary: 2000, annualIncrementPercent: 0.015, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.3, promotionTo: "biz1" },
            { id: "biz1", title: "Junior Accountant", field: JOB_FIELDS.BUSINESS, level: 1, salary: 3200, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 24, promotionChance: 0.2, promotionTo: "biz2" },
            { id: "biz2", title: "Financial Analyst", field: JOB_FIELDS.BUSINESS, level: 2, salary: 5000, annualIncrementPercent: 0.045, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 24 }, promotionChanceMonths: 30, promotionChance: 0.15, promotionTo: "biz3" },
            { id: "biz3", title: "Finance Manager", field: JOB_FIELDS.BUSINESS, level: 3, salary: 8000, annualIncrementPercent: 0.00, companyAnnualBonusChance: 0.7, companyAnnualBonusPercent: 0.15, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 48 }, promotionChanceMonths: 36, promotionChance: 0.1, promotionTo: "biz4" },
            { id: "biz4", title: "Chief Financial Officer (CFO)", field: JOB_FIELDS.BUSINESS, level: 4, salary: 12000, annualIncrementPercent: 0.00, companyAnnualBonusChance: 0.8, companyAnnualBonusPercent: 0.20, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 72 } },
            { id: "serv0", title: "Barista Trainee", field: JOB_FIELDS.SERVICE, level: 0, salary: 2000, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 6, promotionChance: 0.4, promotionTo: "serv1" },
            { id: "serv1", title: "Shift Supervisor", field: JOB_FIELDS.SERVICE, level: 1, salary: 2800, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.SERVICE, minExperienceInFieldMonths: 6 }, promotionChanceMonths: 18, promotionChance: 0.25, promotionTo: "serv2" },
            { id: "serv2", title: "Store Manager", field: JOB_FIELDS.SERVICE, level: 2, salary: 4000, annualIncrementPercent: 0.00, companyAnnualBonusChance: 0.5, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.SERVICE, minExperienceInFieldMonths: 24 } }
        ];
        
        const INITIAL_CASH = 20000;
        const PROPERTY_DOWN_PAYMENT_PERCENTAGE = 0.20;
        const AVAILABLE_LOAN_TERMS = [ { years: 10, months: 120 }, { years: 15, months: 180 }, { years: 20, months: 240 }, { years: 30, months: 360 }];
        const PROPERTY_FEES_PERCENTAGE_ANNUAL = 0.01;
        const MAX_LOG_ENTRIES = 35; 
        const PROPERTIES_PER_MONTH_MIN = 1;
        const PROPERTIES_PER_MONTH_MAX = 3;
        const GOLDEN_OPPORTUNITY_CHANCE = 0.015; 

        const CONDITION_DECAY_VACANT_PER_MONTH = 0.1;
        const CONDITION_DECAY_RENTED_PER_MONTH = 0.3; 
        const MIN_TENANT_STAY_MONTHS = 6;
        const CHANCE_TENANT_LEAVES_AFTER_MIN = 0.1;
        const CLEANING_FEE_MIN = 100;
        const CLEANING_FEE_MAX = 500;
        const RENOVATION_COST_PER_CONDITION_POINT = 100;
        const RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL = 0.03;
        const RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL = 0.08;
        const BASE_TENANT_FIND_CHANCE = 0.3;
        const RANDOM_DAMAGE_EVENT_CHANCE = 0.03;
        const RANDOM_DAMAGE_MIN_PERCENT = 3;
        const RANDOM_DAMAGE_MAX_PERCENT = 10;

        const ANNUAL_APPRECIATION_MIN = 0.02;
        const ANNUAL_APPRECIATION_MAX = 0.10;
        const ANNUAL_APPRECIATION_TYPICAL_BIAS_STRENGTH = 3; 
        const ANNUAL_APPRECIATION_TYPICAL = 0.05; 
        const BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET = 0.05; 
        const BUYER_OFFER_CONDITION_PENALTY_MAX = 0.10; 
        const COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL = 1.02; 
        const COUNTER_OFFER_REJECT_THRESHOLD_BAD_DEAL = 1.15; 
        const BASE_CHANCE_OF_RECEIVING_OFFER = 0.15; 
        const ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE = 0.1; 
        const CONDITION_SENSITIVITY_FOR_OFFER_CHANCE = 0.002; 

        const BAD_TENANT_CONDITION_THRESHOLD = 35; 
        const CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION = 0.20; 
        const DELINQUENT_NON_PAYMENT_BASE_CHANCE = 0.25; 
        const DELINQUENT_NON_PAYMENT_ESCALATION_PER_MONTH = 0.15; 
        const DELINQUENT_MAX_NON_PAYMENT_CHANCE = 0.90; 
        const CONDITION_THRESHOLD_TO_CURE_DELINQUENCY = 50; 
        const CHANCE_CURE_DELINQUENCY_IF_RENOVATED = 0.75; 

        const EXTERNAL_LOAN_MIN_MONTHLY_INTEREST = 0.01; 
        const EXTERNAL_LOAN_MAX_MONTHLY_INTEREST = 0.15; 
        const EXTERNAL_LOAN_TERM_MONTHS = 36; 
        const LOAN_AD_CHANCE = 0.03; 
        const MIN_MONTHS_FOR_LOAN_AD = 6; 
        
        const MAX_JOB_LISTINGS = 4;
        const JOB_APPLICATION_BASE_SUCCESS_CHANCE = 0.4;
        const BANKRUPTCY_THRESHOLD = -10000; 

        let player = { 
            ageMonths: 18 * 12, cash: INITIAL_CASH, 
            currentJobId: "unskilled0", 
            experienceInCurrentJobMonths: 0,
            totalExperienceInFieldMonths: 0, 
            salary: 1200, 
            netWorth: INITIAL_CASH, 
            properties: [], externalLoans: [],
            deathAgeYears: 0, 
            deathAgeMonths: 0 
        };
        let availableProperties = [];
        let availableJobs = []; 
        let gameLog = ["Game started. Good luck!"];
        let currentMonth = 0;
        let propertyToManageIndex = -1; 
        let currentOfferForProperty = null; 
        let selectedLoanTermMonths = AVAILABLE_LOAN_TERMS.find(t => t.years === 20).months;
        let jobToApplyForId = null; 
        let firstMonthAdvanced = false; 

        const ageEl = document.getElementById('player-age');
        const cashEl = document.getElementById('player-cash');
        const playerJobTitleEl = document.getElementById('player-job-title'); 
        const salaryEl = document.getElementById('player-salary');
        const netWorthEl = document.getElementById('player-net-worth');
        const propertyListingsEl = document.getElementById('property-listings');
        const jobMarketListingsEl = document.getElementById('job-market-listings'); 
        const ownedPropertiesEl = document.getElementById('owned-properties');
        const noOwnedPropertiesMsgEl = document.getElementById('no-owned-properties-msg');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const externalLoanBtn = document.getElementById('external-loan-btn'); 
        const newLifeBtn = document.getElementById('new-life-btn'); 
        const gameLogEl = document.getElementById('game-log');
        const gameHeaderEl = document.getElementById('gameHeader'); 
        
        const messageModal = document.getElementById('messageModal');
        const messageModalContentEl = messageModal.querySelector('.modal-content'); 
        const modalTitleEl = document.getElementById('modalTitle');
        const modalMessageEl = document.getElementById('modalMessage');
        const modalCloseBtn = messageModal.querySelector('.modal-button'); 

        const renovationModal = document.getElementById('renovationModal');
        const renovationModalTitleEl = document.getElementById('renovationModalTitle');
        const renovationModalTextEl = document.getElementById('renovationModalText');
        const renovationAmountInput = document.getElementById('renovationAmountInput');
        const renovationModalEstImprovementEl = document.getElementById('renovationModalEstImprovement');
        const confirmRenovationBtn = document.getElementById('confirmRenovationBtn');
        const cancelRenovationBtn = document.getElementById('cancelRenovationBtn');
        
        const loanTermModal = document.getElementById('loanTermModal');
        const loanTermModalTitleEl = document.getElementById('loanTermModalTitle');
        const loanPropertyDetailsEl = document.getElementById('loanPropertyDetails');
        const loanTermOptionsContainerEl = document.getElementById('loanTermOptionsContainer');
        const loanTermSelectedPaymentEl = document.getElementById('loanTermSelectedPayment');
        const confirmLoanBtn = document.getElementById('confirmLoanBtn');
        const cancelLoanBtn = document.getElementById('cancelLoanBtn');
        
        const listSaleModal = document.getElementById('listSaleModal');
        const listSaleModalTitleEl = document.getElementById('listSaleModalTitle');
        const listSalePropertyInfoEl = document.getElementById('listSalePropertyInfo');
        const listSaleMarketValueEl = document.getElementById('listSaleMarketValue');
        const askingPriceInputEl = document.getElementById('askingPriceInput');
        const confirmListSaleBtn = document.getElementById('confirmListSaleBtn');
        const cancelListSaleBtn = document.getElementById('cancelListSaleBtn');
        
        const offerModal = document.getElementById('offerModal');
        const offerModalTitleEl = document.getElementById('offerModalTitle');
        const offerPropertyInfoEl = document.getElementById('offerPropertyInfo');
        const offerAskingPriceEl = document.getElementById('offerAskingPrice');
        const offerBuyerOfferValueEl = document.getElementById('offerBuyerOfferValue');
        const offerCounterInputEl = document.getElementById('offerCounterInput');
        const acceptOfferBtn = document.getElementById('acceptOfferBtn');
        const submitOfferCounterBtn = document.getElementById('submitOfferCounterBtn');
        const rejectOfferBtn = document.getElementById('rejectOfferBtn');
        
        const externalLoanModal = document.getElementById('externalLoanModal');
        const externalLoanModalTitleEl = document.getElementById('externalLoanModalTitle');
        const externalLoanAmountInputEl = document.getElementById('externalLoanAmountInput');
        const externalLoanEstPaymentEl = document.getElementById('externalLoanEstPayment');
        const confirmExternalLoanBtn = document.getElementById('confirmExternalLoanBtn');
        const cancelExternalLoanBtn = document.getElementById('cancelExternalLoanBtn');

        const loanAdModal = document.getElementById('loanAdModal');
        const loanAdModalContentEl = loanAdModal.querySelector('.modal-content');
        const loanAdTakeLoanBtn = document.getElementById('loanAdTakeLoanBtn');
        const loanAdDismissBtn = document.getElementById('loanAdDismissBtn');

        const jobApplicationConfirmModal = document.getElementById('jobApplicationConfirmModal');
        const jobConfirmModalTitleEl = document.getElementById('jobConfirmModalTitle');
        const jobConfirmDetailsEl = document.getElementById('jobConfirmDetails');
        const confirmJobApplicationBtn = document.getElementById('confirmJobApplicationBtn');
        const cancelJobApplicationBtn = document.getElementById('cancelJobApplicationBtn');

        const resetConfirmModal = document.getElementById('resetConfirmModal');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');

        const gameOverOverlayEl = document.getElementById('gameOverOverlay');
        const gameOverTitleEl = document.getElementById('gameOverTitle');
        const gameOverMessageEl = document.getElementById('gameOverMessage');
        const restartGameBtn = document.getElementById('restartGameBtn');


        function formatCurrency(amount) { return Math.round(amount).toLocaleString(); }
        
        function showModal(title, message, type = 'info') { 
            modalTitleEl.textContent = title; modalMessageEl.textContent = message;
            messageModalContentEl.classList.remove('modal-success', 'modal-error', 'modal-warning', 'modal-info');
            modalTitleEl.className = 'text-center font-bold text-xl mb-4'; 
            modalCloseBtn.className = 'modal-button'; 
            switch (type) {
                case 'success': messageModalContentEl.classList.add('modal-success'); modalTitleEl.classList.add('text-green-700'); modalCloseBtn.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white'); break;
                case 'error': messageModalContentEl.classList.add('modal-error'); modalTitleEl.classList.add('text-red-700'); modalCloseBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white'); break;
                case 'warning': messageModalContentEl.classList.add('modal-warning'); modalTitleEl.classList.add('text-amber-700'); modalCloseBtn.classList.add('bg-amber-500', 'hover:bg-amber-600', 'text-white'); break;
                default: messageModalContentEl.classList.add('modal-info'); modalTitleEl.classList.add('text-blue-700'); modalCloseBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white'); break;
            }
            messageModal.style.display = "block";
        }

        modalCloseBtn.onclick = function() { messageModal.style.display = "none"; }
        
        window.onclick = function(event) {
            if (event.target == messageModal) messageModal.style.display = "none";
            if (event.target == renovationModal) renovationModal.style.display = "none";
            if (event.target == loanTermModal) loanTermModal.style.display = "none";
            if (event.target == listSaleModal) listSaleModal.style.display = "none";
            if (event.target == offerModal) offerModal.style.display = "none";
            if (event.target == externalLoanModal) externalLoanModal.style.display = "none";
            if (event.target == loanAdModal) loanAdModal.style.display = "none";
            if (event.target == jobApplicationConfirmModal) jobApplicationConfirmModal.style.display = "none";
            if (event.target == resetConfirmModal) resetConfirmModal.style.display = "none";
        }
        function addLogEntry(message) { gameLog.unshift(message); if (gameLog.length > MAX_LOG_ENTRIES) gameLog.pop(); renderGameLog(); }
        function getConditionClass(condition) { if (condition >= 70) return 'condition-good'; if (condition >= 40) return 'condition-fair'; return 'condition-poor'; }

        function renderPlayerStats() { 
            try {
                const currentJob = JOBS.find(j => j.id === player.currentJobId);
                ageEl.textContent = `${Math.floor(player.ageMonths / 12)} years, ${player.ageMonths % 12} months`;
                cashEl.textContent = formatCurrency(player.cash);
                playerJobTitleEl.textContent = currentJob ? currentJob.title : "Unemployed";
                salaryEl.textContent = formatCurrency(player.salary);
                netWorthEl.textContent = formatCurrency(calculateNetWorth());
            } catch (e) {
                console.error("Error in renderPlayerStats:", e);
            }
        }

        function renderPropertyListings() { 
            try {
                propertyListingsEl.innerHTML = '';
                if (!availableProperties || availableProperties.length === 0) { 
                    propertyListingsEl.innerHTML = '<p class="text-slate-500 text-center py-12">No new properties listed this month.</p>'; return;
                }
                availableProperties.forEach((prop, index) => {
                    if (!prop) { console.error("Undefined property in availableProperties at index:", index); return; } 
                    const downPayment = prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
                    const card = document.createElement('div');
                    card.className = `card ${prop.isGolden ? 'golden-opportunity' : ''}`;
                    card.innerHTML = `
                        <h3>${prop.name} (ID: ${prop.id})</h3>
                        <p class="price">Price: $${formatCurrency(prop.price)}</p>
                        <p class="rent-estimate">Est. Monthly Rent: $${formatCurrency(prop.estimatedRent)}</p>
                        <p>Initial Condition: <span class="${getConditionClass(prop.initialCondition)} font-semibold">${prop.initialCondition.toFixed(1)}%</span></p>
                        <p>Down Payment (20%): $${formatCurrency(downPayment)}</p>
                        <button class="button button-buy mt-3 w-full ${player.cash < downPayment ? 'button-disabled' : ''}" 
                                onclick="openLoanTermModal(${index})" 
                                ${player.cash < downPayment ? 'disabled' : ''}>
                            ${player.cash < downPayment ? 'Not Enough Cash' : 'Consider Purchase'}
                        </button>`;
                    propertyListingsEl.appendChild(card);
                });
            } catch (e) {
                console.error("Error in renderPropertyListings:", e);
                propertyListingsEl.innerHTML = '<p class="text-red-500 text-center py-12">Error loading property listings!</p>';
            }
        }
        
        function renderJobMarket() {
            try {
                jobMarketListingsEl.innerHTML = '';
                if (!availableJobs || availableJobs.length === 0) { 
                    jobMarketListingsEl.innerHTML = '<p class="text-slate-500 text-center py-12">No suitable job openings this month.</p>'; return;
                }
                availableJobs.forEach(job => {
                    if (!job) { console.error("Undefined job in availableJobs"); return; } 
                    const card = document.createElement('div');
                    card.className = 'card';
                    let prereqText = "None";
                    if (job.prerequisites) {
                        const prevJob = JOBS.find(j => j.level === job.prerequisites.previousJobLevel && j.field === job.prerequisites.field);
                        prereqText = `${prevJob ? prevJob.title : `Level ${job.prerequisites.previousJobLevel} in ${job.prerequisites.field}`} & ${(job.prerequisites.minExperienceInFieldMonths / 12).toFixed(1)} yrs in field`;
                    }

                    card.innerHTML = `
                        <h3>${job.title}</h3>
                        <p>Field: ${job.field}</p>
                        <p class="job-salary">Salary: $${formatCurrency(job.salary)}/month</p>
                        <p>Annual Increment: ${(job.annualIncrementPercent * 100).toFixed(1)}% ${job.companyAnnualBonusChance ? `(+ ${ (job.companyAnnualBonusPercent*100).toFixed(0) }% bonus chance)` : ''}</p>
                        <p class="text-xs">Prerequisites: ${prereqText}</p>
                        <button class="button button-apply-job mt-3 w-full" onclick="openJobApplicationConfirmModal('${job.id}')">Apply Now</button> `;
                    jobMarketListingsEl.appendChild(card);
                });
            } catch (e) {
                console.error("Error in renderJobMarket:", e);
                jobMarketListingsEl.innerHTML = '<p class="text-red-500 text-center py-12">Error loading job market!</p>';
            }
        }


        function renderOwnedProperties() { 
            try {
                ownedPropertiesEl.innerHTML = '';
                if (!player.properties || player.properties.length === 0) { 
                    ownedPropertiesEl.innerHTML = '<p class="text-slate-500 text-center py-12 col-span-full" id="no-owned-properties-msg">You don\'t own any properties yet.</p>';
                    return; 
                }
                player.properties.forEach((prop, index) => {
                    if (!prop) { console.error("Undefined property in player.properties at index:", index); return; } 
                    const card = document.createElement('div');
                    card.className = 'card';
                    let statusHTML = '', rentalActionButtonHTML = '', saleActionButtonHTML = '';
                    if (prop.isListedForSale) {
                        statusHTML = `<span class="property-status status-listed-sale">LISTED FOR SALE</span><br>Asking: <span class="asking-price">$${formatCurrency(prop.askingPrice)}</span><br>On Market: ${prop.timeOnMarket} months`;
                        saleActionButtonHTML = `<button class="button button-secondary w-full" onclick="openListSaleModal(${index}, true)">Adjust Price</button><button class="button button-secondary w-full" onclick="deListProperty(${index})">De-list Property</button>`;
                        rentalActionButtonHTML = `<button class="button button-rent mt-2 w-full" disabled title="Property is listed for sale">List for Rent (Blocked)</button>`;
                    } else if (prop.isDelinquent) {
                        statusHTML = `<span class="property-status status-delinquent">TENANT DELINQUENT (${prop.delinquentMonths} months unpaid)</span>`;
                        rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" disabled title="Tenant is delinquent. Renovate.">Manage Rental (Blocked)</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                    } else if (prop.isRented) {
                        statusHTML = `<span class="property-status status-rented">Rented: $${formatCurrency(prop.currentRent)}/month</span> (Tenant for ${prop.tenantMonths} months)`;
                        rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" disabled title="Property is currently rented">Manage Rental (Soon)</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                    } else if (prop.isListedForRent) { 
                        statusHTML = `<span class="property-status status-listed-rent">Listed for Rent</span>`; 
                        rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" onclick="toggleListingStatus(${index})">Cancel Rent Listing</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                    } else { 
                        statusHTML = `<span class="property-status status-vacant">Vacant</span>`;
                        rentalActionButtonHTML = `<button class="button button-rent mt-2 w-full" onclick="toggleListingStatus(${index})">List for Rent</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                    }
                    card.innerHTML = `
                        <h3>${prop.name} (ID: ${prop.id})</h3>
                        <p>Market Value: $${formatCurrency(prop.currentMarketValue)} (Bought for $${formatCurrency(prop.purchasePrice)})</p>
                        <p>Loan: $${formatCurrency(prop.remainingLoan)} (${prop.monthsPaid}/${prop.loanTermMonths} paid)</p>
                        <p>Monthly Installment: $${formatCurrency(prop.monthlyInstallment)}</p>
                        <p>Monthly Fees: $${formatCurrency(prop.monthlyFees)}</p>
                        <p>Condition: <span class="${getConditionClass(prop.condition)} font-semibold">${prop.condition.toFixed(1)}%</span></p>
                        <p>${statusHTML}</p>
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${rentalActionButtonHTML}
                            <button class="button button-renovate w-full" onclick="openRenovationModal(${index})">Renovate</button>
                            ${saleActionButtonHTML}
                        </div>
                        ${prop.remainingLoan <= 0 ? '<p class="font-bold text-green-600 mt-2">Fully Paid Off!</p>' : ''}
                    `;
                    ownedPropertiesEl.appendChild(card);
                });
            } catch (e) {
                console.error("Error in renderOwnedProperties:", e);
                ownedPropertiesEl.innerHTML = '<p class="text-red-500 text-center py-12 col-span-full">Error loading your portfolio!</p>';
            }
        }

        function renderGameLog() { 
             try {
                gameLogEl.innerHTML = '';
                if (!gameLog) return; 
                gameLog.forEach(entry => {
                    const li = document.createElement('li');
                    li.textContent = entry;
                    if (entry.toLowerCase().includes("bought") || entry.toLowerCase().includes("salary increase") || entry.toLowerCase().includes("rented out") || entry.toLowerCase().includes("rental income") || entry.toLowerCase().includes("sold") || entry.toLowerCase().includes("resumed payment") || entry.toLowerCase().includes("offer accepted") || entry.toLowerCase().includes("golden opportunity") || entry.toLowerCase().includes("got the job") || entry.toLowerCase().includes("promoted") || entry.toLowerCase().includes("bonus")) {
                        li.classList.add("text-green-700", "font-semibold");
                    } else if (entry.toLowerCase().includes("paid") || entry.toLowerCase().includes("expenses") || entry.toLowerCase().includes("fee") || entry.toLowerCase().includes("renovation") || entry.toLowerCase().includes("external loan payment")) {
                        li.classList.add("text-red-700");
                    } else if (entry.toLowerCase().includes("tenant left") || entry.toLowerCase().includes("damage") || entry.toLowerCase().includes("deal fell through") || entry.toLowerCase().includes("offer rejected") || entry.toLowerCase().includes("delinquent") || entry.toLowerCase().includes("stopped paying") || entry.toLowerCase().includes("no offers") || entry.toLowerCase().includes("took external loan") || entry.toLowerCase().includes("application rejected")) {
                        li.classList.add("text-amber-700", "font-semibold");
                    }
                    gameLogEl.appendChild(li);
                });
            } catch (e) {
                console.error("Error in renderGameLog:", e);
            }
        }

        function generateNewProperties() { 
            if (typeof PROPERTY_TYPES === 'undefined' || !PROPERTY_TYPES) {
                console.error("CRITICAL: PROPERTY_TYPES is undefined or null in generateNewProperties!");
                availableProperties = []; return;
            }
            availableProperties = [];
            const numPropsToGenerate = Math.floor(Math.random() * (PROPERTIES_PER_MONTH_MAX - PROPERTIES_PER_MONTH_MIN + 1)) + PROPERTIES_PER_MONTH_MIN;
            let goldenAppearedThisMonth = false;
            for (let i = 0; i < numPropsToGenerate; i++) {
                const typeIndex = Math.floor(Math.random() * PROPERTY_TYPES.length);
                const type = PROPERTY_TYPES[typeIndex];
                if (!type) { console.error("Error: Could not find property type for index", typeIndex); continue; }
                let price, initialCondition, estimatedRent; let isGolden = false;
                if (!goldenAppearedThisMonth && Math.random() < GOLDEN_OPPORTUNITY_CHANCE) {
                    isGolden = true; goldenAppearedThisMonth = true;
                    price = Math.round(type.basePrice * (0.65 + Math.random() * 0.15)); 
                    initialCondition = 85 + Math.random() * 15; 
                    addLogEntry(`‚≠ê A Golden Opportunity appeared: ${type.name}!`);
                } else {
                    price = type.basePrice + Math.floor(Math.random() * type.priceRange);
                    let conditionFactor = type.priceRange > 0 ? (price - type.basePrice) / type.priceRange : 1;
                    conditionFactor = Math.max(0, Math.min(1, conditionFactor));
                    let baseRandomCondition = 60 + Math.random() * 40; 
                    initialCondition = baseRandomCondition - (1 - conditionFactor) * 40;
                    initialCondition = Math.max(20, Math.min(100, initialCondition)); 
                }
                const annualRentMin = price * RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL;
                const annualRentMax = price * RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL;
                estimatedRent = (annualRentMin + Math.random() * (annualRentMax - annualRentMin)) / 12;
                let rentConditionFactor = isGolden ? (0.8 + Math.random() * 0.2) : (0.5 + initialCondition / 200); 
                estimatedRent *= rentConditionFactor; 
                estimatedRent = Math.max(50, Math.round(estimatedRent));
                availableProperties.push({
                    id: `P${Date.now().toString().slice(-4)}${i}`, name: type.name, price: price,
                    baseRentability: type.baseRentability, initialCondition: initialCondition,
                    estimatedRent: estimatedRent, isGolden: isGolden
                });
            }
            if (availableProperties.length > 0) { 
                 addLogEntry(`Market update: ${availableProperties.length} new properties listed.`);
            } else if (numPropsToGenerate > 0) {
                 addLogEntry(`Market update: No properties met criteria this month.`);
            }
        }

        function generateJobOpportunities() {
            availableJobs = [];
            const currentPlayerJob = JOBS.find(j => j.id === player.currentJobId);
            if (!currentPlayerJob) {
                console.error("Error: Current player job not found in generateJobOpportunities! ID:", player.currentJobId);
                return; 
            }

            const potentialJobs = JOBS.filter(job => {
                if (job.id === player.currentJobId) return false; 
                let meetsPrereqs = true; 
                if (job.prerequisites) {
                    const currentJobField = currentPlayerJob.field;
                    if (job.prerequisites.field && currentJobField !== job.prerequisites.field && job.level > 0) { 
                        meetsPrereqs = false;
                    }
                    if (meetsPrereqs && job.prerequisites.previousJobLevel !== undefined && currentPlayerJob.level < job.prerequisites.previousJobLevel) {
                        meetsPrereqs = false;
                    }
                    if (meetsPrereqs && job.prerequisites.minExperienceInFieldMonths) {
                        let experienceInTargetField = (currentJobField === job.field) ? player.totalExperienceInFieldMonths : 0;
                        if (experienceInTargetField < job.prerequisites.minExperienceInFieldMonths) {
                            meetsPrereqs = false;
                        }
                    }
                }
                if (!meetsPrereqs) return false; 

                const salaryLowerBound = player.salary * 0.7;
                const salaryUpperBound = player.salary * 1.8;
                const isSalaryRelevant = job.salary >= salaryLowerBound && job.salary <= salaryUpperBound;

                if (job.field === currentPlayerJob.field && job.level === currentPlayerJob.level + 1) return true; 
                if (job.level === 0 && job.field !== currentPlayerJob.field) return true; 
                if (isSalaryRelevant && Math.random() < 0.6) return true; 
                if (job.level === currentPlayerJob.level && job.field !== currentPlayerJob.field && Math.random() < 0.3) return true; 
                
                return Math.random() < 0.1; 
            });

            potentialJobs.sort(() => 0.5 - Math.random());
            availableJobs = potentialJobs.slice(0, MAX_JOB_LISTINGS);
        }


        function calculateNetWorth() { 
            let propertyMarketValues = player.properties.reduce((sum, prop) => sum + (prop.currentMarketValue || prop.purchasePrice), 0); 
            let totalPropertyLoan = player.properties.reduce((sum, prop) => sum + (prop.remainingLoan || 0), 0);
            let totalExternalLoan = player.externalLoans.reduce((sum, loan) => sum + (loan.remainingBalance || 0), 0);
            player.netWorth = player.cash + propertyMarketValues - totalPropertyLoan - totalExternalLoan;
            return player.netWorth;
        }

        function advanceMonth() {
            try { 
                if (!firstMonthAdvanced) {
                    if (gameHeaderEl) gameHeaderEl.classList.add('header-hidden');
                    firstMonthAdvanced = true;
                    // saveGame(); // Save after first advance to store header state - moved to end of advanceMonth
                }

                currentMonth++; player.ageMonths++; player.cash += player.salary;
                addLogEntry(`Payday! Received $${formatCurrency(player.salary)} salary.`);
                player.experienceInCurrentJobMonths++;
                player.totalExperienceInFieldMonths++;

                const currentJob = JOBS.find(j => j.id === player.currentJobId);
                if (currentJob) {
                    if (player.experienceInCurrentJobMonths > 0 && player.experienceInCurrentJobMonths % 12 === 0 && currentJob.annualIncrementPercent > 0) {
                        const oldSalary = player.salary;
                        player.salary = Math.round(player.salary * (1 + currentJob.annualIncrementPercent));
                        addLogEntry(`Annual raise at ${currentJob.title}! New salary: $${formatCurrency(player.salary)} (was $${formatCurrency(oldSalary)}).`);
                        showModal("Annual Raise!", `You received an annual raise. Your new salary is $${formatCurrency(player.salary)}.`, 'success');
                    }
                    if (currentJob.companyAnnualBonusChance && currentMonth % 12 === 11) { 
                        if (Math.random() < currentJob.companyAnnualBonusChance) {
                            const bonusAmount = Math.round(player.salary * 12 * currentJob.companyAnnualBonusPercent); 
                            player.cash += bonusAmount;
                            addLogEntry(`Received an annual bonus of $${formatCurrency(bonusAmount)} from ${currentJob.title}!`);
                            showModal("Annual Bonus!", `Congratulations! You received an annual bonus of $${formatCurrency(bonusAmount)}.`, 'success');
                        }
                    }
                    if (currentJob.promotionTo && currentJob.promotionChance && currentJob.promotionChanceMonths &&
                        player.experienceInCurrentJobMonths >= currentJob.promotionChanceMonths &&
                        Math.random() < currentJob.promotionChance) {
                        const newJob = JOBS.find(j => j.id === currentJob.promotionTo);
                        if (newJob) {
                            addLogEntry(`üéâ PROMOTION! You've been promoted from ${currentJob.title} to ${newJob.title}!`);
                            showModal("Promotion!", `Congratulations! You've been promoted to ${newJob.title} with a salary of $${formatCurrency(newJob.salary)}.`, 'success');
                            const oldJobField = currentJob.field; 
                            player.currentJobId = newJob.id;
                            player.salary = newJob.salary;
                            player.experienceInCurrentJobMonths = 0;
                            if (oldJobField !== newJob.field) { 
                                player.totalExperienceInFieldMonths = 0;
                            }
                        }
                    }
                } else {
                    console.error("Player current job is undefined in advanceMonth:", player.currentJobId);
                }


                let totalExternalLoanPayments = 0;
                for (let i = player.externalLoans.length - 1; i >= 0; i--) {
                    const loan = player.externalLoans[i];
                    const interestThisMonth = loan.remainingBalance * loan.monthlyInterestRate;
                    const principalPayment = loan.monthlyPayment - interestThisMonth;
                    player.cash -= loan.monthlyPayment; loan.remainingBalance -= principalPayment; 
                    loan.remainingBalance = Math.max(0, loan.remainingBalance); 
                    loan.monthsPaid++; totalExternalLoanPayments += loan.monthlyPayment;
                    if (loan.remainingBalance <= 0.01 || loan.monthsPaid >= loan.termMonths) { 
                        addLogEntry(`External Loan (ID: ${loan.id}) of $${formatCurrency(loan.principal)} has been fully paid off!`);
                        showModal("External Loan Paid Off!", `Your external loan (ID: ${loan.id}) is now fully paid.`, 'success');
                        player.externalLoans.splice(i, 1);
                    }
                }
                if (totalExternalLoanPayments > 0) addLogEntry(`Paid $${formatCurrency(totalExternalLoanPayments)} for external loan installments.`);

                if (currentMonth > 0 && currentMonth % 12 === 0) {
                    addLogEntry("Annual market review...");
                    player.properties.forEach(prop => {
                        const appreciationRates = [ANNUAL_APPRECIATION_MIN, ANNUAL_APPRECIATION_MAX];
                        for(let k=0; k<ANNUAL_APPRECIATION_TYPICAL_BIAS_STRENGTH; k++) appreciationRates.push(ANNUAL_APPRECIATION_TYPICAL);
                        const randomAppreciationRate = appreciationRates[Math.floor(Math.random() * appreciationRates.length)];
                        prop.currentMarketValue = Math.round(prop.currentMarketValue * (1 + randomAppreciationRate));
                        addLogEntry(`${prop.name} market value appreciated by ${(randomAppreciationRate * 100).toFixed(1)}% to $${formatCurrency(prop.currentMarketValue)}.`);
                    });
                    showModal("Market Update", "Property values updated based on annual market appreciation.", 'info');
                }

                let totalPropertyExpenses = 0, totalRentalIncome = 0;
                player.properties.forEach((prop, index) => { 
                    if (prop.remainingLoan > 0) {
                        const paymentThisMonth = Math.min(prop.monthlyInstallment, prop.remainingLoan);
                        player.cash -= paymentThisMonth; prop.remainingLoan -= paymentThisMonth; prop.monthsPaid++; totalPropertyExpenses += paymentThisMonth;
                        if (prop.remainingLoan <= 0) { addLogEntry(`${prop.name} is fully paid off!`); showModal("Property Paid Off!", `${prop.name} is now fully yours!`, 'success'); }
                    }
                    player.cash -= prop.monthlyFees; totalPropertyExpenses += prop.monthlyFees;
                    if (Math.random() < RANDOM_DAMAGE_EVENT_CHANCE) {
                        let incidentDamage = RANDOM_DAMAGE_MIN_PERCENT + Math.random() * (RANDOM_DAMAGE_MAX_PERCENT - RANDOM_DAMAGE_MIN_PERCENT);
                        prop.condition -= incidentDamage;
                        addLogEntry(`ALERT! ${prop.name} suffered damage, losing ${incidentDamage.toFixed(1)}% condition.`);
                        showModal("Property Incident!", `${prop.name} condition dropped by ${incidentDamage.toFixed(1)}%! Consider renovating.`, 'warning');
                    }
                    prop.condition -= (prop.isRented ? CONDITION_DECAY_RENTED_PER_MONTH : CONDITION_DECAY_VACANT_PER_MONTH);
                    prop.condition = Math.max(0, prop.condition);

                    if (prop.isListedForSale) {
                        prop.timeOnMarket++; let offerChance = BASE_CHANCE_OF_RECEIVING_OFFER;
                        const priceRatio = prop.askingPrice > 0 ? prop.askingPrice / prop.currentMarketValue : 1; 
                        if (priceRatio > 1) offerChance -= (priceRatio - 1) * ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE * 5; 
                        else offerChance += (1 - priceRatio) * ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE * 2; 
                        offerChance += (prop.condition / 100 - 0.5) * CONDITION_SENSITIVITY_FOR_OFFER_CHANCE * 100; 
                        offerChance = Math.max(0.01, Math.min(0.9, offerChance)); 
                        if (Math.random() < offerChance) {
                            let buyerOffer = prop.currentMarketValue * (1 - BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET);
                            const conditionPenaltyFactor = (100 - prop.condition) / 100;
                            buyerOffer *= (1 - (BUYER_OFFER_CONDITION_PENALTY_MAX * conditionPenaltyFactor));
                            if (prop.askingPrice < buyerOffer && prop.askingPrice > 0) buyerOffer = prop.askingPrice + Math.random() * (buyerOffer - prop.askingPrice); 
                            currentOfferForProperty = Math.round(Math.max(0, buyerOffer));
                            addLogEntry(`OFFER RECEIVED for ${prop.name}! Buyer offers $${formatCurrency(currentOfferForProperty)} (Asking: $${formatCurrency(prop.askingPrice)}).`);
                            openOfferModal(index, currentOfferForProperty); 
                        }
                    }
                    if (!prop.isListedForSale) {
                        if (prop.isRented) {
                            let tenantPaidThisMonth = true;
                            if (prop.isDelinquent) {
                                let nonPaymentChance = DELINQUENT_NON_PAYMENT_BASE_CHANCE + (prop.delinquentMonths * DELINQUENT_NON_PAYMENT_ESCALATION_PER_MONTH);
                                nonPaymentChance = Math.min(nonPaymentChance, DELINQUENT_MAX_NON_PAYMENT_CHANCE);
                                if (Math.random() < nonPaymentChance) {
                                    tenantPaidThisMonth = false; prop.delinquentMonths++;
                                    addLogEntry(`BAD TENANT: ${prop.name} did not pay rent (Cond: ${prop.condition.toFixed(1)}%). ${prop.delinquentMonths} months unpaid.`);
                                    showModal("Rent Not Paid!", `Tenant at ${prop.name} is delinquent and did not pay rent. Improve property condition!`, 'warning');
                                } else { player.cash += prop.currentRent; totalRentalIncome += prop.currentRent; addLogEntry(`Delinquent tenant at ${prop.name} paid $${formatCurrency(prop.currentRent)}.`); }
                            } else if (prop.condition < BAD_TENANT_CONDITION_THRESHOLD && Math.random() < CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION) {
                                prop.isDelinquent = true; prop.delinquentMonths = 1; tenantPaidThisMonth = false;
                                addLogEntry(`WARNING: Tenant at ${prop.name} became delinquent (Cond: ${prop.condition.toFixed(1)}%) and stopped paying!`);
                                showModal("Tenant Delinquent!", `Tenant at ${prop.name} became delinquent due to poor condition and has not paid rent!`, 'warning');
                            }
                            if (tenantPaidThisMonth && !prop.isDelinquent) { player.cash += prop.currentRent; totalRentalIncome += prop.currentRent; }
                            if (prop.isDelinquent && prop.condition >= CONDITION_THRESHOLD_TO_CURE_DELINQUENCY) {
                                if (Math.random() < CHANCE_CURE_DELINQUENCY_IF_RENOVATED) {
                                    prop.isDelinquent = false; prop.delinquentMonths = 0;
                                    addLogEntry(`GOOD NEWS: Tenant at ${prop.name} resumed payments after renovation!`);
                                    showModal("Tenant Recovered!", `Tenant at ${prop.name} is no longer delinquent and resumed payments.`, 'success');
                                }
                            }
                            prop.tenantMonths++; 
                            if (prop.tenantMonths >= MIN_TENANT_STAY_MONTHS && Math.random() < CHANCE_TENANT_LEAVES_AFTER_MIN) {
                                addLogEntry(`Tenant left ${prop.name}.`); showModal("Tenant Left", `Tenant at ${prop.name} moved out.`, 'warning');
                                prop.isRented = false; prop.isListedForRent = true; prop.currentRent = 0; prop.tenantMonths = 0;
                                prop.isDelinquent = false; prop.delinquentMonths = 0; 
                                const cleaningFee = CLEANING_FEE_MIN + Math.random() * (CLEANING_FEE_MAX - CLEANING_FEE_MIN);
                                player.cash -= cleaningFee; totalPropertyExpenses += cleaningFee;
                                addLogEntry(`Paid $${formatCurrency(cleaningFee)} cleaning fee for ${prop.name}.`);
                                prop.condition -= Math.random() * 5; prop.condition = Math.max(0, prop.condition);
                                if (prop.condition < 30) addLogEntry(`${prop.name} poor condition (${prop.condition.toFixed(1)}%) after tenant. Renovate?`);
                            }
                        } else if (prop.isListedForRent) { 
                            const effectiveRentability = prop.baseRentability * (prop.condition / 100);
                            if (Math.random() < BASE_TENANT_FIND_CHANCE * effectiveRentability) {
                                prop.isRented = true; prop.isListedForRent = false; prop.isDelinquent = false; prop.delinquentMonths = 0; 
                                const annualRentMin = prop.currentMarketValue * RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL;
                                const annualRentMax = prop.currentMarketValue * RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL;
                                let monthlyRent = (annualRentMin + Math.random() * (annualRentMax - annualRentMin)) / 12;
                                monthlyRent *= (0.5 + prop.condition / 200); monthlyRent = Math.max(50, Math.round(monthlyRent));
                                prop.currentRent = monthlyRent; prop.tenantMonths = 0;
                                addLogEntry(`${prop.name} rented for $${formatCurrency(prop.currentRent)}/month!`);
                                showModal("Tenant Found!", `Tenant for ${prop.name} at $${formatCurrency(prop.currentRent)}/month.`, 'success');
                            }
                        }
                    } 
                }); 
                if (totalRentalIncome > 0) addLogEntry(`Total rental income: $${formatCurrency(totalRentalIncome)}.`);
                if (totalPropertyExpenses > 0) addLogEntry(`Total property expenses: $${formatCurrency(totalPropertyExpenses)}.`);

                if (currentMonth > MIN_MONTHS_FOR_LOAN_AD && Math.random() < LOAN_AD_CHANCE && externalLoanModal.style.display !== 'block' && loanAdModal.style.display !== 'block' && messageModal.style.display !== 'block') {
                    openLoanAdModal();
                }

                generateNewProperties(); 
                generateJobOpportunities(); 
                updateAllUI();
                saveGame(); 

                // Game End Conditions
                if (player.cash < BANKRUPTCY_THRESHOLD && !nextMonthBtn.disabled) { 
                    gameOverTitleEl.textContent = "Game Over: Bankruptcy!";
                    gameOverMessageEl.textContent = `Your cash fell below $${formatCurrency(BANKRUPTCY_THRESHOLD)}! Your final net worth was $${formatCurrency(player.netWorth)}.`;
                    gameOverOverlayEl.style.display = 'flex';
                    addLogEntry("GAME OVER: You are bankrupt!");
                    nextMonthBtn.disabled = true; nextMonthBtn.classList.add('button-disabled'); nextMonthBtn.textContent = "Game Over";
                } else if (player.ageMonths >= player.deathAgeMonths && !nextMonthBtn.disabled) { 
                    const finalAgeYears = Math.floor(player.ageMonths / 12);
                    gameOverTitleEl.textContent = "Time's Up!";
                    gameOverMessageEl.textContent = `You lived a full life to the age of ${finalAgeYears}! Your final net worth is $${formatCurrency(player.netWorth)}. Thanks for playing!`;
                    gameOverOverlayEl.style.display = 'flex';
                    addLogEntry(`GAME ENDED: Reached age ${finalAgeYears}. Final Net Worth: $${formatCurrency(player.netWorth)}`);
                    nextMonthBtn.disabled = true; nextMonthBtn.classList.add('button-disabled'); nextMonthBtn.textContent = "Game Ended";
                }

            } catch (e) {
                console.error("Critical error in advanceMonth:", e);
                showModal("Critical Error", "A critical error occurred. Please check the console and consider refreshing.", 'error');
            }
        }

        window.openLoanTermModal = function(index) { 
            propertyToManageIndex = index; 
            const prop = availableProperties[index];
            if (!prop) return;
            const downPayment = prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
            if (player.cash < downPayment) {
                showModal("Not Enough Cash", `Need $${formatCurrency(downPayment)}, have $${formatCurrency(player.cash)}.`, 'warning'); return;
            }
            loanTermModalTitleEl.textContent = `Finance Purchase: ${prop.name}`;
            loanPropertyDetailsEl.innerHTML = `<p><strong>Price:</strong> $${formatCurrency(prop.price)}</p><p><strong>Est. Rent:</strong> $${formatCurrency(prop.estimatedRent)}/month</p><p><strong>Down Payment (20%):</strong> $${formatCurrency(downPayment)}</p><p><strong>Loan Amount:</strong> $${formatCurrency(prop.price - downPayment)}</p><p><strong>Initial Condition:</strong> ${prop.initialCondition.toFixed(1)}%</p>`;
            loanTermOptionsContainerEl.innerHTML = '';
            AVAILABLE_LOAN_TERMS.forEach(term => {
                const loanAmount = prop.price - downPayment; const monthlyPayment = loanAmount / term.months;
                const optionDiv = document.createElement('div'); optionDiv.className = 'loan-term-option';
                optionDiv.innerHTML = `<input type="radio" id="term-${term.months}" name="loanTerm" value="${term.months}" ${term.months === selectedLoanTermMonths ? 'checked' : ''}><label for="term-${term.months}">${term.years} Years (Monthly: $${formatCurrency(monthlyPayment)})</label>`;
                loanTermOptionsContainerEl.appendChild(optionDiv);
            });
            document.querySelectorAll('input[name="loanTerm"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedLoanTermMonths = parseInt(this.value);
                    const loanAmount = prop.price - (prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE);
                    loanTermSelectedPaymentEl.textContent = formatCurrency(loanAmount / selectedLoanTermMonths);
                });
            });
            const defaultRadio = document.querySelector('input[name="loanTerm"]:checked');
            if(defaultRadio) defaultRadio.dispatchEvent(new Event('change'));
            loanTermModal.style.display = 'block';
        }

        confirmLoanBtn.onclick = function() { 
            const propToBuy = availableProperties[propertyToManageIndex]; 
            if (!propToBuy) return;
            const downPayment = propToBuy.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
            const loanAmount = propToBuy.price - downPayment;
            const chosenTermMonths = parseInt(document.querySelector('input[name="loanTerm"]:checked').value);
            const monthlyInstallment = loanAmount / chosenTermMonths;
            const monthlyFees = (propToBuy.price * PROPERTY_FEES_PERCENTAGE_ANNUAL) / 12;
            player.cash -= downPayment;
            const newOwnedProperty = {
                id: propToBuy.id, name: propToBuy.name, purchasePrice: propToBuy.price,
                currentMarketValue: propToBuy.price, baseRentability: propToBuy.baseRentability, 
                downPaymentPaid: downPayment, loanAmount: loanAmount, remainingLoan: loanAmount,
                monthlyInstallment: monthlyInstallment, monthlyFees: monthlyFees, monthsPaid: 0, 
                condition: propToBuy.initialCondition, isRented: false, isListedForRent: false, 
                currentRent: 0, tenantMonths: 0, isDelinquent: false, delinquentMonths: 0, 
                isListedForSale: false, askingPrice: 0, timeOnMarket: 0, loanTermMonths: chosenTermMonths
            };
            player.properties.push(newOwnedProperty);
            addLogEntry(`Bought ${propToBuy.name} for $${formatCurrency(propToBuy.price)} (${chosenTermMonths/12}-yr loan).`);
            showModal("Purchase Successful!", `Bought ${propToBuy.name}! Cash: $${formatCurrency(player.cash)}.`, 'success');
            availableProperties.splice(propertyToManageIndex, 1);
            loanTermModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI(); saveGame();
        }
        cancelLoanBtn.onclick = function() { loanTermModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.toggleListingStatus = function(index) { 
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop || prop.isRented || prop.isDelinquent || prop.isListedForSale) { 
                 if(prop.isDelinquent) showModal("Action Blocked", "Cannot change listing status while tenant is delinquent.", 'warning');
                 if(prop.isListedForSale) showModal("Action Blocked", "Property is currently listed for sale. De-list it first to manage rentals.", 'warning');
                return;
            }
            prop.isListedForRent = !prop.isListedForRent;
            addLogEntry(prop.isListedForRent ? `${prop.name} listed for rent.` : `Cancelled rent listing for ${prop.name}.`);
            updateAllUI(); saveGame();
        }
        window.openRenovationModal = function(index) { 
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            renovationModalTitleEl.textContent = `Renovate ${prop.name}`;
            renovationModalTextEl.textContent = `Cond: ${prop.condition.toFixed(1)}%. Max cost to 100%: $${formatCurrency((100 - prop.condition) * RENOVATION_COST_PER_CONDITION_POINT)}. Amount:`;
            renovationAmountInput.value = ''; renovationAmountInput.max = player.cash; renovationModalEstImprovementEl.textContent = '';
            renovationModal.style.display = 'block';
        }
        renovationAmountInput.addEventListener('input', function() { 
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            const amount = parseFloat(renovationAmountInput.value) || 0;
            const pointsToGain = Math.min(100 - prop.condition, amount / RENOVATION_COST_PER_CONDITION_POINT);
            renovationModalEstImprovementEl.textContent = `Improve by ${pointsToGain.toFixed(1)}% to ${(prop.condition + pointsToGain).toFixed(1)}%.`;
        });
        confirmRenovationBtn.onclick = function() { 
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            let amountSpent = Math.min(parseFloat(renovationAmountInput.value) || 0, player.cash);
            amountSpent = Math.min(amountSpent, (100 - prop.condition) * RENOVATION_COST_PER_CONDITION_POINT); 
            amountSpent = Math.max(0, amountSpent); 
            if (amountSpent <= 0 && (100 - prop.condition > 0.1)) { 
                 showModal("Invalid Amount", "Enter positive amount for renovation if repairs are needed.", 'warning'); return; 
            }
            if (amountSpent === 0 && (100 - prop.condition < 0.1)) { 
                showModal("Already Perfect", `${prop.name} is already at or near 100% condition.`, 'info');
                renovationModal.style.display = 'none'; propertyToManageIndex = -1; return;
            }
            player.cash -= amountSpent;
            const conditionImproved = amountSpent / RENOVATION_COST_PER_CONDITION_POINT;
            prop.condition = Math.min(100, prop.condition + conditionImproved);
            addLogEntry(`Spent $${formatCurrency(amountSpent)} renovating ${prop.name}. Cond: ${prop.condition.toFixed(1)}%.`);
            showModal("Renovation Complete", `${prop.name} cond: ${prop.condition.toFixed(1)}%.`, 'success');
            renovationModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI(); saveGame();
        }
        cancelRenovationBtn.onclick = function() { renovationModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.openListSaleModal = function(index, isAdjusting = false) {
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            if (prop.isDelinquent) { showModal("Cannot List", "Property has a delinquent tenant. Resolve this issue before listing for sale.", 'warning'); return; }
            if (prop.isRented) { showModal("Cannot List", `${prop.name} is currently rented. Tenant must leave before listing for sale.`, 'warning'); return; }
            listSaleModalTitleEl.textContent = isAdjusting ? `Adjust Asking Price: ${prop.name}` : `List for Sale: ${prop.name}`;
            listSalePropertyInfoEl.innerHTML = `<p><strong>Original Purchase:</strong> $${formatCurrency(prop.purchasePrice)}</p><p><strong>Remaining Loan:</strong> $${formatCurrency(prop.remainingLoan)}</p><p><strong>Condition:</strong> ${prop.condition.toFixed(1)}%</p>`;
            listSaleMarketValueEl.textContent = formatCurrency(prop.currentMarketValue);
            askingPriceInputEl.value = prop.isListedForSale ? prop.askingPrice : Math.round(prop.currentMarketValue * 1.05); 
            askingPriceInputEl.placeholder = `e.g., ${formatCurrency(Math.round(prop.currentMarketValue * 1.05))}`;
            confirmListSaleBtn.textContent = isAdjusting ? "Update Asking Price" : "List Property";
            listSaleModal.style.display = 'block';
        }
        confirmListSaleBtn.onclick = function() {
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            const newAskingPrice = parseFloat(askingPriceInputEl.value);
            if (isNaN(newAskingPrice) || newAskingPrice <= 0) { showModal("Invalid Price", "Please enter a valid positive asking price.", 'warning'); return; }
            if (prop.isListedForSale) addLogEntry(`Asking price for ${prop.name} changed from $${formatCurrency(prop.askingPrice)} to $${formatCurrency(newAskingPrice)}.`);
            else { addLogEntry(`${prop.name} listed for sale with asking price $${formatCurrency(newAskingPrice)}.`); prop.timeOnMarket = 0; }
            prop.isListedForSale = true; prop.askingPrice = newAskingPrice; prop.isListedForRent = false; 
            listSaleModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI(); saveGame();
        }
        cancelListSaleBtn.onclick = function() { listSaleModal.style.display = 'none'; propertyToManageIndex = -1; }
        window.deListProperty = function(index) {
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop || !prop.isListedForSale) return;
            prop.isListedForSale = false; prop.askingPrice = 0; prop.timeOnMarket = 0;
            addLogEntry(`${prop.name} has been de-listed from the sale market.`);
            showModal("Property De-listed", `${prop.name} is no longer for sale.`, 'info');
            propertyToManageIndex = -1; updateAllUI(); saveGame();
        }
        window.openOfferModal = function(index, buyerOfferAmount) {
            propertyToManageIndex = index; currentOfferForProperty = buyerOfferAmount; 
            const prop = player.properties[propertyToManageIndex]; if (!prop || !prop.isListedForSale) return;
            offerModalTitleEl.textContent = `Buyer's Offer for ${prop.name}!`;
            offerPropertyInfoEl.innerHTML = `<p><strong>Market Value:</strong> $${formatCurrency(prop.currentMarketValue)}</p><p><strong>Condition:</strong> ${prop.condition.toFixed(1)}%</p>`;
            offerAskingPriceEl.textContent = formatCurrency(prop.askingPrice);
            offerBuyerOfferValueEl.textContent = formatCurrency(currentOfferForProperty);
            offerCounterInputEl.value = ''; offerCounterInputEl.placeholder = `e.g., ${formatCurrency(Math.round(currentOfferForProperty * 1.03))}`;
            offerModal.style.display = 'block';
        }
        acceptOfferBtn.onclick = function() {
            if (propertyToManageIndex === -1 || currentOfferForProperty === null) return;
            finalizeSale(propertyToManageIndex, currentOfferForProperty);
        }
        rejectOfferBtn.onclick = function() {
            if (propertyToManageIndex === -1) return;
            const prop = player.properties[propertyToManageIndex];
            addLogEntry(`You rejected offer of $${formatCurrency(currentOfferForProperty)} for ${prop.name}. Remains listed.`);
            showModal("Offer Rejected", `You rejected the buyer's offer. ${prop.name} remains on the market.`, 'warning');
            offerModal.style.display = 'none'; propertyToManageIndex = -1; currentOfferForProperty = null; updateAllUI(); 
        }
        submitOfferCounterBtn.onclick = function() {
            if (propertyToManageIndex === -1 || currentOfferForProperty === null) return;
            const prop = player.properties[propertyToManageIndex];
            const playerCounter = parseFloat(offerCounterInputEl.value);
            if (isNaN(playerCounter) || playerCounter <= 0) { showModal("Invalid Counter", "Please enter a valid positive amount.", 'warning'); return; }
            if (playerCounter < currentOfferForProperty) {
                 showModal("Low Counter-Offer", `Buyer accepts your lower counter of $${formatCurrency(playerCounter)}!`, 'success');
                 finalizeSale(propertyToManageIndex, playerCounter); return;
            }
            addLogEntry(`Countered $${formatCurrency(playerCounter)} for ${prop.name} (Offer: $${formatCurrency(currentOfferForProperty)}).`);
            let chanceOfAcceptance = 0.5; 
            if (playerCounter <= currentOfferForProperty * COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL) chanceOfAcceptance = 0.85; 
            else if (playerCounter >= currentOfferForProperty * COUNTER_OFFER_REJECT_THRESHOLD_BAD_DEAL || playerCounter > prop.currentMarketValue * 1.1) chanceOfAcceptance = 0.1; 
            else {
                const range = COUNTER_OFFER_REJECT_THRESHOLD_BAD_DEAL - COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL;
                const positionInRange = ( (playerCounter / currentOfferForProperty) - COUNTER_OFFER_ACCEPT_THRESHOLD_GOOD_DEAL) / range;
                chanceOfAcceptance = 0.85 - (positionInRange * 0.75); 
                chanceOfAcceptance = Math.max(0.1, Math.min(0.85, chanceOfAcceptance)); 
            }
            if (prop.condition > 90) chanceOfAcceptance += 0.05;
            if (Math.random() < chanceOfAcceptance) {
                addLogEntry(`Buyer accepted counter of $${formatCurrency(playerCounter)} for ${prop.name}!`);
                finalizeSale(propertyToManageIndex, playerCounter);
            } else {
                addLogEntry(`Buyer rejected counter of $${formatCurrency(playerCounter)} for ${prop.name}. Remains listed.`);
                showModal("Counter Rejected", `The buyer rejected your counter. ${prop.name} remains on the market.`, 'warning');
            }
            offerModal.style.display = 'none'; propertyToManageIndex = -1; currentOfferForProperty = null; updateAllUI(); 
        }
        function finalizeSale(propertyIndex, salePrice) { 
            const prop = player.properties[propertyIndex];
            const netCashFromSale = salePrice - prop.remainingLoan;
            player.cash += netCashFromSale;
            addLogEntry(`SOLD ${prop.name} for $${formatCurrency(salePrice)}. Net cash: $${formatCurrency(netCashFromSale)}.`);
            showModal("Property Sold!", `${prop.name} sold for $${formatCurrency(salePrice)}. Received $${formatCurrency(netCashFromSale)} after loan payoff.`, 'success');
            player.properties.splice(propertyIndex, 1); 
            propertyToManageIndex = -1; currentOfferForProperty = null;
            listSaleModal.style.display = 'none'; offerModal.style.display = 'none';
            updateAllUI(); saveGame();
        }

        externalLoanBtn.addEventListener('click', () => {
            externalLoanModalTitleEl.textContent = "Take External Loan";
            externalLoanAmountInputEl.value = ''; externalLoanEstPaymentEl.textContent = '0';
            externalLoanModal.style.display = 'block';
        });
        window.setExternalLoanAmount = function(amount) {
            externalLoanAmountInputEl.value = amount; updateExternalLoanEstPayment(); 
        }
        externalLoanAmountInputEl.addEventListener('input', updateExternalLoanEstPayment);
        function updateExternalLoanEstPayment() {
            const principal = parseFloat(externalLoanAmountInputEl.value) || 0;
            if (principal <=0) { externalLoanEstPaymentEl.textContent = '0'; return; }
            const avgMonthlyInterest = (EXTERNAL_LOAN_MIN_MONTHLY_INTEREST + EXTERNAL_LOAN_MAX_MONTHLY_INTEREST) / 2;
            const n = EXTERNAL_LOAN_TERM_MONTHS; let monthlyPayment;
            if (avgMonthlyInterest === 0) monthlyPayment = principal / n;
            else monthlyPayment = principal * (avgMonthlyInterest * Math.pow(1 + avgMonthlyInterest, n)) / (Math.pow(1 + avgMonthlyInterest, n) - 1);
            externalLoanEstPaymentEl.textContent = formatCurrency(monthlyPayment) + " (approx.)";
        }
        confirmExternalLoanBtn.onclick = function() {
            const principal = parseFloat(externalLoanAmountInputEl.value);
            if (isNaN(principal) || principal <= 0) { showModal("Invalid Amount", "Please enter a valid positive loan amount.", 'warning'); return; }
            if (principal > player.netWorth * 2 && principal > 50000) { showModal("Loan Too Large", "Lenders are hesitant to offer such a large loan.", 'warning'); return; }
            const monthlyInterestRate = EXTERNAL_LOAN_MIN_MONTHLY_INTEREST + Math.random() * (EXTERNAL_LOAN_MAX_MONTHLY_INTEREST - EXTERNAL_LOAN_MIN_MONTHLY_INTEREST);
            const n = EXTERNAL_LOAN_TERM_MONTHS; let monthlyPayment;
            if (monthlyInterestRate === 0) monthlyPayment = principal / n;
            else monthlyPayment = principal * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, n)) / (Math.pow(1 + monthlyInterestRate, n) - 1);
            monthlyPayment = Math.round(monthlyPayment);
            const newLoan = {
                id: `EXT${Date.now().toString().slice(-5)}`, principal: principal, remainingBalance: principal,
                monthlyInterestRate: monthlyInterestRate, monthlyPayment: monthlyPayment,
                termMonths: EXTERNAL_LOAN_TERM_MONTHS, monthsPaid: 0
            };
            player.externalLoans.push(newLoan); player.cash += principal;
            addLogEntry(`RISKY MOVE: Took an external loan of $${formatCurrency(principal)}. Monthly payment: $${formatCurrency(monthlyPayment)} for ${EXTERNAL_LOAN_TERM_MONTHS} months.`);
            showModal("External Loan Acquired", `You borrowed $${formatCurrency(principal)}. Good luck paying it back!`, 'warning');
            externalLoanModal.style.display = 'none'; updateAllUI(); saveGame();
        }
        cancelExternalLoanBtn.onclick = function() { externalLoanModal.style.display = 'none'; }

        function openLoanAdModal() {
            loanAdModalContentEl.className = 'modal-content'; 
            loanAdModalContentEl.classList.add('special-ad'); 
            loanAdModal.style.display = 'block';
        }
        loanAdTakeLoanBtn.onclick = function() { loanAdModal.style.display = 'none'; externalLoanBtn.click(); };
        loanAdDismissBtn.onclick = function() { loanAdModal.style.display = 'none'; };

        window.openJobApplicationConfirmModal = function(jobId) { 
            jobToApplyForId = jobId;
            const targetJob = JOBS.find(j => j.id === jobId);
            if (!targetJob) {
                console.error("Target job not found for confirmation:", jobId);
                return;
            }
            jobConfirmModalTitleEl.textContent = `Confirm Application: ${targetJob.title}`;
            jobConfirmDetailsEl.innerHTML = `
                <p><strong>Job Title:</strong> ${targetJob.title}</p>
                <p><strong>Field:</strong> ${targetJob.field}</p>
                <p><strong>Salary:</strong> $${formatCurrency(targetJob.salary)}/month</p>
            `;
            jobApplicationConfirmModal.style.display = 'block';
        }

        confirmJobApplicationBtn.onclick = function() {
            if (jobToApplyForId) {
                processJobApplication(jobToApplyForId);
            }
            jobApplicationConfirmModal.style.display = 'none';
            jobToApplyForId = null;
        }
        cancelJobApplicationBtn.onclick = function() {
            jobApplicationConfirmModal.style.display = 'none';
            jobToApplyForId = null;
        }

        function processJobApplication(jobId) { 
            const targetJob = JOBS.find(j => j.id === jobId);
            const currentPlayerJob = JOBS.find(j => j.id === player.currentJobId);
            if (!targetJob || !currentPlayerJob) {
                console.error("Job application error: Target or current job not found.");
                return;
            }

            let canApply = true; let reason = "";
            if (targetJob.prerequisites) {
                const currentJobField = currentPlayerJob.field; 
                if (targetJob.prerequisites.field && currentJobField !== targetJob.prerequisites.field && targetJob.level > 0) { 
                    canApply = false; reason = "Not in the required field for this level.";
                }
                if (canApply && targetJob.prerequisites.previousJobLevel !== undefined && currentPlayerJob.level < targetJob.prerequisites.previousJobLevel) { 
                    canApply = false; reason = `Requires a higher job level (current: ${currentPlayerJob.level}, needed: ${targetJob.prerequisites.previousJobLevel}).`;
                }
                if (canApply && targetJob.prerequisites.minExperienceInFieldMonths) { 
                    let experienceInTargetField = (currentJobField === targetJob.field) ? player.totalExperienceInFieldMonths : 0;
                    if (experienceInTargetField < targetJob.prerequisites.minExperienceInFieldMonths) {
                         canApply = false; reason = `Requires ${(targetJob.prerequisites.minExperienceInFieldMonths / 12).toFixed(1)} years experience in ${targetJob.field}. You have ${(experienceInTargetField / 12).toFixed(1)} in this field.`;
                    }
                }
            }
            if (!canApply) {
                showModal("Cannot Apply", `You do not meet the prerequisites for ${targetJob.title}. Reason: ${reason}`, 'warning'); return;
            }
            let successChance = JOB_APPLICATION_BASE_SUCCESS_CHANCE;
            if (targetJob.prerequisites && targetJob.prerequisites.minExperienceInFieldMonths) {
                const experienceInTargetField = (currentPlayerJob.field === targetJob.field) ? player.totalExperienceInFieldMonths : 0;
                const extraExperienceFactor = Math.max(0, (experienceInTargetField - targetJob.prerequisites.minExperienceInFieldMonths) / 12); 
                successChance += extraExperienceFactor * 0.05; 
            }
            if (targetJob.field === currentPlayerJob.field && targetJob.level === currentPlayerJob.level + 1) successChance += 0.15;
            successChance = Math.min(0.95, successChance); 

            if (Math.random() < successChance) {
                addLogEntry(`üéâ Got the job! You are now a ${targetJob.title} with a salary of $${formatCurrency(targetJob.salary)}.`);
                showModal("Application Successful!", `Congratulations! You've been hired as a ${targetJob.title}. Your new salary is $${formatCurrency(targetJob.salary)}.`, 'success');
                const oldJobField = currentPlayerJob.field;
                player.currentJobId = targetJob.id;
                player.salary = targetJob.salary;
                player.experienceInCurrentJobMonths = 0;
                if (oldJobField !== targetJob.field) { 
                    player.totalExperienceInFieldMonths = 0;
                }
            } else {
                addLogEntry(`Application for ${targetJob.title} was rejected.`);
                showModal("Application Unsuccessful", `Unfortunately, your application for ${targetJob.title} was not successful this time.`, 'warning');
            }
            generateJobOpportunities(); updateAllUI(); saveGame();
        }

        const SAVE_KEY = "propertyTycoonSaveData";

        function saveGame() {
            try {
                const gameState = {
                    player: player,
                    currentMonth: currentMonth,
                    gameLog: gameLog,
                    firstMonthAdvanced: firstMonthAdvanced,
                    availableProperties: availableProperties, // Save current market listings
                    availableJobs: availableJobs // Save current job listings
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
                // console.log("Game Saved!"); // Optional: for debugging
            } catch (e) {
                console.error("Error saving game:", e);
                showModal("Save Error", "Could not save game progress to local storage.", 'error');
            }
        }

        function loadGame() {
            try {
                const savedData = localStorage.getItem(SAVE_KEY);
                if (savedData) {
                    const gameState = JSON.parse(savedData);
                    
                    // Restore player object and ensure all nested objects/arrays are present
                    player = { ...player, ...gameState.player }; // Merge to preserve defaults if new fields added to player later
                    player.properties = gameState.player.properties || [];
                    player.externalLoans = gameState.player.externalLoans || [];

                    currentMonth = gameState.currentMonth;
                    gameLog = gameState.gameLog || ["Game loaded."];
                    firstMonthAdvanced = gameState.firstMonthAdvanced || false;
                    
                    availableProperties = gameState.availableProperties || []; // Restore market
                    availableJobs = gameState.availableJobs || []; // Restore jobs

                    if (firstMonthAdvanced && gameHeaderEl) {
                        gameHeaderEl.classList.add('header-hidden');
                    } else if (gameHeaderEl) {
                        gameHeaderEl.classList.remove('header-hidden');
                    }

                    addLogEntry("Game progress loaded successfully.");
                    console.log("Loaded player data:", JSON.parse(JSON.stringify(player))); // For debugging
                    return true; 
                }
            } catch (e) {
                console.error("Error loading game:", e);
                showModal("Load Error", "Could not load saved game. Starting a new game.", 'error');
                localStorage.removeItem(SAVE_KEY); 
            }
            return false; 
        }

        newLifeBtn.addEventListener('click', () => {
            resetConfirmModal.style.display = 'block';
        });

        confirmResetBtn.onclick = function() {
            localStorage.removeItem(SAVE_KEY);
            addLogEntry("Progress reset. Starting a new life!");
            showModal("New Life Started", "Your progress has been reset.", "info");
            resetConfirmModal.style.display = 'none';
            initializeGame(true); 
        }
        cancelResetBtn.onclick = function() {
            resetConfirmModal.style.display = 'none';
        }


        function updateAllUI() { 
            try {
                renderPlayerStats(); 
                renderPropertyListings(); 
                renderOwnedProperties(); 
                renderJobMarket(); 
                renderGameLog(); 
            } catch (e) {
                console.error("Error during updateAllUI:", e);
                const body = document.querySelector('body');
                if (body) { 
                    let errorDiv = document.getElementById('global-error-message');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.id = 'global-error-message';
                        errorDiv.style.position = 'fixed'; errorDiv.style.top = '10px'; errorDiv.style.left = '10px';
                        errorDiv.style.padding = '10px'; errorDiv.style.backgroundColor = 'red'; errorDiv.style.color = 'white';
                        errorDiv.style.zIndex = '2000';
                        errorDiv.textContent = 'A critical error occurred updating the game UI. Please check console.';
                        body.appendChild(errorDiv);
                    }
                }
            }
        }
        nextMonthBtn.addEventListener('click', advanceMonth);
        restartGameBtn.addEventListener('click', () => {
            gameOverOverlayEl.style.display = 'none';
            initializeGame(true); 
        });

        function initializeGame(forceNew = false) { 
            try {
                let gameWasLoaded = false;
                if (!forceNew) {
                    gameWasLoaded = loadGame();
                }

                if (gameWasLoaded) {
                    console.log("Game was loaded. Skipping full new game initialization.");
                    // Data is already loaded into global variables by loadGame()
                    // We might still need to refresh dynamic parts of the UI if they weren't saved/loaded
                    // For instance, if availableJobs and availableProperties were not part of the save, regenerate them:
                    if (!availableProperties || availableProperties.length === 0) generateNewProperties();
                    if (!availableJobs || availableJobs.length === 0) generateJobOpportunities();
                    updateAllUI();
                    return; 
                }

                console.log("Initializing a new game...");
                const startingJob = JOBS.find(j => j.id === "unskilled0");
                if (!startingJob) { 
                    console.error("CRITICAL ERROR: Starting job 'unskilled0' not found in JOBS array!");
                    alert("CRITICAL ERROR: Starting job definition missing. Game cannot start.");
                    return;
                }
                const deathAgeYears = 60 + Math.floor(Math.random() * 31); 
                const deathAgeMonths = deathAgeYears * 12;

                player = { 
                    ageMonths: 18 * 12, cash: INITIAL_CASH, 
                    currentJobId: "unskilled0", experienceInCurrentJobMonths: 0, totalExperienceInFieldMonths: 0,
                    salary: startingJob.salary, 
                    netWorth: INITIAL_CASH, properties: [], externalLoans: [],
                    deathAgeYears: deathAgeYears, 
                    deathAgeMonths: deathAgeMonths
                };
                availableProperties = []; availableJobs = [];
                gameLog = ["Game started. Good luck!"]; currentMonth = 0;
                firstMonthAdvanced = false; 
                selectedLoanTermMonths = AVAILABLE_LOAN_TERMS.find(t => t.years === 20).months;
                propertyToManageIndex = -1; currentOfferForProperty = null; jobToApplyForId = null;
                nextMonthBtn.disabled = false; nextMonthBtn.classList.remove('button-disabled'); nextMonthBtn.textContent = "Advance to Next Month";
                
                if (gameHeaderEl) { 
                    gameHeaderEl.classList.remove('header-hidden');
                }
                gameOverOverlayEl.style.display = 'none'; 

                generateNewProperties(); 
                generateJobOpportunities(); 
                updateAllUI();
                
                const initialJobTitle = startingJob.title;
                addLogEntry(`Welcome to Property Tycoon! Start with $${formatCurrency(INITIAL_CASH)} as ${initialJobTitle}. You will live to be ${player.deathAgeYears}.`);
                saveGame(); 
            } catch (e) {
                console.error("Error during initializeGame:", e);
                const body = document.querySelector('body');
                if (body) {
                    body.innerHTML = '<div style="color: red; padding: 20px; font-size: 1.2em;">Critical Error during Game Initialization. Please check the console and refresh.</div>';
                }
            }
        }
        window.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM fully loaded and parsed. Initializing game...');
            initializeGame();
        });
    </script>
</body>
</html>
