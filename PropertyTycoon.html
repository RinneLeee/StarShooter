<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- NEW GAME THEME --- */
        
        :root {
            --color-bg: #fdfbf6; /* Warm Cream */
            --color-container-bg: #ffffff;
            --color-card-bg: #fffefb;
            --color-ui-bg: #faf8f1; /* Parchment */
            --color-text-body: #374151; /* Dark Gray */
            --color-text-header: #065f46; /* Deep Emerald */
            --color-primary: #059669; /* Emerald */
            --color-primary-dark: #047857;
            --color-primary-light: #10b981;
            --color-accent-gold: #f59e0b; /* Amber */
            --color-accent-gold-dark: #d97706;
            --color-accent-gold-text: #422006;
            --color-danger: #dc2626; /* Red */
            --color-danger-dark: #b91c1c;
            --color-success: #16a34a; /* Green */
            --color-success-dark: #15803d;
            --color-border-light: #e0ddd0; /* Light border */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg); 
            color: var(--color-text-body); 
            padding-bottom: 100px; 
        }
        
        .game-container {
            max-width: 1380px; 
            margin: 20px auto;
            padding: 20px;
            background-color: var(--color-container-bg); 
            border-radius: 16px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
            border: 1px solid var(--color-border-light);
        }

        /* --- HEADER --- */
        #gameHeader {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
            max-height: 200px; 
            border-bottom: 2px solid var(--color-ui-bg);
        }
        #gameHeader h1 {
            font-family: 'Merriweather', serif;
            font-weight: 700;
            color: var(--color-text-header);
        }
        #gameHeader p {
            color: var(--color-text-body);
        }
        #gameHeader.header-hidden {
            max-height: 10px; 
            padding-top: 0; padding-bottom: 0; margin-bottom: 5px; 
            background-color: var(--color-primary); 
            cursor: pointer;
        }
        #gameHeader.header-hidden h1, 
        #gameHeader.header-hidden p { display: none; }
        #gameHeader.header-hidden:hover {
            max-height: 200px; 
            padding-top: 2rem; padding-bottom: 2rem; margin-bottom: 2.5rem; 
            background-color: transparent; 
        }
         #gameHeader.header-hidden:hover h1, 
         #gameHeader.header-hidden:hover p { display: block; }

        /* --- CARDS (Property, Job, Owned) --- */
        .card {
            background-color: var(--color-card-bg); 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.07); 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid var(--color-border-light); 
            position: relative; 
        }
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 18px rgba(0,0,0,0.1); 
        }
        .card.golden-opportunity { 
            border: 2px solid var(--color-accent-gold); 
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.6); 
            background: linear-gradient(135deg, #fefce8 0%, #fffbeb 100%);
        }
        .card.golden-opportunity::before {
            content: '‚≠ê Golden Opportunity!'; 
            position: absolute; top: -12px; left: 50%;
            transform: translateX(-50%); 
            background-color: var(--color-accent-gold); 
            color: var(--color-accent-gold-text); 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 0.8rem; font-weight: 700; z-index: 10;
        }
        .card h3 { 
            font-family: 'Merriweather', serif;
            font-size: 1.3rem; 
            font-weight: 700; 
            margin-bottom: 12px; 
            color: var(--color-text-header); 
        }
        .card p { font-size: 0.9rem; margin-bottom: 6px; color: #4b5563; }
        .card .price, .card .rent-estimate, .card .asking-price, .card .job-salary { 
            font-size: 1.05rem; font-weight: 700; 
            padding: 2px 6px; border-radius: 4px; display: inline-block;
        }
        .card .price { color: var(--color-success-dark); background-color: #f0fdf4; }
        .card .rent-estimate { color: #a21caf; background-color: #fdf2f8; } 
        .card .asking-price { color: var(--color-accent-gold-dark); background-color: #fffbeb; } 
        .card .job-salary { color: #1d4ed8; background-color: #eff6ff; } 

        /* --- NEW: DISASTER ICON --- */
        .disaster-icon {
            display: none; /* Hidden by default */
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.8rem; /* Make it noticeable */
            z-index: 10;
            animation: shake 0.5s infinite alternate;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .disaster-icon.active {
            display: block; /* Show when active */
        }

        @keyframes shake {
            0% { transform: rotate(-10deg); }
            100% { transform: rotate(10deg); }
        }
        /* --- END NEW ICON --- */


        /* --- NEW BUTTON THEME --- */
        .button {
            color: white; 
            padding: 10px 16px; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.15s ease-out;
            border: 1px solid rgba(0,0,0,0.1);
            border-bottom-width: 3px; /* Pressable effect */
            text-shadow: none; 
            box-shadow: 0 2px 3px rgba(0,0,0,0.08);
            font-size: 0.9rem;
            text-align: center;
        }
        .button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.12); 
            filter: brightness(1.05);
        }
        .button:active { 
            transform: translateY(0px); 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            border-bottom-width: 1px;
            filter: brightness(0.95);
        }
        
        .button-main-action { 
            padding: 12px 24px; font-size: 1.1rem; 
            background: linear-gradient(to bottom, var(--color-primary-light), var(--color-primary)); 
            border-color: var(--color-primary-dark);
        }
        .button-main-action:hover { background: linear-gradient(to bottom, #34d399, var(--color-primary)); }
        
        .button-external-loan { 
            background: linear-gradient(to bottom, var(--color-accent-gold), var(--color-accent-gold-dark)); 
            border-color: #b45309; 
        }
        .button-external-loan:hover { background: linear-gradient(to bottom, #fbbf24, var(--color-accent-gold-dark)); }
        
        .button-new-life { 
            background: linear-gradient(to bottom, #f87171, var(--color-danger)); 
            border-color: var(--color-danger-dark); 
        } 
        .button-new-life:hover { background: linear-gradient(to bottom, #fb923c, var(--color-danger)); }
        
        .button-secondary { 
            background: linear-gradient(to bottom, #9ca3af, #6b7280); 
            border-color: #4b5563; 
        } 
        .button-secondary:hover { background: linear-gradient(to bottom, #b0b8c4, #6b7280); }
        
        .button-buy { 
            background: linear-gradient(to bottom, #4ade80, var(--color-success)); 
            border-color: var(--color-success-dark); 
        } 
        .button-buy:hover { background: linear-gradient(to bottom, #86efac, var(--color-success)); }
        
        .button-list-sell { 
            background: linear-gradient(to bottom, #f472b6, #db2777); 
            border-color: #be185d; 
        } 
        .button-list-sell:hover { background: linear-gradient(to bottom, #f9a8d4, #db2777); }
        
        .button-rent { 
            background: linear-gradient(to bottom, #eab308, #ca8a04); 
            border-color: #a16207; 
        } 
        .button-rent:hover { background: linear-gradient(to bottom, #fde047, #ca8a04); }
        
        .button-renovate { 
            background: linear-gradient(to bottom, #a78bfa, #7c3aed); 
            border-color: #6d28d9; 
        } 
        .button-renovate:hover { background: linear-gradient(to bottom, #c4b5fd, #7c3aed); }
        
        .button-apply-job { 
            background: linear-gradient(to bottom, #6d28d9, #5b21b6); 
            border-color: #4c1d95; 
        } 
        .button-apply-job:hover { background: linear-gradient(to bottom, #8b5cf6, #5b21b6); }
        
        .button-marketing { 
            background: linear-gradient(to bottom, #60a5fa, #3b82f6); 
            border-color: #2563eb; 
        } 
        .button-marketing:hover { background: linear-gradient(to bottom, #93c5fd, #3b82f6); }
        
        .button-disabled { 
            background: #9ca3af; 
            cursor: not-allowed; text-shadow: none; 
            box-shadow: none; opacity: 0.7;
            border-color: #6b7280;
            border-bottom-width: 1px;
        }
        .button-disabled:hover { transform: none; box-shadow: none; filter: none; }
        
        /* --- UI SECTIONS --- */
        .section-title {
            font-family: 'Merriweather', serif;
            font-size: 1.75rem; 
            font-weight: 700; margin-bottom: 20px; 
            color: var(--color-text-header); 
            border-bottom: 3px solid var(--color-accent-gold); 
            padding-bottom: 8px;
        }
        
        /* --- NEW PLAYER STATS DESIGN --- */
        .player-stats { 
            background-color: var(--color-ui-bg); 
            padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.06); 
            margin-bottom: 2rem; 
            border: 1px solid var(--color-border-light);
        } 
        /* Override old .player-stats div styles */
        .player-stats div {
            background-color: transparent; 
            padding: 0; 
            border-radius: 0; 
            margin-bottom: 0; 
            font-size: inherit;
            border-left: none;  
        }
        .player-stats strong { 
            display: none; /* Hide old <strong> labels */
        } 
        /* New Stat Card styles */
        .stat-card {
            background-color: var(--color-card-bg); 
            padding: 1rem; /* MODIFIED: Increased padding from 12px */
            border-radius: 8px; 
            text-align: center;
            border: 1px solid var(--color-border-light);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-body);
            display: block;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value-container {
            display: flex;
            justify-content: center;
            align-items: baseline;
            gap: 6px;
            min-height: 2.8rem; /* MODIFIED: Increased for wrapped text */
        }
        .stat-value {
            font-family: 'Merriweather', serif;
            font-size: 1.6rem; /* Bigger */
            font-weight: 700;  /* Bolder */
            color: var(--color-text-header);
            line-height: 1.4; /* MODIFIED: Increased for wrapped text */
        }
        
        /* New styles for cash-change-indicator */
        #cash-change-indicator {
            font-size: 0.85rem;
            font-weight: 700;
            margin-left: 0; /* Remove old margin */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #cash-change-indicator.visible {
            opacity: 1;
        }
        #cash-change-indicator.profit {
            color: var(--color-success-dark);
        }
        #cash-change-indicator.loss {
            color: var(--color-danger-dark);
        }
        
        /* NEW: Stat Flip Animation */
        .stat-value.animated-flip {
            display: inline-block; /* Needed for transform */
            animation: flipIn 0.6s ease-out;
        }
        
        @keyframes flipIn {
            0% {
                transform: perspective(400px) rotateX(90deg);
                opacity: 0;
            }
            40% {
                transform: perspective(400px) rotateX(-20deg);
            }
            60% {
                transform: perspective(400px) rotateX(10deg);
            }
            80% {
                transform: perspective(400px) rotateX(-5deg);
            }
            100% {
                transform: perspective(400px) rotateX(0deg);
                opacity: 1;
            }
        }
        /* --- END NEW PLAYER STATS --- */

        <!-- MODIFICATION: Added new CSS classes for the refactored ledger -->
        /* --- NEW: Stat Card Text Sizing --- */
        .stat-value.stat-value-small-text {
            font-size: 1.25rem; /* Slightly smaller for long text */
            line-height: 1.4;
            font-family: 'Inter', sans-serif; /* Use Inter for better readability of long text */
            font-weight: 600;
        }
        .stat-value-container.stat-value-container-col {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0;
        }
        /* MODIFIED: Updated cash change indicator for new vertical layout */
        #cash-change-indicator {
            font-size: 0.9rem; /* Make this slightly larger */
            font-weight: 700;
            margin-left: 0; 
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.3s ease-out;
            transform: translateY(-5px); /* Start slightly up */
        }
        #cash-change-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* --- END NEW STAT CARD TEXT SIZING --- */


        #monthly-cashflow {
            /* MODIFIED: Removed border that looked bad */
            /* border: 1px solid var(--color-border-light); */
        }
        #monthly-cashflow p.text-slate-500 { color: #57534e; } /* rock-600 */
        #monthly-cashflow p.text-slate-700 { color: var(--color-text-body); }
        
        /* MODIFIED: Loan Section Toggle Styles */
        #loan-section-toggle.section-title {
            border-radius: 8px 8px 0 0;
            background-color: var(--color-ui-bg);
            border: 1px solid var(--color-border-light);
            border-bottom: none;
            margin-bottom: 0;
            padding: 1rem 1.5rem; 
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; /* MODIFIED */
            font-size: 1.5rem; /* MODIFIED: Made smaller than section-title */
            font-weight: 600; /* MODIFIED: Made lighter than section-title */
        }
        #loan-section-toggle.section-title:hover {
            background-color: #f4f2e9; /* MODIFIED: Stronger hover color */
            border-color: #cccab8; /* MODIFIED: Added hover border */
        }
        
        #loan-section-content {
            background-color: var(--color-ui-bg);
            border: 1px solid var(--color-border-light);
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        #loan-section-content h3 {
            font-family: 'Merriweather', serif;
        }

        /* --- GAME LOG --- */
        .game-log { 
            background-color: var(--color-ui-bg); 
            border-radius: 8px; 
            padding: 10px; 
            border: 1px solid var(--color-border-light);
            font-family: 'Roboto Mono', monospace;
        }
        .game-log li { 
            padding: 8px 12px; 
            border-bottom: 1px dashed var(--color-border-light); 
            font-size: 0.875rem; 
        }
        .game-log li:last-child { border-bottom: none; }
        
        /* --- TABS --- */
        .tab-button.border-indigo-600 {
            border-color: var(--color-primary) !important;
            color: var(--color-primary) !important;
        }
        .tab-button.text-slate-600 {
            color: #57534e !important;
        }
        .tab-button.hover\:text-indigo-600:hover {
            color: var(--color-primary) !imporA-nt;
        }
        
        /* Market/Job/Portfolio list backgrounds */
        #property-listings, #job-market-listings, #owned-properties {
            background-color: var(--color-ui-bg);
            border: 1px solid var(--color-border-light);
        }
        .text-slate-500 { color: #57534e; }

        /* --- STATUS COLORS --- */
        .property-status { font-weight: 600; } 
        .status-rented { color: var(--color-success); }
        .status-listed-rent { color: var(--color-accent-gold); } 
        .status-vacant { color: #6b7280; }
        .status-delinquent { color: var(--color-danger); font-weight: 700; } 
        .status-listed-sale { color: #db2777; font-weight: 700; } 
        .condition-good { color: var(--color-success); }
        .condition-fair { color: var(--color-accent-gold); }
        .condition-poor { color: var(--color-danger); }

        /* --- MODALS --- */
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(5px);  
        }
        .modal-content { 
            background-color: var(--color-card-bg); 
            margin: 8% auto; padding: 28px; 
            border: 1px solid var(--color-border-light); 
            width: 90%; max-width: 550px; border-radius: 12px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.25); 
        }
        .modal-content h2 { 
            font-family: 'Merriweather', serif;
            font-size: 1.5rem; font-weight: 700; 
            margin-bottom: 20px; text-align: center; 
            color: var(--color-text-header);
        }
        .modal-content p { font-size: 1rem; margin-bottom: 12px; }
        .modal-content .details p { margin-bottom: 6px; font-size: 0.9rem;}
        .modal-input { 
            width: 100%; padding: 10px; margin-bottom: 12px; 
            border: 1px solid #94a3b8; border-radius: 6px; 
            box-sizing: border-box; 
            background-color: #f8fafc;
        }
        .modal-buttons { display: flex; justify-content: space-around; margin-top: 24px; gap: 10px; }
        
        /* Modal button base class */
        .modal-button { 
            flex: 1;
            color: white; 
            padding: 12px 18px; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.15s ease-out;
            border: 1px solid rgba(0,0,0,0.1);
            border-bottom-width: 3px;
            text-shadow: none; 
            box-shadow: 0 2px 3px rgba(0,0,0,0.08);
            font-size: 0.95rem;
        }
        .modal-button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.12); 
            filter: brightness(1.05);
        }
        .modal-button:active {
            transform: translateY(0px); 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            border-bottom-width: 1px;
            filter: brightness(0.95);
        }
        
        /* Message Modal Contexts */
        #messageModal .modal-content { border-top: 6px solid; }
        #messageModal .modal-content.modal-success { background-color: #f0fdf4; border-top-color: var(--color-success); }
        #messageModal .modal-content.modal-success h2 { color: var(--color-success-dark); }
        #messageModal .modal-content.modal-success .modal-button { background: linear-gradient(to bottom, #4ade80, var(--color-success)); border-color: var(--color-success-dark); }
        
        #messageModal .modal-content.modal-error { background-color: #fef2f2; border-top-color: var(--color-danger); }
        #messageModal .modal-content.modal-error h2 { color: var(--color-danger-dark); }
        #messageModal .modal-content.modal-error .modal-button { background: linear-gradient(to bottom, #f87171, var(--color-danger)); border-color: var(--color-danger-dark); }
        
        #messageModal .modal-content.modal-warning { background-color: #fffbeb; border-top-color: var(--color-accent-gold); }
        #messageModal .modal-content.modal-warning h2 { color: #b45309; }
        #messageModal .modal-content.modal-warning .modal-button { background: linear-gradient(to bottom, var(--color-accent-gold), var(--color-accent-gold-dark)); border-color: #b45309; }
        
        #messageModal .modal-content.modal-info { background-color: #eff6ff; border-top-color: #3b82f6; } 
        #messageModal .modal-content.modal-info h2 { color: #1d4ed8; }
        #messageModal .modal-content.modal-info .modal-button { background: linear-gradient(to bottom, #60a5fa, #3b82f6); border-color: #2563eb; }
        
        /* Other Modal Buttons */
        .modal-confirm-button, .modal-accept-offer-button { background: linear-gradient(to bottom, #4ade80, var(--color-success)); border-color: var(--color-success-dark); }
        .modal-counter-offer-button { background: linear-gradient(to bottom, var(--color-accent-gold), var(--color-accent-gold-dark)); border-color: #b45309; }
        .modal-cancel-button { background: linear-gradient(to bottom, #9ca3af, #6b7280); border-color: #4b5563; }
        
        /* NEW: Flipping Penalty Modal Button */
        #confirmFlippingSaleBtn { background: linear-gradient(to bottom, #f87171, var(--color-danger)); border-color: var(--color-danger-dark); }

        .loan-term-option { margin-bottom: 12px; }
        .loan-term-option label { margin-left: 10px; font-size: 0.95rem; }
        #sellModalOfferDetails p { margin-bottom: 8px; }
        .quick-loan-buttons button { margin: 0 5px; }

        /* --- BOTTOM ACTION BAR --- */
        .fixed-action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 0; 
            background-color: rgba(253, 251, 246, 0.9); /* semi-transparent cream */
            backdrop-filter: blur(8px); 
            text-align: center; z-index: 1001; 
            border-top: 1px solid var(--color-border-light);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
        }
        .fixed-action-bar button { margin-left: 8px; margin-right: 8px; } 

        /* --- SPECIAL MODALS --- */
        #loanAdModal .modal-content {
            background: linear-gradient(135deg, #fef9c3 0%, #fde68a 100%); 
            border: 3px solid #facc15; color: #713f12; 
        }
        #loanAdModal .modal-content h2 { 
            font-family: 'Merriweather', serif;
            color: #a16207; font-size: 1.6rem; 
            text-shadow: 1px 1px 2px rgba(255,255,255,0.6); 
        }
        #loanAdModal .modal-content .modal-button.modal-confirm-button { background: linear-gradient(to bottom, #eab308, #ca8a04); border-color: #a16207; }
        #loanAdModal .modal-content .modal-button.modal-cancel-button { background: linear-gradient(to bottom, #a16207, #713f12); border-color: #422006; }

        /* --- GAME OVER --- */
        .game-over-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(40, 40, 40, 0.9); z-index: 2000; 
            backdrop-filter: blur(5px);
            color: white; text-align: center; justify-content: center;
            align-items: center; flex-direction: column; 
        }
        .game-over-overlay h2 { 
            font-family: 'Merriweather', serif;
            font-size: 3.5rem; font-weight: bold; 
            margin-bottom: 20px; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: #f87171; /* Light Red */
        }
        .game-over-overlay p { font-size: 1.25rem; margin-bottom: 30px; }
        .game-over-overlay .button-restart { 
            padding: 15px 30px; font-size: 1.25rem; 
            /* Re-use main button style */
            background: linear-gradient(to bottom, #4ade80, var(--color-success)); 
            border-color: var(--color-success-dark);
        }
        .game-over-overlay .button-restart:hover { background: linear-gradient(to bottom, #86efac, var(--color-success)); }
    
        /* --- COLLAPSIBLE SECTION --- */
        #loan-section-toggle {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        #loan-section-toggle::after {
            content: '‚ñº Click to collapse'; /* MODIFIED: More explicit text */
            font-size: 0.9rem; /* MODIFIED: Matched font size */
            position: absolute;
            right: 1.5rem; 
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.2s ease-in-out; /* MODIFIED */
            color: var(--color-primary); /* MODIFIED */
            font-weight: 600; /* MODIFIED */
            font-family: 'Inter', sans-serif; /* MODIFIED */
        }
        #loan-section-toggle.collapsed::after {
            content: '‚ñ∫ Click to expand'; /* MODIFIED: More explicit text */
            transform: translateY(-50%); /* MODIFIED: Removed rotation */
            color: var(--color-text-body); /* MODIFIED */
            font-weight: 500; /* MODIFIED */
        }
        #loan-section-content {
            max-height: 500px; /* arbitrary large value */
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
            padding: 1rem; /* p-4 */
            margin-top: -1px; /* Overlap with title border */
            opacity: 1;
        }
        #loan-section-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
            opacity: 0;
        }

        /* --- CASH INDICATOR --- */
        /* This ID is now styled in the .player-stats section */

    </style>
</head>

<body class="p-4 md:p-8">

    <div class="game-container">
        <header id="gameHeader" class="mb-10 text-center"> 
            <h1 class="text-5xl font-bold">Property Tycoon</h1>
            <p class="text-xl mt-2">Your Journey to Real Estate Riches!</p>
        </header>

        <section class="player-stats"> 
            <div class="flex justify-between items-center mb-5">
                <h2 class="section-title !mb-0 !border-b-0 !pb-0">Your Ledger</h2>
                <button id="new-life-btn" class="button button-new-life mb-4">Start New Life</button>
            </div>
            <!-- 
                MODIFICATION: 
                Changed grid from "lg:grid-cols-7" to "lg:grid-cols-4 xl:grid-cols-7"
                This makes it 2-col (mobile), 3-col (sm), 4-col (lg), and 7-col (xl)
                This provides a much-needed intermediate step for standard laptop/desktop screens.
            -->
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-4"> 
                <div class="stat-card">
                    <span class="stat-label">Age</span>
                    <div class="stat-value-container">
                        <!-- MODIFICATION: Added stat-value-small-text for better wrapping -->
                        <span class="stat-value stat-value-small-text" id="player-age">18 years</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Cash</span>
                    <!-- MODIFICATION: Added stat-value-container-col for vertical layout -->
                    <div class="stat-value-container stat-value-container-col">
                        <span class="stat-value" id="player-cash">$20,000</span>
                        <span id="cash-change-indicator">($0)</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Job</span>
                    <div class="stat-value-container">
                        <!-- MODIFICATION: Added stat-value-small-text for better wrapping -->
                        <span class="stat-value stat-value-small-text" id="player-job-title">Unskilled Labor</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Salary (Monthly)</span>
                    <div class="stat-value-container">
                        <span class="stat-value" id="player-salary">$1,200</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Net Worth</span>
                    <div class="stat-value-container">
                        <span class="stat-value" id="player-net-worth">$20,000</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Annual Inflation</span>
                    <div class="stat-value-container">
                        <span class="stat-value" id="current-inflation-rate">0.0%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Market Status</span>
                    <div class="stat-value-container">
                        <span class="stat-value" id="current-market-status">Normal</span>
                    </div>
                </div>
                </div>
        </section>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 mt-8">
            
            <section class="lg:col-span-2">
                
                <section id="monthly-cashflow" class="mb-6">
                     <h2 class="section-title pl-4">Monthly Cashflow</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-white rounded-lg shadow-lg">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Total Income</p>
                            <p id="cashflow-income" class="text-2xl font-bold text-green-600">$0</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-slate-500">Total Expenses</p>
                            <p id="cashflow-expenses" class="text-2xl font-bold text-red-600">-$0</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-slate-500">Net Monthly</p>
                            <p id="cashflow-net" class="text-2xl font-bold text-slate-700">$0</p>
                        </div>
                    </div>
                </section>
				
				
				<section id="loan-section" class="mb-6">
                    <h2 id="loan-section-toggle" class="section-title">
                        Request a Loan
                    </h2>
                    <div id="loan-section-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-lg font-semibold text-emerald-700 mb-2">Conventional Bank Loan</h3>
                            <p class="text-sm text-slate-600 mb-3">50% success chance. Requires a non-refundable application fee. If rejected, you must wait 3 months to re-apply.</p>
                            <button id="bank-loan-btn" class="button button-main-action w-full">Apply for Bank Loan</button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-red-700 mb-2">Risky Cash Loan</h3>
                            <p class="text-sm text-slate-600 mb-3">Guaranteed approval, but comes with a dangerously high, unknown interest rate. Repaid over 36 months. It might be risky!</p>
                            <button id="external-loan-btn" class="button button-external-loan w-full">Get Risky Cash Loan</button>
                        </div>
                    </div>
                </section>
                
                <div class="flex border-b border-slate-300 mb-4">
                    <button id="tab-btn-market" class="tab-button -mb-px border-b-2 py-3 px-6 font-semibold transition-colors duration-150 border-indigo-600 text-indigo-600">
                        Property Market
                    </button>
                    <button id="tab-btn-jobs" class="tab-button -mb-px border-b-2 py-3 px-6 font-semibold transition-colors duration-150 text-slate-600 hover:text-indigo-600 border-transparent">
                        Job Market
                    </button>
                </div>

                <div id="tab-panel-market" style="display: none;">
                    <h2 class="section-title">Property Market Listings</h2>
                    <div id="property-listings" class="space-y-5 max-h-[800px] overflow-y-auto p-3 rounded-lg">
                        <p class="text-slate-500 text-center py-12">No properties listed this month. Click "Next Month".</p>
                    </div>
                </div>

                <div id="tab-panel-jobs" style="display: none;">
                    <h2 class="section-title">Job Market</h2>
                    <div id="job-market-listings" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5 max-h-[800px] overflow-y-auto p-3 rounded-lg">
                         <p class="text-slate-500 text-center py-12 col-span-full">No job openings this month. Check back later!</p>
                    </div>
                </div>
                
            </section>
            
            <section class="lg:col-span-1 space-y-10"> 
                <section> 
                    <h2 class="section-title">Activity Log</h2>
                    <ul id="game-log" class="list-none p-3 game-log max-h-56 overflow-y-auto">
                        <li class="text-slate-500">Game started. Good luck!</li>
                    </ul>
                </section>

                <section> 
                    <h2 class="section-title">Your Portfolio</h2>
                    <div id="owned-properties" class="grid grid-cols-1 gap-5 max-h-[800px] overflow-y-auto p-3 rounded-lg"> 
                        <p class="text-slate-500 text-center py-12 col-span-full" id="no-owned-properties-msg">You don't own any properties yet.</p> 
                    </div>
                </section>
            </section>
        </div>

    </div>

    <div class="fixed-action-bar">
        <button id="next-month-btn" class="button button-main-action">Advance to Next Month</button>
    </div>

    <div id="messageModal" class="modal"><div class="modal-content modal-info"><h2 id="modalTitle">Notification</h2><p id="modalMessage">Msg</p><div class="modal-buttons"><button id="modalCloseBtn" class="modal-button">OK</button></div></div></div>
    
    <div id="renovationModal" class="modal"><div class="modal-content">
        <h2 id="renovationModalTitle">Renovate</h2>
        <p id="renovationModalText" class="text-lg mb-2">Current Condition: 0%</p>
        <p id="renovationModalInfo" class="text-sm text-slate-600 mb-4">Select a renovation option. Costs are based on property value.</p>
        
        <div id="renovationButtonContainer" class="space-y-3">
             <button id="renovate10Btn" class="button button-renovate w-full text-left p-4">
                <strong>Repair 10%</strong><br>
                <span id="renovate10Cost" class="text-xs font-normal">Cost: $0</span>
             </button>
             <button id="renovate20Btn" class="button button-renovate w-full text-left p-4">
                <strong>Repair 20%</strong><br>
                <span id="renovate20Cost" class="text-xs font-normal">Cost: $0</span>
             </button>
             <button id="renovateMaxBtn" class="button button-buy w-full text-left p-4">
                <strong>Repair to 100%</strong> (Repair <span id="renovateMaxPercent">0</span>%)<br>
                <span id="renovateMaxCost" class="text-xs font-normal">Cost: $0</span>
             </button>
        </div>

        <div class="modal-buttons">
            <button id="cancelRenovationBtn" class="modal-button modal-cancel-button">Cancel</button>
        </div>
    </div></div>

    <div id="loanTermModal" class="modal"><div class="modal-content"><h2 id="loanTermModalTitle">Select Loan</h2><div id="loanPropertyDetails" class="details mb-4"></div><p>Choose duration:</p><div id="loanTermOptionsContainer" class="my-4"></div><p><strong>Monthly Payment:</strong> $<span id="loanTermSelectedPayment">0</span></p><div class="modal-buttons"><button id="confirmLoanBtn" class="modal-button modal-confirm-button">Confirm</button><button id="cancelLoanBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="listSaleModal" class="modal"><div class="modal-content"><h2 id="listSaleModalTitle">List Property</h2><div id="listSalePropertyInfo" class="details mb-3"></div><p><strong>Market Value:</strong> $<span id="listSaleMarketValue">0</span></p><div><label for="askingPriceInput" class="block mb-1 font-medium">Asking Price:</label><input type="number" id="askingPriceInput" class="modal-input" placeholder="Desired price"></div><div class="modal-buttons"><button id="confirmListSaleBtn" class="modal-button modal-confirm-button">List</button><button id="cancelListSaleBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="offerModal" class="modal"><div class="modal-content"><h2 id="offerModalTitle">Offer Received!</h2><div id="offerPropertyInfo" class="details mb-3"></div><div id="offerModalDetails" class="mb-3"><p><strong>Asking:</strong> $<span id="offerAskingPrice">0</span></p><p><strong>Buyer's Offer:</strong> $<span id="offerBuyerOfferValue">0</span></p></div><div id="offerModalCounterOfferSection" class="mb-3"><label for="offerCounterInput" class="block mb-1 font-medium">Your Counter:</label><input type="number" id="offerCounterInput" class="modal-input" placeholder="Counter price"></div><div class="modal-buttons"><button id="acceptOfferBtn" class="modal-button modal-accept-offer-button">Accept</button><button id="submitOfferCounterBtn" class="modal-button modal-counter-offer-button">Counter</button><button id="rejectOfferBtn" class="modal-button modal-cancel-button">Reject</button></div></div></div>
    
    <div id="flippingPenaltyModal" class="modal"><div class="modal-content modal-warning">
        <h2 id="flippingPenaltyModalTitle">Hefty Flipping Penalty!</h2>
        <p id="flippingPenaltyMessage" class="text-lg mb-4">Warning: Selling this property so soon will incur a hefty penalty. Do you want to proceed?</p>
        <div class="modal-buttons">
            <button id="confirmFlippingSaleBtn" class="modal-button">Yes, Sell & Pay Penalty</button>
            <button id="cancelFlippingSaleBtn" class="modal-button modal-cancel-button">Cancel Sale</button>
        </div>
    </div></div>

    <div id="externalLoanModal" class="modal"><div class="modal-content"><h2 id="externalLoanModalTitle">Take Risky Cash Loan</h2><p>Guaranteed cash, repaid over 36 months. The high interest rate is unknown until you accept. This is very risky!</p><div><label for="externalLoanAmountInput" class="block mb-1 font-medium">Loan Amount:</label><input type="number" id="externalLoanAmountInput" class="modal-input" placeholder="Enter amount"></div><div class="quick-loan-buttons text-center mb-4"><button class="button button-secondary" onclick="setExternalLoanAmount(10000)">$10,000</button><button class="button button-secondary" onclick="setExternalLoanAmount(50000)">$50,000</button><button class="button button-secondary" onclick="setExternalLoanAmount(100000)">$100,000</button></div><p>Estimated Monthly Payment: $<span id="externalLoanEstPayment">0</span> (approx.)</p><div class="modal-buttons"><button id="confirmExternalLoanBtn" class="modal-button modal-confirm-button">Take Loan</button><button id="cancelExternalLoanBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    
    <div id="bankLoanModal" class="modal"><div class="modal-content"><h2 id="bankLoanModalTitle">Apply for Bank Loan</h2><p>Bank loans have a <strong>50% success rate</strong> and are repaid over <strong>60 months (5 years)</strong> at a fixed <strong>8% annual interest</strong>.</p><p>You must have at least one property as collateral.</p><p id="bankLoanFeeText">A non-refundable application fee of <strong>$500</strong> will be charged.</p><div><label for="bankLoanAmountInput" class="block mb-1 font-medium">Loan Amount:</label><input type="number" id="bankLoanAmountInput" class="modal-input" placeholder="Enter desired amount"></div><p>Estimated Monthly Payment: $<span id="bankLoanEstPayment">0</span></p><div class="modal-buttons"><button id="confirmBankLoanBtn" class="modal-button modal-confirm-button">Pay Fee & Apply</button><button id="cancelBankLoanBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>

    <div id="loanAdModal" class="modal"><div class="modal-content"> <h2 id="loanAdModalTitle">üí∞ Feeling Lucky? Need Quick Cash? üí∞</h2><p id="loanAdModalMessage">A unique opportunity for a risky cash loan has presented itself! Fast cash, fast terms. What could go wrong?</p><div class="modal-buttons"><button id="loanAdTakeLoanBtn" class="modal-button modal-confirm-button">Explore Loan Options!</button><button id="loanAdDismissBtn" class="modal-button modal-cancel-button">No, Thanks</button></div></div></div>
    <div id="jobApplicationConfirmModal" class="modal"><div class="modal-content"><h2 id="jobConfirmModalTitle">Confirm Job Application</h2><div id="jobConfirmDetails" class="details mb-4"></div><p>Are you sure you want to apply for this position?</p><div class="modal-buttons"><button id="confirmJobApplicationBtn" class="modal-button modal-confirm-button">Confirm Application</button><button id="cancelJobApplicationBtn" class="modal-button modal-cancel-button">Cancel</button></div></div></div>
    <div id="resetConfirmModal" class="modal"><div class="modal-content"><h2 id="resetConfirmModalTitle">Start New Life?</h2><p>All current progress will be reset. Are you sure?</p><div class="modal-buttons"><button id="confirmResetBtn" class="modal-button modal-confirm-button">Yes, Reset</button><button id="cancelResetBtn" class="modal-button modal-cancel-button">No, Cancel</button></div></div></div>
    
    <div id="evictTenantModal" class="modal"><div class="modal-content">
        <h2 id="evictTenantModalTitle">Manage Rental</h2>
        <div id="evictTenantPropertyInfo" class="details mb-4"></div>
        <p>Are you sure you want to evict the current tenant? There is a 1-in-5 chance they will damage the property on their way out!</p>
        <div class="modal-buttons">
            <button id="confirmEvictBtn" class="button button-new-life">Evict Tenant</button>
            <button id="cancelEvictBtn" class="modal-button modal-cancel-button">Cancel</button>
        </div>
    </div></div>

    <div id="marketingConfirmModal" class="modal"><div class="modal-content">
        <h2 id="marketingConfirmModalTitle">Confirm Marketing Campaign</h2>
        <div id="marketingConfirmPropertyInfo" class="details mb-4"></div>
        <p id="marketingConfirmDetails" class="mb-2">Details about the campaign...</p>
        <p class="text-lg font-bold mb-4"><strong>Fee:</strong> <span id="marketingConfirmFee">$0</span></p>
        <div class="modal-buttons">
            <button id="confirmMarketingBtn" class="modal-button modal-confirm-button">Start Campaign</button>
            <button id="cancelMarketingBtn" class="modal-button modal-cancel-button">Cancel</button>
        </div>
    </div></div>

    <div id="gameOverOverlay" class="game-over-overlay"><div> <h2 id="gameOverTitle">Game Over</h2><p id="gameOverMessage">Your journey has come to an end.</p><button id="restartGameBtn" class="button button-restart">Restart Game</button></div></div>

    <script>
	
	// CORE DATA DEFINITIONS AT THE TOP
        // *** MODIFIED: These are now the BASE definitions. We will copy them into a mutable state. ***
        // *** MODIFIED: Added priceTier for new property generation logic ***
        const PROPERTY_TYPES = [ 
			// --- Affordable Properties (Tier 1: < 1M) ---
			{ name: "Studio Apartment", basePrice: 80000, priceRange: 70000, baseRentability: 0.7, priceTier: 1 },
			{ name: "Compact Loft", basePrice: 95000, priceRange: 85000, baseRentability: 0.72, priceTier: 1 },
			{ name: "Suburban Flat", basePrice: 120000, priceRange: 100000, baseRentability: 0.75, priceTier: 1 },
			{ name: "2-Bedroom Condo", basePrice: 150000, priceRange: 150000, baseRentability: 0.8, priceTier: 1 },
			{ name: "Townhouse", basePrice: 250000, priceRange: 250000, baseRentability: 0.75, priceTier: 1 },
			{ name: "Suburban Duplex", basePrice: 320000, priceRange: 200000, baseRentability: 0.8, priceTier: 1 },
			{ name: "Detached House", basePrice: 400000, priceRange: 400000, baseRentability: 0.85, priceTier: 1 },
			{ name: "Gated Community Home", basePrice: 550000, priceRange: 300000, baseRentability: 0.82, priceTier: 1 },
			{ name: "Riverside Bungalow", basePrice: 750000, priceRange: 400000, baseRentability: 0.78, priceTier: 1 },

			// --- Mid-Range & Upscale (Tier 2: 1M - 10M) ---
			{ name: "Luxury Penthouse", basePrice: 750000, priceRange: 1250000, baseRentability: 0.6, priceTier: 2 },
			{ name: "Commercial Retail Unit", basePrice: 600000, priceRange: 500000, baseRentability: 0.65, priceTier: 2 },
			{ name: "Historic Building", basePrice: 800000, priceRange: 1000000, baseRentability: 0.5, priceTier: 2 },
			{ name: "Beachfront Villa", basePrice: 1500000, priceRange: 2000000, baseRentability: 0.7, priceTier: 2 },
			{ name: "Countryside Estate", basePrice: 2500000, priceRange: 1500000, baseRentability: 0.68, priceTier: 2 },
			{ name: "Urban Mixed-Use Block", basePrice: 3000000, priceRange: 2000000, baseRentability: 0.6, priceTier: 2 },
			{ name: "Skyscraper Office Floor", basePrice: 3000000, priceRange: 4000000, baseRentability: 0.55, priceTier: 2 },
			{ name: "Private Golf Villa", basePrice: 4000000, priceRange: 3000000, baseRentability: 0.65, priceTier: 2 },
			{ name: "Hilltop Mansion", basePrice: 5500000, priceRange: 4500000, baseRentability: 0.58, priceTier: 2 },
			{ name: "Downtown Business Tower", basePrice: 7500000, priceRange: 5000000, baseRentability: 0.6, priceTier: 2 },
			{ name: "Ultra-Luxury Seaview Penthouse", basePrice: 9000000, priceRange: 6000000, baseRentability: 0.55, priceTier: 2 },

			// --- Ultra-High-End (Tier 3: 10M+) ---
			{ name: "Mega Luxury Estate", basePrice: 12000000, priceRange: 8000000, baseRentability: 0.5, priceTier: 3 },
			{ name: "Private Island Villa", basePrice: 25000000, priceRange: 15000000, baseRentability: 0.48, priceTier: 3 },
			{ name: "Corporate Skyscraper", basePrice: 40000000, priceRange: 30000000, baseRentability: 0.52, priceTier: 3 },
			{ name: "Exclusive Marina Development", basePrice: 60000000, priceRange: 25000000, baseRentability: 0.5, priceTier: 3 },
			{ name: "Royal Heritage Palace", basePrice: 100000000, priceRange: 50000000, baseRentability: 0.45, priceTier: 3 }
		];


        const JOB_FIELDS = {
            UNSKILLED: "General Labor", IT: "Information Technology", HEALTHCARE: "Healthcare",
            BUSINESS: "Business & Finance", SERVICE: "Service Industry", LEGAL: "Legal", MEDICAL: "Medical",
            // *** NEW: Added new fields from your job list ***
            ENGINEERING: "Engineering", EDUCATION: "Education", MEDIA: "Creative / Media",
            TRADES: "Skilled Trades", GOVERNMENT: "Government", ARTS: "Arts", ENTREPRENEURSHIP: "Entrepreneurship"
        };
        
        const JOBS = [
            // General
            { id: "unskilled0", title: "Unskilled Labor", field: JOB_FIELDS.UNSKILLED, level: 0, salary: 1200, annualIncrementPercent: 0.01, prerequisites: null, promotionChanceMonths: 24, promotionChance: 0.1, promotionTo: "it0" },
            
            // IT Track
            { id: "it0", title: "IT Intern", field: JOB_FIELDS.IT, level: 0, salary: 2200, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.3, promotionTo: "it1" },
            { id: "it1", title: "Junior IT Support", field: JOB_FIELDS.IT, level: 1, salary: 3000, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 6 }, promotionChanceMonths: 18, promotionChance: 0.25, promotionTo: "it2" },
            { id: "it2", title: "IT Support Specialist", field: JOB_FIELDS.IT, level: 2, salary: 4200, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 18 }, promotionChanceMonths: 24, promotionChance: 0.2, promotionTo: "it3" },
            { id: "it3", title: "Senior IT Engineer", field: JOB_FIELDS.IT, level: 3, salary: 6500, annualIncrementPercent: 0.05, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 36 }, promotionChanceMonths: 36, promotionChance: 0.15, promotionTo: "it4" }, 
            { id: "it4", title: "IT Manager", field: JOB_FIELDS.IT, level: 4, salary: 9000, annualIncrementPercent: 0.03, companyAnnualBonusChance: 0.6, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.IT, minExperienceInFieldMonths: 60 }, firingRisk: 0.005 },
            
            // Healthcare (Nursing) Track
            { id: "health0", title: "Hospital Volunteer", field: JOB_FIELDS.HEALTHCARE, level: 0, salary: 1900, annualIncrementPercent: 0.01, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.25, promotionTo: "health1"},
            { id: "health1", title: "Nursing Assistant", field: JOB_FIELDS.HEALTHCARE, level: 1, salary: 2800, annualIncrementPercent: 0.025, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 6 }, promotionChanceMonths: 18, promotionChance: 0.2, promotionTo: "health2" },
            { id: "health2", title: "Registered Nurse", field: JOB_FIELDS.HEALTHCARE, level: 2, salary: 4500, annualIncrementPercent: 0.035, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 24 }, promotionChanceMonths: 30, promotionChance: 0.15, promotionTo: "health3" },
            { id: "health3", title: "Senior Nurse Practitioner", field: JOB_FIELDS.HEALTHCARE, level: 3, salary: 7000, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 48 }, promotionChanceMonths: 36, promotionChance: 0.1, promotionTo: "health4" },
            { id: "health4", title: "Chief Nursing Officer", field: JOB_FIELDS.HEALTHCARE, level: 4, salary: 10000, annualIncrementPercent: 0.02, companyAnnualBonusChance: 0.7, companyAnnualBonusPercent: 0.12, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.HEALTHCARE, minExperienceInFieldMonths: 72 }, firingRisk: 0.005 },
            
            // Business Track
            { id: "biz0", title: "Office Intern", field: JOB_FIELDS.BUSINESS, level: 0, salary: 2000, annualIncrementPercent: 0.015, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.3, promotionTo: "biz1" },
            { id: "biz1", title: "Junior Accountant", field: JOB_FIELDS.BUSINESS, level: 1, salary: 3200, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 24, promotionChance: 0.2, promotionTo: "biz2" },
            { id: "biz2", title: "Financial Analyst", field: JOB_FIELDS.BUSINESS, level: 2, salary: 5000, annualIncrementPercent: 0.045, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 24 }, promotionChanceMonths: 30, promotionChance: 0.15, promotionTo: "biz3" },
            { id: "biz3", title: "Finance Manager", field: JOB_FIELDS.BUSINESS, level: 3, salary: 8000, annualIncrementPercent: 0.00, companyAnnualBonusChance: 0.7, companyAnnualBonusPercent: 0.15, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 48 }, promotionChanceMonths: 36, promotionChance: 0.1, promotionTo: "biz4", firingRisk: 0.005 },
            { id: "biz4", title: "Chief Financial Officer (CFO)", field: JOB_FIELDS.BUSINESS, level: 4, salary: 12000, annualIncrementPercent: 0.00, companyAnnualBonusChance: 0.8, companyAnnualBonusPercent: 0.20, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.BUSINESS, minExperienceInFieldMonths: 72 }, firingRisk: 0.01 },
            
            // Service Track
            { id: "serv0", title: "Barista Trainee", field: JOB_FIELDS.SERVICE, level: 0, salary: 2000, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 6, promotionChance: 0.4, promotionTo: "serv1" },
            { id: "serv1", title: "Shift Supervisor", field: JOB_FIELDS.SERVICE, level: 1, salary: 2800, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.SERVICE, minExperienceInFieldMonths: 6 }, promotionChanceMonths: 18, promotionChance: 0.25, promotionTo: "serv2" },
            { id: "serv2", title: "Store Manager", field: JOB_FIELDS.SERVICE, level: 2, salary: 4000, annualIncrementPercent: 0.00, companyAnnualBonusChance: 0.5, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.SERVICE, minExperienceInFieldMonths: 24 }, firingRisk: 0.002 },

            // Legal Track
            { id: "legal0", title: "Legal Intern", field: JOB_FIELDS.LEGAL, level: 0, salary: 2500, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.2, promotionTo: "legal1" },
            { id: "legal1", title: "Paralegal", field: JOB_FIELDS.LEGAL, level: 1, salary: 3800, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.LEGAL, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 24, promotionChance: 0.2, promotionTo: "legal2" },
            { id: "legal2", title: "Junior Associate", field: JOB_FIELDS.LEGAL, level: 2, salary: 6000, annualIncrementPercent: 0.05, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.LEGAL, minExperienceInFieldMonths: 30 }, promotionChanceMonths: 36, promotionChance: 0.15, promotionTo: "legal3" },
            { id: "legal3", title: "Senior Associate", field: JOB_FIELDS.LEGAL, level: 3, salary: 9500, annualIncrementPercent: 0.03, companyAnnualBonusChance: 0.6, companyAnnualBonusPercent: 0.15, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.LEGAL, minExperienceInFieldMonths: 60 }, promotionChanceMonths: 48, promotionChance: 0.1, promotionTo: "legal4", firingRisk: 0.01 },
            { id: "legal4", title: "Partner", field: JOB_FIELDS.LEGAL, level: 4, salary: 15000, annualIncrementPercent: 0.01, companyAnnualBonusChance: 0.8, companyAnnualBonusPercent: 0.25, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.LEGAL, minExperienceInFieldMonths: 96 }, firingRisk: 0.005 },
            
            // Medical (Doctor) Track
            { id: "med0", title: "Medical Intern", field: JOB_FIELDS.MEDICAL, level: 0, salary: 3000, annualIncrementPercent: 0.01, prerequisites: null, promotionChanceMonths: 24, promotionChance: 0.15, promotionTo: "med1" },
            { id: "med1", title: "Resident Doctor", field: JOB_FIELDS.MEDICAL, level: 1, salary: 4500, annualIncrementPercent: 0.02, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.MEDICAL, minExperienceInFieldMonths: 24 }, promotionChanceMonths: 48, promotionChance: 0.1, promotionTo: "med2" },
            { id: "med2", title: "General Practitioner", field: JOB_FIELDS.MEDICAL, level: 2, salary: 9000, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.MEDICAL, minExperienceInFieldMonths: 72 }, promotionChanceMonths: 48, promotionChance: 0.1, promotionTo: "med3", firingRisk: 0.005 },
            { id: "med3", title: "Specialist Surgeon", field: JOB_FIELDS.MEDICAL, level: 3, salary: 16000, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.MEDICAL, minExperienceInFieldMonths: 120 }, promotionChanceMonths: 60, promotionChance: 0.05, promotionTo: "med4", firingRisk: 0.015 },
            { id: "med4", title: "Chief of Medicine", field: JOB_FIELDS.MEDICAL, level: 4, salary: 20000, annualIncrementPercent: 0.02, companyAnnualBonusChance: 0.7, companyAnnualBonusPercent: 0.20, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.MEDICAL, minExperienceInFieldMonths: 180 }, firingRisk: 0.01 },
        
			// Engineering Track
			{ id: "eng0", title: "Engineering Intern", field: JOB_FIELDS.ENGINEERING, level: 0, salary: 2500, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.3, promotionTo: "eng1" },
			{ id: "eng1", title: "Junior Engineer", field: JOB_FIELDS.ENGINEERING, level: 1, salary: 4000, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.ENGINEERING, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 24, promotionChance: 0.25, promotionTo: "eng2" },
			{ id: "eng2", title: "Project Engineer", field: JOB_FIELDS.ENGINEERING, level: 2, salary: 6500, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.ENGINEERING, minExperienceInFieldMonths: 36 }, promotionChanceMonths: 36, promotionChance: 0.15, promotionTo: "eng3" },
			{ id: "eng3", title: "Senior Engineer", field: JOB_FIELDS.ENGINEERING, level: 3, salary: 9000, annualIncrementPercent: 0.03, companyAnnualBonusChance: 0.5, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.ENGINEERING, minExperienceInFieldMonths: 60 }, promotionChanceMonths: 48, promotionChance: 0.1, promotionTo: "eng4", firingRisk: 0.005 },
			{ id: "eng4", title: "Engineering Director", field: JOB_FIELDS.ENGINEERING, level: 4, salary: 13000, annualIncrementPercent: 0.02, companyAnnualBonusChance: 0.7, companyAnnualBonusPercent: 0.15, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.ENGINEERING, minExperienceInFieldMonths: 96 }, firingRisk: 0.01 },

			// Education Track
			{ id: "edu0", title: "Teaching Assistant", field: JOB_FIELDS.EDUCATION, level: 0, salary: 2200, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 18, promotionChance: 0.3, promotionTo: "edu1" },
			{ id: "edu1", title: "Primary School Teacher", field: JOB_FIELDS.EDUCATION, level: 1, salary: 3500, annualIncrementPercent: 0.025, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.EDUCATION, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 36, promotionChance: 0.25, promotionTo: "edu2" },
			{ id: "edu2", title: "Secondary School Teacher", field: JOB_FIELDS.EDUCATION, level: 2, salary: 4800, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.EDUCATION, minExperienceInFieldMonths: 36 }, promotionChanceMonths: 48, promotionChance: 0.2, promotionTo: "edu3" },
			{ id: "edu3", title: "Lecturer", field: JOB_FIELDS.EDUCATION, level: 3, salary: 6500, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.EDUCATION, minExperienceInFieldMonths: 72 }, promotionChanceMonths: 60, promotionChance: 0.15, promotionTo: "edu4" },
			{ id: "edu4", title: "Professor", field: JOB_FIELDS.EDUCATION, level: 4, salary: 9500, annualIncrementPercent: 0.02, companyAnnualBonusChance: 0.5, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.EDUCATION, minExperienceInFieldMonths: 120 }, firingRisk: 0.003 },

			// Creative / Media Track
			{ id: "media0", title: "Content Intern", field: JOB_FIELDS.MEDIA, level: 0, salary: 1800, annualIncrementPercent: 0.015, prerequisites: null, promotionChanceMonths: 9, promotionChance: 0.35, promotionTo: "media1" },
			{ id: "media1", title: "Junior Writer", field: JOB_FIELDS.MEDIA, level: 1, salary: 3000, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.MEDIA, minExperienceInFieldMonths: 6 }, promotionChanceMonths: 18, promotionChance: 0.25, promotionTo: "media2" },
			{ id: "media2", title: "Content Producer", field: JOB_FIELDS.MEDIA, level: 2, salary: 5000, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.MEDIA, minExperienceInFieldMonths: 18 }, promotionChanceMonths: 24, promotionChance: 0.2, promotionTo: "media3" },
			{ id: "media3", title: "Creative Director", field: JOB_FIELDS.MEDIA, level: 3, salary: 8500, annualIncrementPercent: 0.03, companyAnnualBonusChance: 0.6, companyAnnualBonusPercent: 0.15, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.MEDIA, minExperienceInFieldMonths: 48 }, promotionChanceMonths: 36, promotionChance: 0.1, promotionTo: "media4", firingRisk: 0.01 },
			{ id: "media4", title: "Head of Media", field: JOB_FIELDS.MEDIA, level: 4, salary: 13000, annualIncrementPercent: 0.02, companyAnnualBonusChance: 0.8, companyAnnualBonusPercent: 0.20, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.MEDIA, minExperienceInFieldMonths: 84 }, firingRisk: 0.015 },

			// Skilled Trades Track
			{ id: "trade0", title: "Apprentice Electrician", field: JOB_FIELDS.TRADES, level: 0, salary: 1800, annualIncrementPercent: 0.015, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.3, promotionTo: "trade1" },
			{ id: "trade1", title: "Certified Electrician", field: JOB_FIELDS.TRADES, level: 1, salary: 3500, annualIncrementPercent: 0.025, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.TRADES, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 24, promotionChance: 0.25, promotionTo: "trade2" },
			{ id: "trade2", title: "Senior Electrician", field: JOB_FIELDS.TRADES, level: 2, salary: 5000, annualIncrementPercent: 0.03, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.TRADES, minExperienceInFieldMonths: 36 }, promotionChanceMonths: 36, promotionChance: 0.15, promotionTo: "trade3" },
			{ id: "trade3", title: "Site Supervisor", field: JOB_FIELDS.TRADES, level: 3, salary: 7000, annualIncrementPercent: 0.03, companyAnnualBonusChance: 0.5, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.TRADES, minExperienceInFieldMonths: 60 }, promotionChanceMonths: 48, promotionChance: 0.1, promotionTo: "trade4" },
			{ id: "trade4", title: "Master Contractor", field: JOB_FIELDS.TRADES, level: 4, salary: 10000, annualIncrementPercent: 0.02, companyAnnualBonusChance: 0.7, companyAnnualBonusPercent: 0.15, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.TRADES, minExperienceInFieldMonths: 84 }, firingRisk: 0.008 },

			// Government / Civil Service Track
			{ id: "gov0", title: "Administrative Clerk", field: JOB_FIELDS.GOVERNMENT, level: 0, salary: 2400, annualIncrementPercent: 0.02, prerequisites: null, promotionChanceMonths: 24, promotionChance: 0.25, promotionTo: "gov1" },
			{ id: "gov1", title: "Executive Officer", field: JOB_FIELDS.GOVERNMENT, level: 1, salary: 3800, annualIncrementPercent: 0.025, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.GOVERNMENT, minExperienceInFieldMonths: 24 }, promotionChanceMonths: 36, promotionChance: 0.2, promotionTo: "gov2" },
			{ id: "gov2", title: "Senior Executive Officer", field: JOB_FIELDS.GOVERNMENT, level: 2, salary: 5200, annualIncrementPercent: 0.025, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.GOVERNMENT, minExperienceInFieldMonths: 60 }, promotionChanceMonths: 48, promotionChance: 0.15, promotionTo: "gov3" },
			{ id: "gov3", title: "Assistant Director", field: JOB_FIELDS.GOVERNMENT, level: 3, salary: 7500, annualIncrementPercent: 0.02, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.GOVERNMENT, minExperienceInFieldMonths: 96 }, promotionChanceMonths: 60, promotionChance: 0.1, promotionTo: "gov4" },
			{ id: "gov4", title: "Director General", field: JOB_FIELDS.GOVERNMENT, level: 4, salary: 11000, annualIncrementPercent: 0.015, companyAnnualBonusChance: 0.5, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.GOVERNMENT, minExperienceInFieldMonths: 144 }, firingRisk: 0.002 },
			
			
			{ id: "art0", title: "Street Performer", field: JOB_FIELDS.ARTS, level: 0, salary: 1500, annualIncrementPercent: 0.01, prerequisites: null, promotionChanceMonths: 12, promotionChance: 0.3, promotionTo: "art1" },
			{ id: "art1", title: "Freelance Artist", field: JOB_FIELDS.ARTS, level: 1, salary: 2500, annualIncrementPercent: 0.025, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.ARTS, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 24, promotionChance: 0.25, promotionTo: "art2" },
			{ id: "art2", title: "Studio Artist", field: JOB_FIELDS.ARTS, level: 2, salary: 4800, annualIncrementPercent: 0.04, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.ARTS, minExperienceInFieldMonths: 36 }, promotionChanceMonths: 30, promotionChance: 0.2, promotionTo: "art3" },
			{ id: "art3", title: "Renowned Illustrator", field: JOB_FIELDS.ARTS, level: 3, salary: 9500, annualIncrementPercent: 0.05, companyAnnualBonusChance: 0.5, companyAnnualBonusPercent: 0.15, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.ARTS, minExperienceInFieldMonths: 72 }, promotionChanceMonths: 48, promotionChance: 0.15, promotionTo: "art4", firingRisk: 0.01 },
			{ id: "art4", title: "International Art Director", field: JOB_FIELDS.ARTS, level: 4, salary: 20000, annualIncrementPercent: 0.03, companyAnnualBonusChance: 0.8, companyAnnualBonusPercent: 0.25, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.ARTS, minExperienceInFieldMonths: 120 }, firingRisk: 0.008 },
			
			
			{ id: "ent0", title: "Small Business Dreamer", field: JOB_FIELDS.ENTREPRENEURSHIP, level: 0, salary: 1000, annualIncrementPercent: 0.00, prerequisites: null, promotionChanceMonths: 18, promotionChance: 0.25, promotionTo: "ent1" },
			{ id: "ent1", title: "Startup Founder", field: JOB_FIELDS.ENTREPRENEURSHIP, level: 1, salary: 2000, annualIncrementPercent: 0.02, prerequisites: { previousJobLevel: 0, field: JOB_FIELDS.ENTREPRENEURSHIP, minExperienceInFieldMonths: 12 }, promotionChanceMonths: 24, promotionChance: 0.2, promotionTo: "ent2" },
			{ id: "ent2", title: "Startup CEO", field: JOB_FIELDS.ENTREPRENEURSHIP, level: 2, salary: 6000, annualIncrementPercent: 0.05, companyAnnualBonusChance: 0.4, companyAnnualBonusPercent: 0.10, prerequisites: { previousJobLevel: 1, field: JOB_FIELDS.ENTREPRENENDSHIP, minExperienceInFieldMonths: 36 }, promotionChanceMonths: 36, promotionChance: 0.15, promotionTo: "ent3" },
			{ id: "ent3", title: "Tech Founder / Angel Investor", field: JOB_FIELDS.ENTREPRENEURSHIP, level: 3, salary: 15000, annualIncrementPercent: 0.07, companyAnnualBonusChance: 0.6, companyAnnualBonusPercent: 0.25, prerequisites: { previousJobLevel: 2, field: JOB_FIELDS.ENTREPRENEURSHIP, minExperienceInFieldMonths: 72 }, promotionChanceMonths: 48, promotionChance: 0.1, promotionTo: "ent4", firingRisk: 0.02 },
			{ id: "ent4", title: "Venture Capital Mogul", field: JOB_FIELDS.ENTREPRENEURSHIP, level: 4, salary: 40000, annualIncrementPercent: 0.05, companyAnnualBonusChance: 0.9, companyAnnualBonusPercent: 0.40, prerequisites: { previousJobLevel: 3, field: JOB_FIELDS.ENTREPRENEURSHIP, minExperienceInFieldMonths: 120 }, firingRisk: 0.03 },

		
		];
        
        // --- GAME PARAMETERS ---
        const INITIAL_CASH = 20000;
        const PROPERTY_DOWN_PAYMENT_PERCENTAGE = 0.20;
        const AVAILABLE_LOAN_TERMS = [ { years: 10, months: 120 }, { years: 15, months: 180 }, { years: 20, months: 240 }, { years: 30, months: 360 }];
        const PROPERTY_FEES_PERCENTAGE_ANNUAL = 0.01;
        const MAX_LOG_ENTRIES = 35; 
        const PROPERTIES_PER_MONTH_MIN = 1;
        const PROPERTIES_PER_MONTH_MAX = 3;
        const GOLDEN_OPPORTUNITY_CHANCE = 0.015; 

        const CONDITION_DECAY_VACANT_PER_MONTH = 0.1;
        const CONDITION_DECAY_RENTED_PER_MONTH = 0.3; 
        const MIN_TENANT_STAY_MONTHS = 6;
        const CHANCE_TENANT_LEAVES_AFTER_MIN = 0.1;
        
        // *** NEW: Made these `let` for inflation ***
        let CLEANING_FEE_MIN = 100;
        let CLEANING_FEE_MAX = 500;
        
        const RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL = 0.03;
        const RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL = 0.08;
        let BASE_TENANT_FIND_CHANCE = 0.3; // *** MODIFIED: Made let for market cycles ***
        const RANDOM_DAMAGE_EVENT_CHANCE = 0.03;
        const RANDOM_DAMAGE_MIN_PERCENT = 3;
        const RANDOM_DAMAGE_MAX_PERCENT = 10;

        const EVICTION_DAMAGE_CHANCE = 0.20; // 1 in 5
        const EVICTION_DAMAGE_MIN_PERCENT = 10;
        const EVICTION_DAMAGE_MAX_PERCENT = 25;
        const DISASTER_EVENT_CHANCE = 0.01; // 1% chance per property per month
        const DISASTER_DAMAGE_MIN_PERCENT = 5;
        const DISASTER_DAMAGE_MAX_PERCENT = 50;

        // *** MODIFIED: Base appreciation rates for different market states ***
        const ANNUAL_APPRECIATION_NORMAL = 0.02; 
        const ANNUAL_APPRECIATION_BOOM = 0.10;
        const ANNUAL_APPRECIATION_BUST = -0.05;
        
        let BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET = 0.05; // *** MODIFIED: Made let for market cycles ***
        const BUYER_OFFER_CONDITION_PENALTY_MAX = 0.10; 
        
        const COUNTER_OFFER_NEGOTIATION_MAX_CHANCE = 0.90;
        const COUNTER_OFFER_NEGOTIATION_MIN_CHANCE = 0.10;
        const COUNTER_OFFER_MIN_ACCEPT_CHANCE = 0.01;
        
        let BASE_CHANCE_OF_RECEIVING_OFFER = 0.15; // *** MODIFIED: Made let for market cycles ***
        const ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE = 0.1; 
        const CONDITION_SENSITIVITY_FOR_OFFER_CHANCE = 0.002; 

        const BAD_TENANT_CONDITION_THRESHOLD = 35; 
        let CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION = 0.20; // *** MODIFIED: Made let for market cycles ***
        let DELINQUENT_NON_PAYMENT_BASE_CHANCE = 0.25; // *** MODIFIED: Made let for market cycles ***
        const DELINQUENT_NON_PAYMENT_ESCALATION_PER_MONTH = 0.15; 
        const DELINQUENT_MAX_NON_PAYMENT_CHANCE = 0.90; 
        const CONDITION_THRESHOLD_TO_CURE_DELINQUENCY = 50; 
        const CHANCE_CURE_DELINQUENCY_IF_RENOVATED = 0.75; 

        const EXTERNAL_LOAN_MIN_MONTHLY_INTEREST = 0.01;
        const EXTERNAL_LOAN_MAX_MONTHLY_INTEREST = 0.15;
        const EXTERNAL_LOAN_TERM_MONTHS = 36;
        const LOAN_AD_CHANCE = 0.03; 
        const MIN_MONTHS_FOR_LOAN_AD = 6; 
        
        const BANK_LOAN_SUCCESS_CHANCE = 0.50;
        // *** NEW: Made this `let` for inflation ***
        let BANK_LOAN_APPLICATION_FEE = 500;
        const BANK_LOAN_COOLDOWN_MONTHS = 3;
        const BANK_LOAN_ANNUAL_INTEREST_RATE = 0.08;
        const BANK_LOAN_TERM_MONTHS = 60; // 5 years

        const MAX_JOB_LISTINGS = 4;
        const JOB_APPLICATION_BASE_SUCCESS_CHANCE = 0.4;
        const BANKRUPTCY_THRESHOLD = -10000; 
        const BASE_FIRING_RISK = 0.002;

        const MARKETING_ASKING_PRICE_CAP_PERCENT = 1.20;
        const MARKETING_SALE_CHANCE_MONTH_1 = 0.50;
        const MARKETING_SALE_CHANCE_MONTH_2 = 0.40;

        // *** NEW: Economic Cycle Constants ***
        const MARKET_STATES = { NORMAL: 'Normal', BOOM: 'Boom', BUST: 'Bust' };
        const MARKET_STATE_MIN_DURATION_MONTHS = 12;
        const MARKET_STATE_NORMAL_TO_CHANGE_CHANCE = 0.15;
        const MARKET_STATE_BOOM_BUST_TO_NORMAL_CHANCE = 0.40;


        // --- GAME STATE VARIABLES ---
        let player = { 
            ageMonths: 18 * 12, cash: INITIAL_CASH, 
            currentJobId: "unskilled0", 
            experienceInCurrentJobMonths: 0,
            totalExperienceInFieldMonths: 0, 
            salary: 1200, 
            netWorth: INITIAL_CASH, 
            properties: [], externalLoans: [],
            deathAgeYears: 0, 
            deathAgeMonths: 0,
            bankLoanCooldown: 0,
            lastMonthCashChange: 0
        };
        
        // *** NEW: Mutable game data for inflation ***
        let gamePropertyTypes = [];
        let gameJobs = [];
        let currentInflationRate = 0.0; // NEW: Inflation
        
        // *** NEW: Economic Cycle State ***
        let marketState = MARKET_STATES.NORMAL;
        let marketStateMonths = 0;
        
        let availableProperties = [];
        let availableJobs = []; 
        let gameLog = ["Game started. Good luck!"];
        let currentMonth = 0;
        let propertyToManageIndex = -1; 
        let currentOfferForProperty = null; 
        let selectedLoanTermMonths = AVAILABLE_LOAN_TERMS.find(t => t.years === 20).months;
        let jobToApplyForId = null; 
        let firstMonthAdvanced = false; 

        // --- DOM Element References ---
        const ageEl = document.getElementById('player-age');
        const cashEl = document.getElementById('player-cash');
        const cashChangeIndicatorEl = document.getElementById('cash-change-indicator');
        const playerJobTitleEl = document.getElementById('player-job-title'); 
        const salaryEl = document.getElementById('player-salary');
        const netWorthEl = document.getElementById('player-net-worth');
        const inflationRateEl = document.getElementById('current-inflation-rate'); // NEW: Inflation DOM
        const marketStatusEl = document.getElementById('current-market-status'); // *** NEW: Market Status DOM ***
        const propertyListingsEl = document.getElementById('property-listings');
        const jobMarketListingsEl = document.getElementById('job-market-listings'); 
        const ownedPropertiesEl = document.getElementById('owned-properties');
        const noOwnedPropertiesMsgEl = document.getElementById('no-owned-properties-msg');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const externalLoanBtn = document.getElementById('external-loan-btn');
        const bankLoanBtn = document.getElementById('bank-loan-btn'); 
        const newLifeBtn = document.getElementById('new-life-btn'); 
        const gameLogEl = document.getElementById('game-log');
        const gameHeaderEl = document.getElementById('gameHeader'); 

        const loanSectionToggleBtn = document.getElementById('loan-section-toggle');
        const loanSectionContentEl = document.getElementById('loan-section-content');

        const tabBtnMarket = document.getElementById('tab-btn-market');


		const tabBtnJobs = document.getElementById('tab-btn-jobs');
        const tabPanelMarket = document.getElementById('tab-panel-market');
        const tabPanelJobs = document.getElementById('tab-panel-jobs');
        
        const cashflowIncomeEl = document.getElementById('cashflow-income');
        const cashflowExpensesEl = document.getElementById('cashflow-expenses');
        const cashflowNetEl = document.getElementById('cashflow-net');

        const messageModal = document.getElementById('messageModal');
        const messageModalContentEl = messageModal.querySelector('.modal-content'); 
        const modalTitleEl = document.getElementById('modalTitle');
        const modalMessageEl = document.getElementById('modalMessage');
        const modalCloseBtn = messageModal.querySelector('.modal-button'); 

        const renovationModal = document.getElementById('renovationModal');
        const renovationModalTitleEl = document.getElementById('renovationModalTitle');
        const renovationModalTextEl = document.getElementById('renovationModalText');
        const cancelRenovationBtn = document.getElementById('cancelRenovationBtn');
        const renovationModalInfoEl = document.getElementById('renovationModalInfo');
        const renovate10Btn = document.getElementById('renovate10Btn');
        const renovate10CostEl = document.getElementById('renovate10Cost');
        const renovate20Btn = document.getElementById('renovate20Btn');
        const renovate20CostEl = document.getElementById('renovate20Cost');
        const renovateMaxBtn = document.getElementById('renovateMaxBtn');
        const renovateMaxPercentEl = document.getElementById('renovateMaxPercent');
        const renovateMaxCostEl = document.getElementById('renovateMaxCost');
        
        const loanTermModal = document.getElementById('loanTermModal');
        const loanTermModalTitleEl = document.getElementById('loanTermModalTitle');
        const loanPropertyDetailsEl = document.getElementById('loanPropertyDetails');
        const loanTermOptionsContainerEl = document.getElementById('loanTermOptionsContainer');
        const loanTermSelectedPaymentEl = document.getElementById('loanTermSelectedPayment');
        const confirmLoanBtn = document.getElementById('confirmLoanBtn');
        const cancelLoanBtn = document.getElementById('cancelLoanBtn');
        
        const listSaleModal = document.getElementById('listSaleModal');
        const listSaleModalTitleEl = document.getElementById('listSaleModalTitle');
        const listSalePropertyInfoEl = document.getElementById('listSalePropertyInfo');
        const listSaleMarketValueEl = document.getElementById('listSaleMarketValue');
        const askingPriceInputEl = document.getElementById('askingPriceInput');
        const confirmListSaleBtn = document.getElementById('confirmListSaleBtn');
        const cancelListSaleBtn = document.getElementById('cancelListSaleBtn');
        
        const offerModal = document.getElementById('offerModal');
        const offerModalTitleEl = document.getElementById('offerModalTitle');
        const offerPropertyInfoEl = document.getElementById('offerPropertyInfo');
        const offerAskingPriceEl = document.getElementById('offerAskingPrice');
        const offerBuyerOfferValueEl = document.getElementById('offerBuyerOfferValue');
        const offerCounterInputEl = document.getElementById('offerCounterInput');
        const acceptOfferBtn = document.getElementById('acceptOfferBtn');
        const submitOfferCounterBtn = document.getElementById('submitOfferCounterBtn');
        const rejectOfferBtn = document.getElementById('rejectOfferBtn');

        const flippingPenaltyModal = document.getElementById('flippingPenaltyModal');
        const flippingPenaltyMessage = document.getElementById('flippingPenaltyMessage');
        const confirmFlippingSaleBtn = document.getElementById('confirmFlippingSaleBtn');
        const cancelFlippingSaleBtn = document.getElementById('cancelFlippingSaleBtn');
        
        const externalLoanModal = document.getElementById('externalLoanModal');
        const externalLoanModalTitleEl = document.getElementById('externalLoanModalTitle');
        const externalLoanAmountInputEl = document.getElementById('externalLoanAmountInput');
        const externalLoanEstPaymentEl = document.getElementById('externalLoanEstPayment');
        const confirmExternalLoanBtn = document.getElementById('confirmExternalLoanBtn');
        const cancelExternalLoanBtn = document.getElementById('cancelExternalLoanBtn');

        const bankLoanModal = document.getElementById('bankLoanModal');
        const bankLoanModalTitleEl = document.getElementById('bankLoanModalTitle');
        const bankLoanFeeTextEl = document.getElementById('bankLoanFeeText');
        const bankLoanAmountInputEl = document.getElementById('bankLoanAmountInput');
        const bankLoanEstPaymentEl = document.getElementById('bankLoanEstPayment');
        const confirmBankLoanBtn = document.getElementById('confirmBankLoanBtn');
        const cancelBankLoanBtn = document.getElementById('cancelBankLoanBtn');

        const loanAdModal = document.getElementById('loanAdModal');
        const loanAdModalContentEl = loanAdModal.querySelector('.modal-content');
        const loanAdTakeLoanBtn = document.getElementById('loanAdTakeLoanBtn');
        const loanAdDismissBtn = document.getElementById('loanAdDismissBtn');

        const jobApplicationConfirmModal = document.getElementById('jobApplicationConfirmModal');
        const jobConfirmModalTitleEl = document.getElementById('jobConfirmModalTitle');
        const jobConfirmDetailsEl = document.getElementById('jobConfirmDetails');
        const confirmJobApplicationBtn = document.getElementById('confirmJobApplicationBtn');
        const cancelJobApplicationBtn = document.getElementById('cancelJobApplicationBtn');

        const resetConfirmModal = document.getElementById('resetConfirmModal');
        const confirmResetBtn = document.getElementById('confirmResetBtn');
        const cancelResetBtn = document.getElementById('cancelResetBtn');

        const evictTenantModal = document.getElementById('evictTenantModal');
        const evictTenantModalTitleEl = document.getElementById('evictTenantModalTitle');
        const evictTenantPropertyInfoEl = document.getElementById('evictTenantPropertyInfo');
        const confirmEvictBtn = document.getElementById('confirmEvictBtn');
        const cancelEvictBtn = document.getElementById('cancelEvictBtn');

        const marketingConfirmModal = document.getElementById('marketingConfirmModal');
        const marketingConfirmModalTitleEl = document.getElementById('marketingConfirmModalTitle');
        const marketingConfirmPropertyInfoEl = document.getElementById('marketingConfirmPropertyInfo');
        const marketingConfirmDetailsEl = document.getElementById('marketingConfirmDetails');
        const marketingConfirmFeeEl = document.getElementById('marketingConfirmFee');
        const confirmMarketingBtn = document.getElementById('confirmMarketingBtn');
        const cancelMarketingBtn = document.getElementById('cancelMarketingBtn');

        const gameOverOverlayEl = document.getElementById('gameOverOverlay');
        const gameOverTitleEl = document.getElementById('gameOverTitle');
        const gameOverMessageEl = document.getElementById('gameOverMessage');
        const restartGameBtn = document.getElementById('restartGameBtn');


        // --- CORE HELPER FUNCTIONS ---

        function formatCurrency(amount) { return Math.round(amount).toLocaleString(); }
        
        function calculateMonthlyPayment(principal, annualInterestRate, termMonths) {
            if (termMonths <= 0) return principal; 
            if (annualInterestRate <= 0) return principal / termMonths;
            
            const monthlyRate = annualInterestRate / 12;
            const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / (Math.pow(1 + monthlyRate, termMonths) - 1);
            return payment;
        }

        function showTab(tabName) {
            if (tabName === 'market') {
                tabPanelMarket.style.display = 'block';
                tabPanelJobs.style.display = 'none';
                tabBtnMarket.classList.add('border-indigo-600', 'text-indigo-600');
                tabBtnMarket.classList.remove('text-slate-600', 'border-transparent', 'hover:text-indigo-600');
                tabBtnJobs.classList.add('text-slate-600', 'border-transparent', 'hover:text-indigo-600');
                tabBtnJobs.classList.remove('border-indigo-600', 'text-indigo-600');
            } else if (tabName === 'jobs') {
                tabPanelMarket.style.display = 'none';
                tabPanelJobs.style.display = 'block';
                tabBtnJobs.classList.add('border-indigo-600', 'text-indigo-600');
                tabBtnJobs.classList.remove('text-slate-600', 'border-transparent', 'hover:text-indigo-600');
                tabBtnMarket.classList.add('text-slate-600', 'border-transparent', 'hover:text-indigo-600');
                tabBtnMarket.classList.remove('border-indigo-600', 'text-indigo-600');
            }
        }

        function getRenovationCostPerPoint(property) {
            if (!property) return 100; 
            // *** NEW: Inflate renovation costs by 1/3 of inflation rate ***
            // This prevents renovation from becoming trivially cheap in late game.
            const inflationAdjustment = 1 + (currentInflationRate / 3);
            const value = property.currentMarketValue;
            let totalRenovationCost;
            if (value < 200000) {
                totalRenovationCost = value * 1.0; 
            } else if (value >= 200000 && value <= 400000) {
                totalRenovationCost = value * 0.9; 
            } else { 
                totalRenovationCost = value * 0.8; 
            }
            return (totalRenovationCost / 100) * inflationAdjustment;
        }

        function showModal(title, message, type = 'info') { 
            modalTitleEl.textContent = title; modalMessageEl.textContent = message;
            messageModalContentEl.classList.remove('modal-success', 'modal-error', 'modal-warning', 'modal-info');
            // Reset modal button classes to base
            modalCloseBtn.className = 'modal-button'; 
            switch (type) {
                case 'success': messageModalContentEl.classList.add('modal-success'); break;
                case 'error': messageModalContentEl.classList.add('modal-error'); break;
                case 'warning': messageModalContentEl.classList.add('modal-warning'); break;
                default: messageModalContentEl.classList.add('modal-info'); break;
            }
            messageModal.style.display = "block";
        }

        modalCloseBtn.onclick = function() { messageModal.style.display = "none"; }
        
        window.onclick = function(event) {
            if (event.target == messageModal) messageModal.style.display = "none";
            if (event.target == renovationModal) renovationModal.style.display = "none";
            if (event.target == loanTermModal) loanTermModal.style.display = "none";
            if (event.target == listSaleModal) listSaleModal.style.display = "none";
            if (event.target == offerModal) offerModal.style.display = "none";
            if (event.target == externalLoanModal) externalLoanModal.style.display = "none";
            if (event.target == bankLoanModal) bankLoanModal.style.display = "none";
            if (event.target == loanAdModal) loanAdModal.style.display = "none";
            if (event.target == jobApplicationConfirmModal) jobApplicationConfirmModal.style.display = "none";
            if (event.target == resetConfirmModal) resetConfirmModal.style.display = "none";
            if (event.target == evictTenantModal) evictTenantModal.style.display = "none";
            if (event.target == marketingConfirmModal) marketingConfirmModal.style.display = "none";
            if (event.target == flippingPenaltyModal) flippingPenaltyModal.style.display = "none";
        }
        function addLogEntry(message) { gameLog.unshift(message); if (gameLog.length > MAX_LOG_ENTRIES) gameLog.pop(); renderGameLog(); }
        function getConditionClass(condition) { if (condition >= 70) return 'condition-good'; if (condition >= 40) return 'condition-fair'; return 'condition-poor'; }

        // --- RENDER FUNCTIONS ---

        function calculateAndRenderCashflow() {
            try {
                let totalIncome = player.salary;
                let totalExpenses = 0;

                player.properties.forEach(prop => {
                    if (prop.isRented && !prop.isDelinquent && !prop.tenantFirstMonthFree) {
                        totalIncome += prop.currentRent;
                    }
                    if (prop.remainingLoan > 0) {
                        totalExpenses += prop.monthlyInstallment;
                    }
                    totalExpenses += prop.monthlyFees;
                });

                player.externalLoans.forEach(loan => {
                    totalExpenses += loan.monthlyPayment;
                });

                let netMonthly = totalIncome - totalExpenses;

                cashflowIncomeEl.textContent = `$${formatCurrency(totalIncome)}`;
                cashflowExpensesEl.textContent = `-$${formatCurrency(totalExpenses)}`;
                cashflowNetEl.textContent = `$${formatCurrency(netMonthly)}`;

                cashflowNetEl.classList.remove('text-green-600', 'text-red-600', 'text-slate-700');
                if (netMonthly > 0) {
                    cashflowNetEl.classList.add('text-green-600');
                } else if (netMonthly < 0) {
                    cashflowNetEl.classList.add('text-red-600');
                } else {
                    cashflowNetEl.classList.add('text-slate-700');
                }
            } catch (e) {
                console.error("Error in calculateAndRenderCashflow:", e);
                cashflowIncomeEl.textContent = "Error";
                cashflowExpensesEl.textContent = "Error";
                cashflowNetEl.textContent = "Error";
            }
        }
		
		// *** MODIFIED: To include market status ***
        function renderPlayerStats() { 
            try {
                const currentJob = gameJobs.find(j => j.id === player.currentJobId); // MODIFIED: Use gameJobs
                
                // Get new values
                const newAge = `${Math.floor(player.ageMonths / 12)} years, ${player.ageMonths % 12} months`;
                const newCash = `$${formatCurrency(player.cash)}`;
                const newJobTitle = currentJob ? currentJob.title : "Unemployed";
                const newSalary = `$${formatCurrency(player.salary)}`;
                const newNetWorth = `$${formatCurrency(calculateNetWorth())}`;
                const newInflation = `${(currentInflationRate * 100).toFixed(1)}%`; // NEW: Inflation
                const newMarketStatus = marketState; // *** NEW ***

                // Helper function to update value and trigger animation
                const updateStat = (element, newValue, useSmallText = false) => {
                    // MODIFICATION: Logic to handle new small text class
                    if (element.textContent !== newValue) {
                        element.textContent = newValue;
                        
                        // Add/remove small text class based on flag
                        if (useSmallText) {
                            element.classList.add('stat-value-small-text');
                        } else {
                            element.classList.remove('stat-value-small-text');
                        }

                        element.classList.add('animated-flip');
                        setTimeout(() => {
                            element.classList.remove('animated-flip');
                        }, 600);
                    }
                };

                // Update stats
                // MODIFICATION: Pass 'true' for Age and Job Title
                updateStat(ageEl, newAge, true); 
                updateStat(cashEl, newCash);
                updateStat(playerJobTitleEl, newJobTitle, true);
                updateStat(salaryEl, newSalary);
                updateStat(netWorthEl, newNetWorth);
                updateStat(inflationRateEl, newInflation); // NEW: Update inflation display
                
                // *** NEW: Update market status display ***
                updateStat(marketStatusEl, newMarketStatus);
                marketStatusEl.classList.remove('text-green-600', 'text-red-600', 'text-slate-700');
                if (marketState === MARKET_STATES.BOOM) {
                    marketStatusEl.classList.add('text-green-600');
                } else if (marketState === MARKET_STATES.BUST) {
                    marketStatusEl.classList.add('text-red-600');
                } else {
                    marketStatusEl.classList.add('text-slate-700');
                }
                // *** END NEW ***


                // Logic for the cash change indicator
                if (player.lastMonthCashChange !== 0 && firstMonthAdvanced) {
                    cashChangeIndicatorEl.classList.remove('profit', 'loss');
                    if (player.lastMonthCashChange > 0) {
                        cashChangeIndicatorEl.textContent = `(+$${formatCurrency(player.lastMonthCashChange)})`;
                        cashChangeIndicatorEl.classList.add('profit');
                    } else {
                        cashChangeIndicatorEl.textContent = `(-$${formatCurrency(Math.abs(player.lastMonthCashChange))})`;
                        cashChangeIndicatorEl.classList.add('loss');
                    }
                    cashChangeIndicatorEl.classList.add('visible');
                } else {
                    cashChangeIndicatorEl.classList.remove('visible');
                }

            } catch (e) {
                console.error("Error in renderPlayerStats:", e);
            }
        }

        function renderLoanButtons() {
            // Update fee text in case of inflation
            bankLoanFeeTextEl.innerHTML = `A non-refundable application fee of <strong>$${formatCurrency(BANK_LOAN_APPLICATION_FEE)}</strong> will be charged.`;
            
            if (player.bankLoanCooldown > 0) {
                bankLoanBtn.classList.add('button-disabled');
                bankLoanBtn.disabled = true;
                bankLoanBtn.textContent = `On Cooldown (${player.bankLoanCooldown} months left)`;
            } else {
                bankLoanBtn.classList.remove('button-disabled');
                bankLoanBtn.disabled = false;
                bankLoanBtn.textContent = 'Apply for Bank Loan';
            }
        }
		
		function renderPropertyListings() {
            try {
                propertyListingsEl.innerHTML = '';
                if (!availableProperties || availableProperties.length === 0) {
                    propertyListingsEl.innerHTML = '<p class="text-slate-500 text-center py-12">No new properties listed this month.</p>'; return;
                }
                availableProperties.forEach((prop, index) => {
                    if (!prop) { console.error("Undefined property in availableProperties at index:", index); return; }
                    const downPayment = prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
                    const card = document.createElement('div');
                    card.className = `card ${prop.isGolden ? 'golden-opportunity' : ''}`;
                    card.innerHTML = `
                        <h3>${prop.name} (ID: ${prop.id})</h3>
                        <p><span class="price">Price: $${formatCurrency(prop.price)}</span></p>
                        <p><span class="rent-estimate">Est. Monthly Rent: $${formatCurrency(prop.estimatedRent)}</span></p>
                        <p>Initial Condition: <span class="${getConditionClass(prop.initialCondition)} font-semibold">${prop.initialCondition.toFixed(1)}%</span></p>
                        <p>Down Payment (20%): $${formatCurrency(downPayment)}</p>
                        <button class="button button-buy mt-3 w-full ${player.cash < downPayment ? 'button-disabled' : ''}"
                                onclick="openLoanTermModal(${index})"
                                ${player.cash < downPayment ? 'disabled' : ''}>
                            ${player.cash < downPayment ? 'Not Enough Cash' : 'Consider Purchase'}
                        </button>`;
                    propertyListingsEl.appendChild(card);
                });
            } catch (e) {
                console.error("Error in renderPropertyListings:", e);
                propertyListingsEl.innerHTML = '<p class="text-red-500 text-center py-12">Error loading property listings!</p>';
            }
        }

        function renderJobMarket() {
            try {
                jobMarketListingsEl.innerHTML = '';
                if (!availableJobs || availableJobs.length === 0) {
                    jobMarketListingsEl.innerHTML = '<p class="text-slate-500 text-center py-12 col-span-full">No suitable job openings this month.</p>'; return;
                }
                availableJobs.forEach(job => {
                    if (!job) { console.error("Undefined job in availableJobs"); return; }
                    const card = document.createElement('div');
                    card.className = 'card';
                    let prereqText = "None";
                    if (job.prerequisites) {
                        // MODIFIED: Use gameJobs
                        const prevJob = gameJobs.find(j => j.level === job.prerequisites.previousJobLevel && j.field === job.prerequisites.field);
                        prereqText = `${prevJob ? prevJob.title : `Level ${job.prerequisites.previousJobLevel} in ${job.prerequisites.field}`} & ${(job.prerequisites.minExperienceInFieldMonths / 12).toFixed(1)} yrs in field`;
                    }

                    card.innerHTML = `
                        <h3>${job.title}</h3>
                        <p>Field: ${job.field}</p>
                        <p><span class="job-salary">Salary: $${formatCurrency(job.salary)}/month</span></p>
                        <p>Annual Increment: ${(job.annualIncrementPercent * 100).toFixed(1)}% ${job.companyAnnualBonusChance ? `(+ ${ (job.companyAnnualBonusPercent*100).toFixed(0) }% bonus chance)` : ''}</p>
                        <p class="text-xs">Prerequisites: ${prereqText}</p>
                        <button class="button button-apply-job mt-3 w-full" onclick="openJobApplicationConfirmModal('${job.id}')">Apply Now</button> `;
                    jobMarketListingsEl.appendChild(card);
                });
            } catch (e) {
                console.error("Error in renderJobMarket:", e);
                jobMarketListingsEl.innerHTML = '<p class="text-red-500 text-center py-12">Error loading job market!</p>';
            }
        }

        // *** MODIFIED: renderOwnedProperties with DISASTER ICON ***
		function renderOwnedProperties() {
            try {
                ownedPropertiesEl.innerHTML = '';
                if (!player.properties || player.properties.length === 0) {
                    ownedPropertiesEl.innerHTML = '<p class="text-slate-500 text-center py-12 col-span-full" id="no-owned-properties-msg">You don\'t own any properties yet.</p>';
                    return;
                }
                player.properties.forEach((prop, index) => {
                    if (!prop) { console.error("Undefined property in player.properties at index:", index); return; }
                    const card = document.createElement('div');
                    card.className = 'card';

                    // --- NEW: Disaster Icon Logic ---
                    let disasterIconHTML = '';
                    let disasterTitle = '';
                    if (prop.hasDisasterIcon && prop.disasterIcon) {
                        switch(prop.disasterIcon) {
                            case 'üî•': disasterTitle = 'Fire Damage'; break;
                            case 'üåä': disasterTitle = 'Flood Damage'; break;
                            case 'üí•': disasterTitle = 'Earthquake Damage'; break;
                            case 'üîß': disasterTitle = 'Property Damage'; break;
                            case 'üò†': disasterTitle = 'Eviction Damage'; break;
                            default: disasterTitle = 'Damage Reported';
                        }
                        disasterIconHTML = `
                            <span class="disaster-icon active" title="${disasterTitle}">
                                ${prop.disasterIcon}
                            </span>
                        `;
                    }
                    // --- END NEW ---

                    let statusHTML = '', rentalActionButtonHTML = '', saleActionButtonHTML = '', marketingButtonHTML = '';

                    if (prop.isBeingMarketed) {
                        statusHTML = `<span class="property-status status-listed-rent" style="color: #2563eb; font-weight: 700;">MARKETING ACTIVE</span><br>Campaign Month: ${prop.marketingMonths + 1}<br>Type: ${prop.wasListedForRent ? 'Fast Rent' : 'Fast Sale'}`;
                        rentalActionButtonHTML = `<button class="button button-rent mt-2 w-full button-disabled" disabled>Manage Rental (Blocked)</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full button-disabled" disabled>List for Sale (Blocked)</button>`;
                        marketingButtonHTML = `<button class="button button-marketing w-full button-disabled" disabled>Marketing Active...</button>`;
                    } else if (prop.isListedForSale) {
                        statusHTML = `<span class="property-status status-listed-sale">LISTED FOR SALE</span><br>Asking: <span class="asking-price">$${formatCurrency(prop.askingPrice)}</span><br>On Market: ${prop.timeOnMarket} months`;
                        saleActionButtonHTML = `<button class="button button-secondary w-full" onclick="openListSaleModal(${index}, true)">Adjust Price</button><button class="button button-secondary w-full" onclick="deListProperty(${index})">De-list Property</button>`;
                        rentalActionButtonHTML = `<button class="button button-rent mt-2 w-full button-disabled" disabled title="Property is listed for sale">Manage Rental (Blocked)</button>`;
                        marketingButtonHTML = `<button class="button button-marketing w-full" onclick="openMarketingConfirmModal(${index})">Start Marketing</button>`;
                    } else if (prop.isDelinquent) {
                        statusHTML = `<span class="property-status status-delinquent">TENANT DELINQUENT (${prop.delinquentMonths} months unpaid)</span>`;
                        rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" onclick="openManageRentalModal(${index})">Evict Delinquent Tenant</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                        marketingButtonHTML = `<button class="button button-marketing w-full button-disabled" disabled title="Resolve delinquency to market">Start Marketing</button>`;
                    } else if (prop.isRented) {
                        statusHTML = `<span class="property-status status-rented">Rented: $${formatCurrency(prop.currentRent)}/month</span> (Tenant for ${prop.tenantMonths} months)`;
                        rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" onclick="openManageRentalModal(${index})">Manage Rental</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                        marketingButtonHTML = `<button class="button button-marketing w-full button-disabled" disabled title="Evict tenant to market">Start Marketing</button>`;
                    } else if (prop.isListedForRent) {
                        statusHTML = `<span class="property-status status-listed-rent">Listed for Rent</span>`;
                        rentalActionButtonHTML = `<button class="button button-secondary mt-2 w-full" onclick="toggleListingStatus(${index})">Cancel Rent Listing</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                        marketingButtonHTML = `<button class="button button-marketing w-full" onclick="openMarketingConfirmModal(${index})">Start Marketing</button>`;
                    } else { // Vacant
                        statusHTML = `<span class="property-status status-vacant">Vacant</span>`;
                        rentalActionButtonHTML = `<button class="button button-rent mt-2 w-full" onclick="toggleListingStatus(${index})">List for Rent</button>`;
                        saleActionButtonHTML = `<button class="button button-list-sell w-full" onclick="openListSaleModal(${index})">List for Sale</button>`;
                        marketingButtonHTML = `<button class="button button-marketing w-full button-disabled" disabled title="List property to start marketing">Start Marketing</button>`;
                    }

                    card.innerHTML = `
                        ${disasterIconHTML} <h3>${prop.name} (ID: ${prop.id})</h3>
                        <p>Market Value: $${formatCurrency(prop.currentMarketValue)} (Bought for $${formatCurrency(prop.purchasePrice)})</p>
                        <p>Loan: $${formatCurrency(prop.remainingLoan)} (${prop.monthsPaid}/${prop.loanTermMonths} paid)</p>
                        <p>Months Owned: ${prop.monthsOwned || 0}</p>
                        <p>Monthly Installment: $${formatCurrency(prop.monthlyInstallment)}</p>
                        <p>Monthly Fees: $${formatCurrency(prop.monthlyFees)}</p>
                        <p>Condition: <span class="${getConditionClass(prop.condition)} font-semibold">${prop.condition.toFixed(1)}%</span></p>
                        <p>${statusHTML}</p>
                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                            ${rentalActionButtonHTML}
                            <button class="button button-renovate w-full" onclick="openRenovationModal(${index})">Renovate</button>
                            ${saleActionButtonHTML}
                            ${marketingButtonHTML}
                        </div>
                        ${prop.remainingLoan <= 0 ? '<p class="font-bold text-green-600 mt-2">Fully Paid Off!</p>' : ''}
                    `;
                    ownedPropertiesEl.appendChild(card);
                });
            } catch (e) {
                console.error("Error in renderOwnedProperties:", e);
                ownedPropertiesEl.innerHTML = '<p class="text-red-500 text-center py-12 col-span-full">Error loading your portfolio!</p>';
            }
        }
        // *** END MODIFIED FUNCTION ***

        function renderGameLog() {
             try {
                gameLogEl.innerHTML = '';
                if (!gameLog) return;
                gameLog.forEach(entry => {
                    const li = document.createElement('li');
                    li.textContent = entry;
                    // *** MODIFIED: Added 'inflation' and market state change colors ***
                    if (entry.toLowerCase().includes("bought") || entry.toLowerCase().includes("salary increase") || entry.toLowerCase().includes("rented out") || entry.toLowerCase().includes("rental income") || entry.toLowerCase().includes("sold") || entry.toLowerCase().includes("resumed payment") || entry.toLowerCase().includes("offer accepted") || entry.toLowerCase().includes("golden opportunity") || entry.toLowerCase().includes("got the job") || entry.toLowerCase().includes("promoted") || entry.toLowerCase().includes("bonus") || entry.toLowerCase().includes("bank loan approved") || entry.toLowerCase().includes("marketing success") || entry.toLowerCase().includes("market is booming")) {
                        li.style.color = "#15803d"; // success-dark
                        li.style.fontWeight = "500";
                    } else if (entry.toLowerCase().includes("paid") || entry.toLowerCase().includes("expenses") || entry.toLowerCase().includes("fee") || entry.toLowerCase().includes("renovation") || entry.toLowerCase().includes("external loan payment") || entry.toLowerCase().includes("bank loan payment") || entry.toLowerCase().includes("marketing campaign fee") || entry.toLowerCase().includes("flipping penalty")) {
                        li.style.color = "#b91c1c"; // danger-dark
                    } else if (entry.toLowerCase().includes("tenant left") || entry.toLowerCase().includes("damage") || entry.toLowerCase().includes("deal fell through") || entry.toLowerCase().includes("offer rejected") || entry.toLowerCase().includes("delinquent") || entry.toLowerCase().includes("stopped paying") || entry.toLowerCase().includes("no offers") || entry.toLowerCase().includes("took risky loan") || entry.toLowerCase().includes("application rejected") || entry.toLowerCase().includes("fired") || entry.toLowerCase().includes("disaster") || entry.toLowerCase().includes("evicted tenant damaged") || entry.toLowerCase().includes("bank loan rejected") || entry.toLowerCase().includes("marketing failed") || entry.toLowerCase().includes("inflation") || entry.toLowerCase().includes("market enters bust") || entry.toLowerCase().includes("market cools")) {
                        li.style.color = "#b45309"; // gold-dark
                        li.style.fontWeight = "500";
                    }
                    gameLogEl.appendChild(li);
                });
            } catch (e) {
                console.error("Error in renderGameLog:", e);
            }
        }

        // --- DATA GENERATION FUNCTIONS ---

        function getEstimatedMonthlyRent(value, condition, isGolden = false) {
            const annualRentMin = value * RENT_AS_PERCENTAGE_OF_VALUE_MIN_ANNUAL;
            const annualRentMax = value * RENT_AS_PERCENTAGE_OF_VALUE_MAX_ANNUAL;
            let monthlyRent = (annualRentMin + Math.random() * (annualRentMax - annualRentMin)) / 12;

            let rentConditionFactor = isGolden ? (0.8 + Math.random() * 0.2) : (0.5 + condition / 200);
            monthlyRent *= rentConditionFactor;

            // *** MODIFIED: Rent is lower during a Bust ***
            if (marketState === MARKET_STATES.BUST) {
                monthlyRent *= 0.8; // 20% lower rent in a bust
            } else if (marketState === MARKET_STATES.BOOM) {
                 monthlyRent *= 1.1; // 10% higher rent in a boom
            }


            return Math.max(50, Math.round(monthlyRent));
        }

        // *** MODIFIED: Adjust property price based on market state AND net worth ***
        function generateNewProperties() {
            if (typeof gamePropertyTypes === 'undefined' || !gamePropertyTypes) {
                console.error("CRITICAL: gamePropertyTypes is undefined or null in generateNewProperties!");
                availableProperties = []; return;
            }

            // *** NEW: Determine property tier probabilities based on net worth ***
            let netWorth = player.netWorth;
            let probs;

            if (netWorth < 5000000) {
                // Tier 1 (< 1M), Tier 2 (1-10M), Tier 3 (10M+)
                probs = { 1: 0.80, 2: 0.15, 3: 0.05 }; // 80% cheap, 15% mid, 5% expensive
            } else if (netWorth < 10000000) {
                probs = { 1: 0.60, 2: 0.30, 3: 0.10 };
            } else if (netWorth < 50000000) {
                probs = { 1: 0.40, 2: 0.45, 3: 0.15 };
            } else { // 50M+
                probs = { 1: 0.20, 2: 0.50, 3: 0.30 }; // 20% cheap, 50% mid, 30% expensive
            }
            // *** END NEW ***


            availableProperties = [];
            const numPropsToGenerate = Math.floor(Math.random() * (PROPERTIES_PER_MONTH_MAX - PROPERTIES_PER_MONTH_MIN + 1)) + PROPERTIES_PER_MONTH_MIN;
            let goldenAppearedThisMonth = false;

            // *** NEW: Filter property types based on probabilities ***
            const availableTiers = gamePropertyTypes.reduce((acc, type) => {
                if (!acc[type.priceTier]) {
                    acc[type.priceTier] = [];
                }
                acc[type.priceTier].push(type);
                return acc;
            }, {});
            // *** END NEW ***

            for (let i = 0; i < numPropsToGenerate; i++) {
                
                // *** NEW: Select a tier based on weighted probability ***
                let selectedTierList;
                const rand = Math.random();
                if (rand < probs[1]) {
                    selectedTierList = availableTiers[1];
                } else if (rand < probs[1] + probs[2]) {
                    selectedTierList = availableTiers[2];
                } else {
                    selectedTierList = availableTiers[3];
                }

                // Fallback logic in case a tier has no properties (shouldn't happen with current data)
                if (!selectedTierList || selectedTierList.length === 0) {
                    // Fallback to Tier 1
                    selectedTierList = availableTiers[1];
                    if (!selectedTierList || selectedTierList.length === 0) {
                         // Fallback to any property
                         selectedTierList = gamePropertyTypes;
                    }
                }
                
                const type = selectedTierList[Math.floor(Math.random() * selectedTierList.length)];
                // *** END NEW ***


                if (!type) { console.error("Error: Could not find property type for index", typeIndex); continue; }
                let price, initialCondition, estimatedRent; let isGolden = false;
                let basePrice = type.basePrice + Math.floor(Math.random() * type.priceRange);

                // Adjust price for market state
                let marketPriceMultiplier = 1.0;
                if (marketState === MARKET_STATES.BOOM) {
                    marketPriceMultiplier = 1.15; // 15% more expensive in boom
                } else if (marketState === MARKET_STATES.BUST) {
                    marketPriceMultiplier = 0.80; // 20% cheaper in bust
                }

                if (!goldenAppearedThisMonth && Math.random() < GOLDEN_OPPORTUNITY_CHANCE) {
                    isGolden = true; goldenAppearedThisMonth = true;
                    // Golden opportunities are less affected by market swings, but still slightly
                    price = Math.round(basePrice * (0.65 + Math.random() * 0.15) * (1 + (marketPriceMultiplier-1)/2) );
                    initialCondition = 85 + Math.random() * 15;
                    addLogEntry(`‚≠ê A Golden Opportunity appeared: ${type.name}!`);
                } else {
                    price = Math.round(basePrice * marketPriceMultiplier);
                    let conditionFactor = type.priceRange > 0 ? (price - type.basePrice) / type.priceRange : 1;
                    conditionFactor = Math.max(0, Math.min(1, conditionFactor));
                    let baseRandomCondition = 60 + Math.random() * 40;
                    initialCondition = baseRandomCondition - (1 - conditionFactor) * 40;
                    initialCondition = Math.max(20, Math.min(100, initialCondition));
                }

                estimatedRent = getEstimatedMonthlyRent(price, initialCondition, isGolden);

                availableProperties.push({
                    id: `P${Date.now().toString().slice(-4)}${i}`, name: type.name, price: price,
                    baseRentability: type.baseRentability, initialCondition: initialCondition,
                    estimatedRent: estimatedRent, isGolden: isGolden
                });
            }
            if (availableProperties.length > 0) {
                 addLogEntry(`Market update: ${availableProperties.length} new properties listed.`);
            } else if (numPropsToGenerate > 0) {
                 addLogEntry(`Market update: No properties met criteria this month.`);
            }
        }
        // *** END MODIFIED FUNCTION ***

        function generateJobOpportunities() {
            availableJobs = [];
            const currentPlayerJob = gameJobs.find(j => j.id === player.currentJobId);
            if (!currentPlayerJob) {
                console.error("Error: Current player job not found in generateJobOpportunities! ID:", player.currentJobId);
                return;
            }

            const potentialJobs = gameJobs.filter(job => {
                if (job.id === player.currentJobId) return false;
                let meetsPrereqs = true;
                if (job.prerequisites) {
                    const currentJobField = currentPlayerJob.field;
                    const prevJob = gameJobs.find(j => j.level === job.prerequisites.previousJobLevel && j.field === job.prerequisites.field);

                    if (job.prerequisites.field && currentJobField !== job.prerequisites.field && job.level > 0) {
                        meetsPrereqs = false;
                    }
                    if (meetsPrereqs && job.prerequisites.previousJobLevel !== undefined && currentPlayerJob.level < job.prerequisites.previousJobLevel) {
                        meetsPrereqs = false;
                    }
                    if (meetsPrereqs && job.prerequisites.minExperienceInFieldMonths) {
                        let experienceInTargetField = (currentJobField === job.field) ? player.totalExperienceInFieldMonths : 0;
                        if (experienceInTargetField < job.prerequisites.minExperienceInFieldMonths) {
                            meetsPrereqs = false;
                        }
                    }
                }
                if (!meetsPrereqs) return false;

                const salaryLowerBound = player.salary * 0.7;
                const salaryUpperBound = player.salary * 2.5;
                const isSalaryRelevant = job.salary >= salaryLowerBound && job.salary <= salaryUpperBound;

                // *** MODIFIED: Job availability tied to market state ***
                let marketAvailabilityFactor = 1.0;
                if (marketState === MARKET_STATES.BOOM) {
                    marketAvailabilityFactor = 1.2; // More jobs in boom
                } else if (marketState === MARKET_STATES.BUST) {
                     marketAvailabilityFactor = 0.6; // Fewer jobs in bust
                }


                if (job.field === currentPlayerJob.field && job.level === currentPlayerJob.level + 1 && Math.random() < marketAvailabilityFactor) return true;
                if (job.level === 0 && job.field !== currentPlayerJob.field && Math.random() < marketAvailabilityFactor) return true;
                if (isSalaryRelevant && Math.random() < 0.6 * marketAvailabilityFactor) return true;
                if (job.level === currentPlayerJob.level && job.field !== currentPlayerJob.field && Math.random() < 0.3 * marketAvailabilityFactor) return true;

                return Math.random() < 0.1 * marketAvailabilityFactor;
            });

            potentialJobs.sort(() => 0.5 - Math.random());
            availableJobs = potentialJobs.slice(0, MAX_JOB_LISTINGS);
        }

        // --- CORE GAME LOGIC ---

        function calculateNetWorth() {
            let propertyMarketValues = player.properties.reduce((sum, prop) => sum + (prop.currentMarketValue || prop.purchasePrice), 0);
            let totalPropertyLoan = player.properties.reduce((sum, prop) => sum + (prop.remainingLoan || 0), 0);
            let totalExternalLoan = player.externalLoans.reduce((sum, loan) => sum + (loan.remainingBalance || 0), 0);
            player.netWorth = player.cash + propertyMarketValues - totalPropertyLoan - totalExternalLoan;
            return player.netWorth;
        }
        
        // *** NEW: Function to update market state ***
        function updateMarketState() {
            marketStateMonths++;
            if (marketStateMonths < MARKET_STATE_MIN_DURATION_MONTHS) {
                return; // Don't change state too quickly
            }

            let changeOccurred = false;
            if (marketState === MARKET_STATES.NORMAL) {
                if (Math.random() < MARKET_STATE_NORMAL_TO_CHANGE_CHANCE) {
                    marketState = (Math.random() < 0.5) ? MARKET_STATES.BOOM : MARKET_STATES.BUST;
                    marketStateMonths = 0;
                    changeOccurred = true;
                    if (marketState === MARKET_STATES.BOOM) {
                        addLogEntry("ECONOMY: The market is BOOMING! Property values are soaring and sales are fast.");
                        showModal("Market Boom!", "Property values are rising rapidly, and buyers are eager!", 'success');
                    } else {
                        addLogEntry("ECONOMY: The market enters a BUST! Values are dropping, sales are slow, and risks are higher.");
                        showModal("Market Bust!", "Property values are falling, sales are difficult, and tenants may struggle.", 'error');
                    }
                }
            } else { // Boom or Bust state
                if (Math.random() < MARKET_STATE_BOOM_BUST_TO_NORMAL_CHANCE) {
                    marketState = MARKET_STATES.NORMAL;
                    marketStateMonths = 0;
                    changeOccurred = true;
                     addLogEntry("ECONOMY: The market cools down and returns to NORMAL conditions.");
                     showModal("Market Normalizes", "The economic situation has stabilized.", 'info');
                }
            }
            
            // Apply effects of the current market state
            applyMarketStateEffects();
        }

        // *** NEW: Function to apply effects based on market state ***
        function applyMarketStateEffects() {
            let firingRiskMultiplier = 1.0;
            let delinquencyMultiplier = 1.0;

            if (marketState === MARKET_STATES.BOOM) {
                BASE_CHANCE_OF_RECEIVING_OFFER = 0.30; // Easier to sell
                BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET = 0.02; // Buyers offer closer to market value
                BASE_TENANT_FIND_CHANCE = 0.4; // Easier to find tenants
                firingRiskMultiplier = 0.5; // Lower chance of being fired
                delinquencyMultiplier = 0.7; // Lower chance of delinquency
            } else if (marketState === MARKET_STATES.BUST) {
                BASE_CHANCE_OF_RECEIVING_OFFER = 0.05; // Harder to sell
                BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET = 0.15; // Buyers offer much lower
                BASE_TENANT_FIND_CHANCE = 0.15; // Harder to find tenants
                firingRiskMultiplier = 2.5; // Higher chance of being fired
                delinquencyMultiplier = 2.0; // Higher chance of delinquency
            } else { // Normal
                BASE_CHANCE_OF_RECEIVING_OFFER = 0.15;
                BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET = 0.05;
                BASE_TENANT_FIND_CHANCE = 0.3;
                firingRiskMultiplier = 1.0;
                delinquencyMultiplier = 1.0;
            }
            
            // Apply multipliers (ensure base constants are defined appropriately)
            CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION = 0.20 * delinquencyMultiplier;
            DELINQUENT_NON_PAYMENT_BASE_CHANCE = 0.25 * delinquencyMultiplier;
            // Update base firing risk (Note: Individual job firing risks still apply on top)
            // We'll apply this multiplier inside the firing check logic in advanceMonth
        }


        // *** NEW: Function to apply annual inflation ***
        function applyAnnualInflation() {
            // 1. Set new inflation rate (3% to 5%)
            currentInflationRate = (Math.random() * (0.05 - 0.03)) + 0.03;
            addLogEntry(`ECONOMY: Annual inflation is ${(currentInflationRate * 100).toFixed(1)}%. Prices and salaries are rising.`);
            
            const inflationFactor = 1 + currentInflationRate;

            // 2. Inflate base property prices
            gamePropertyTypes.forEach(type => {
                type.basePrice = Math.round(type.basePrice * inflationFactor);
                type.priceRange = Math.round(type.priceRange * inflationFactor);
            });

            // 3. Inflate all job salaries
            gameJobs.forEach(job => {
                job.salary = Math.round(job.salary * inflationFactor);
            });

            // 4. Inflate player's current salary (Cost-of-Living adjustment)
            const oldSalary = player.salary;
            player.salary = Math.round(player.salary * inflationFactor);
            addLogEntry(`Your salary received a cost-of-living adjustment of ${(currentInflationRate * 100).toFixed(1)}% (to $${formatCurrency(player.salary)}).`);


            // 5. Inflate misc. fees
            CLEANING_FEE_MIN = Math.round(CLEANING_FEE_MIN * inflationFactor);
            CLEANING_FEE_MAX = Math.round(CLEANING_FEE_MAX * inflationFactor);
            BANK_LOAN_APPLICATION_FEE = Math.round(BANK_LOAN_APPLICATION_FEE * inflationFactor);
        }

        function advanceMonth() {
            try {
                const cashBeforeMonth = player.cash;

                // *** NEW: Update market state FIRST ***
                updateMarketState();

                // *** NEW: Clear all disaster icons at the start of the month ***
                player.properties.forEach(prop => {
                    prop.hasDisasterIcon = false;
                    prop.disasterIcon = '';
                });

                if (!firstMonthAdvanced) {
                    if (gameHeaderEl) gameHeaderEl.classList.add('header-hidden');
                    firstMonthAdvanced = true;
                }

                currentMonth++; player.ageMonths++; player.cash += player.salary;
                addLogEntry(`Payday! Received $${formatCurrency(player.salary)} salary.`);
                player.experienceInCurrentJobMonths++;
                player.totalExperienceInFieldMonths++;

                if (player.bankLoanCooldown > 0) {
                    player.bankLoanCooldown--;
                    if (player.bankLoanCooldown === 0) {
                        addLogEntry("You can now apply for a bank loan again.");
                        showModal("Loan Cooldown Over", "Your 3-month bank loan application cooldown has ended.", 'info');
                    }
                }

                // --- FIRING LOGIC ---
                const currentJobForFiringCheck = gameJobs.find(j => j.id === player.currentJobId);
                let effectiveFiringRisk = 0;
                let marketFiringMultiplier = 1.0; // *** NEW: Get market multiplier ***
                if (marketState === MARKET_STATES.BUST) {
                    marketFiringMultiplier = 2.5;
                } else if (marketState === MARKET_STATES.BOOM) {
                    marketFiringMultiplier = 0.5;
                }

                if (currentJobForFiringCheck && player.currentJobId !== "unskilled0") {
                    // *** MODIFIED: Apply market multiplier to firing risk ***
                    effectiveFiringRisk = (currentJobForFiringCheck.firingRisk || BASE_FIRING_RISK) * marketFiringMultiplier;
                }

                if (effectiveFiringRisk > 0 && Math.random() < effectiveFiringRisk) {
                    const oldJob = currentJobForFiringCheck;
                    const baseJob = gameJobs.find(j => j.id === "unskilled0");
                    if (oldJob && baseJob) {
                        const oldJobTitle = oldJob.title;
                        player.currentJobId = baseJob.id;
                        player.salary = baseJob.salary;
                        player.experienceInCurrentJobMonths = 0;
                        player.totalExperienceInFieldMonths = 0;
                        addLogEntry(`DISASTER! You were fired from your job as ${oldJobTitle}! You are now ${baseJob.title}.`);
                        showModal("You've Been Fired!", `You lost your job as ${oldJobTitle} and are now ${baseJob.title}, earning $${formatCurrency(baseJob.salary)}.`, 'error');
                    }
                }
                // --- END FIRING LOGIC ---


                const currentJob = gameJobs.find(j => j.id === player.currentJobId);
                if (currentJob) {
                    // *** MODIFIED: This is now a "Merit Raise" on top of inflation ***
                    if (player.experienceInCurrentJobMonths > 0 && player.experienceInCurrentJobMonths % 12 === 0 && currentJob.annualIncrementPercent > 0) {
                        const oldSalary = player.salary;
                        player.salary = Math.round(player.salary * (1 + currentJob.annualIncrementPercent));
                        addLogEntry(`Annual merit raise at ${currentJob.title}! New salary: $${formatCurrency(player.salary)} (was $${formatCurrency(oldSalary)}).`);
                        showModal("Annual Merit Raise!", `You received an annual merit raise. Your new salary is $${formatCurrency(player.salary)}.`, 'success');
                    }

                    // *** MODIFIED: Job Bonus Logic as per user request ***
                    if (currentJob.companyAnnualBonusChance && currentMonth % 12 === 11) { // Check for bonus at end of year (11th month)
                        if (Math.random() < currentJob.companyAnnualBonusChance) {

                            // Define the range for the bonus
                            const maxBonusPercent = currentJob.companyAnnualBonusPercent;
                            // Lower level jobs get a smaller, less reliable bonus (e.g., 20-100% of the 'maxBonusPercent')
                            // Higher level jobs get a more reliable bonus (e.g., 60-100% of the 'maxBonusPercent')
                            const minBonusPercent = maxBonusPercent * (0.2 + (currentJob.level * 0.1));

                            // Calculate a random bonus within that range
                            const actualBonusPercent = minBonusPercent + (Math.random() * (maxBonusPercent - minBonusPercent));
                            const bonusAmount = Math.round((player.salary * 12) * actualBonusPercent);

                            player.cash += bonusAmount;
                            addLogEntry(`Received an annual bonus of $${formatCurrency(bonusAmount)} from ${currentJob.title}!`);
                            showModal("Annual Bonus!", `Congratulations! You received an annual bonus of $${formatCurrency(bonusAmount)}.`, 'success');
                        }
                    }
                    // *** END MODIFIED BONUS LOGIC ***

                    if (currentJob.promotionTo && currentJob.promotionChance && currentJob.promotionChanceMonths &&
                        player.experienceInCurrentJobMonths >= currentJob.promotionChanceMonths &&
                        Math.random() < currentJob.promotionChance) {
                        const newJob = gameJobs.find(j => j.id === currentJob.promotionTo);
                        if (newJob) {
                            addLogEntry(`üéâ PROMOTION! You've been promoted from ${currentJob.title} to ${newJob.title}!`);
                            showModal("Promotion!", `Congratulations! You've been promoted to ${newJob.title} with a salary of $${formatCurrency(newJob.salary)}.`, 'success');
                            const oldJobField = currentJob.field;
                            player.currentJobId = newJob.id;
                            player.salary = newJob.salary; // Salary is pulled from the (inflated) gameJobs data
                            player.experienceInCurrentJobMonths = 0;
                            if (oldJobField !== newJob.field) {
                                player.totalExperienceInFieldMonths = 0;
                            }
                        }
                    }
                } else {
                    console.error("Player current job is undefined in advanceMonth:", player.currentJobId);
                }


                let totalExternalLoanPayments = 0;
                for (let i = player.externalLoans.length - 1; i >= 0; i--) {
                    const loan = player.externalLoans[i];
                    const interestThisMonth = loan.remainingBalance * loan.monthlyInterestRate;
                    const principalPayment = loan.monthlyPayment - interestThisMonth;
                    player.cash -= loan.monthlyPayment;
                    loan.remainingBalance -= principalPayment;
                    loan.remainingBalance = Math.max(0, loan.remainingBalance);
                    loan.monthsPaid++;
                    totalExternalLoanPayments += loan.monthlyPayment;
                    if (loan.remainingBalance <= 0.01 || loan.monthsPaid >= loan.termMonths) {
                        const loanType = loan.type === 'risky' ? 'Risky Loan' : 'Bank Loan';
                        addLogEntry(`${loanType} (ID: ${loan.id}) of $${formatCurrency(loan.principal)} has been fully paid off!`);
                        showModal(`${loanType} Paid Off!`, `Your ${loanType} (ID: ${loan.id}) is now fully paid.`, 'success');
                        player.externalLoans.splice(i, 1);
                    }
                }
                if (totalExternalLoanPayments > 0) addLogEntry(`Paid $${formatCurrency(totalExternalLoanPayments)} for external loan installments.`);

                // *** MODIFIED: Annual inflation and market-based appreciation logic ***
                if (currentMonth > 0 && currentMonth % 12 === 0) {
                    // 1. Apply inflation first
                    applyAnnualInflation();

                    // 2. Apply market appreciation based on market state
                    addLogEntry("Annual market review...");
                    let marketAppreciationRate = 0;
                    if (marketState === MARKET_STATES.BOOM) {
                        marketAppreciationRate = ANNUAL_APPRECIATION_BOOM;
                    } else if (marketState === MARKET_STATES.BUST) {
                        marketAppreciationRate = ANNUAL_APPRECIATION_BUST;
                    } else { // Normal
                        marketAppreciationRate = ANNUAL_APPRECIATION_NORMAL;
                    }

                    player.properties.forEach(prop => {
                        // Appreciation is now inflation + market factor + small random factor
                        const randomFactor = (Math.random() * 0.04) - 0.02; // +/- 2% randomness
                        const totalAppreciationRate = currentInflationRate + marketAppreciationRate + randomFactor;

                        prop.currentMarketValue = Math.round(prop.currentMarketValue * (1 + totalAppreciationRate));

                        addLogEntry(`${prop.name} market value changed by ${(totalAppreciationRate * 100).toFixed(1)}% to $${formatCurrency(prop.currentMarketValue)}.`);
                    });
                    showModal("Market Update", `Annual inflation: ${(currentInflationRate * 100).toFixed(1)}%. Market state: ${marketState}. Property values and salaries updated.`, 'info');
                }
                // *** END MODIFIED ***

                let totalPropertyExpenses = 0, totalRentalIncome = 0;
                player.properties.forEach((prop, index) => {
                    if (prop.monthsOwned === undefined) { prop.monthsOwned = prop.monthsPaid || 0; }
                    prop.monthsOwned++;

                    if (prop.remainingLoan > 0) {
                        const paymentThisMonth = Math.min(prop.monthlyInstallment, prop.remainingLoan);
                        player.cash -= paymentThisMonth; prop.remainingLoan -= paymentThisMonth; prop.monthsPaid++; totalPropertyExpenses += paymentThisMonth;
                        if (prop.remainingLoan <= 0) { addLogEntry(`${prop.name} is fully paid off!`); showModal("Property Paid Off!", `${prop.name} is now fully yours!`, 'success'); }
                    }
                    player.cash -= prop.monthlyFees; totalPropertyExpenses += prop.monthlyFees;

                    if (Math.random() < RANDOM_DAMAGE_EVENT_CHANCE) {
                        let incidentDamage = RANDOM_DAMAGE_MIN_PERCENT + Math.random() * (RANDOM_DAMAGE_MAX_PERCENT - RANDOM_DAMAGE_MIN_PERCENT);
                        prop.condition -= incidentDamage;
                        prop.hasDisasterIcon = true;
                        prop.disasterIcon = 'üîß';
                        addLogEntry(`ALERT! ${prop.name} suffered damage, losing ${incidentDamage.toFixed(1)}% condition.`);
                        showModal("Property Incident!", `${prop.name} condition dropped by ${incidentDamage.toFixed(1)}%! Consider renovating.`, 'warning');
                    }

                    if (Math.random() < DISASTER_EVENT_CHANCE) {
                        const disasters = [{name: "Fire", icon: 'üî•'}, {name: "Flood", icon: 'üåä'}, {name: "Earthquake", icon: 'üí•'}];
                        const disaster = disasters[Math.floor(Math.random() * disasters.length)];
                        let disasterDamage = DISASTER_DAMAGE_MIN_PERCENT + Math.random() * (DISASTER_DAMAGE_MAX_PERCENT - DISASTER_DAMAGE_MIN_PERCENT);

                        prop.condition -= disasterDamage;
                        prop.condition = Math.max(0, prop.condition);
                        prop.hasDisasterIcon = true;
                        prop.disasterIcon = disaster.icon;

                        addLogEntry(`DISASTER! A ${disaster.name} hit ${prop.name}, causing ${disasterDamage.toFixed(1)}% damage. Condition: ${prop.condition.toFixed(1)}%.`);
                        showModal("Natural Disaster!", `A ${disaster.name} struck ${prop.name}! Condition dropped by ${disasterDamage.toFixed(1)}%! You should renovate.`, 'error');
                    }

                    prop.condition -= (prop.isRented ? CONDITION_DECAY_RENTED_PER_MONTH : CONDITION_DECAY_VACANT_PER_MONTH);
                    prop.condition = Math.max(0, prop.condition);

                    if (prop.isBeingMarketed) {
                        prop.marketingMonths++;
                        let campaignSuccess = false; let logMsg = ""; let campaignEnded = false;

                        if (prop.wasListedForRent) {
                            if (prop.marketingMonths === 1 && Math.random() < MARKETING_SALE_CHANCE_MONTH_1) {
                                campaignSuccess = true; logMsg = `Fast Marketing (Month 1) for ${prop.name} rent succeeded!`;
                            } else if (prop.marketingMonths === 2) {
                                campaignSuccess = true; logMsg = `Marketing Campaign (Month 2) for ${prop.name} rent succeeded!`;
                            }
                        } else {
                            if (prop.marketingMonths === 1 && Math.random() < MARKETING_SALE_CHANCE_MONTH_1) {
                                campaignSuccess = true; logMsg = `Fast Marketing (Month 1) for ${prop.name} sale succeeded!`;
                            } else if (prop.marketingMonths === 2) {
                                if (Math.random() < MARKETING_SALE_CHANCE_MONTH_2) {
                                   campaignSuccess = true; logMsg = `Marketing Campaign (Month 2) for ${prop.name} sale succeeded!`;
                                } else {
                                   campaignEnded = true;
                                   logMsg = `MARKETING FAILED: Fast Sale campaign for ${prop.name} did not find a buyer after 2 months.`;
                                   showModal("Marketing Failed", `The Fast Sale campaign for ${prop.name} ended without finding a suitable buyer. The property has been de-listed.`, 'error');
                                   prop.isListedForSale = false; prop.askingPrice = 0; prop.timeOnMarket = 0;
                                }
                            }
                        }

                        if (campaignSuccess) {
                            addLogEntry(logMsg);
                            if (prop.wasListedForRent) { forceFindTenant(prop); } else { forceFindBuyer(prop, index); }
                            prop.isBeingMarketed = false; prop.marketingMonths = 0; prop.wasListedForRent = false;
                        } else if (campaignEnded) {
                            addLogEntry(logMsg);
                            prop.isBeingMarketed = false; prop.marketingMonths = 0; prop.wasListedForRent = false;
                        } else if (prop.marketingMonths === 1) {
                             addLogEntry(`Marketing (Month 1) for ${prop.name} found no one. Trying again...`);
                        }

                    } else if (prop.isListedForSale) {
                        prop.timeOnMarket++;
                        // *** MODIFIED: Use BASE_CHANCE_OF_RECEIVING_OFFER which changes with market state ***
                        let offerChance = BASE_CHANCE_OF_RECEIVING_OFFER;
                        const priceRatio = prop.askingPrice > 0 ? prop.askingPrice / prop.currentMarketValue : 1;
                        if (priceRatio > 1) offerChance -= (priceRatio - 1) * ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE * 5;
                        else offerChance += (1 - priceRatio) * ASKING_PRICE_SENSITIVITY_FOR_OFFER_CHANCE * 2;
                        offerChance += (prop.condition / 100 - 0.5) * CONDITION_SENSITIVITY_FOR_OFFER_CHANCE * 100;
                        offerChance = Math.max(0.01, Math.min(0.9, offerChance));

                        if (Math.random() < offerChance) {
                            // *** MODIFIED: Use BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET which changes with market state ***
                            let buyerOffer = prop.currentMarketValue * (1 - BUYER_OFFER_DISCOUNT_BASE_FROM_MARKET);
                            const conditionPenaltyFactor = (100 - prop.condition) / 100;
                            buyerOffer *= (1 - (BUYER_OFFER_CONDITION_PENALTY_MAX * conditionPenaltyFactor));
                            
                            // Buyers might offer asking price in boom, rarely in bust
                            let askingPriceOfferChance = 0.1;
                            if (marketState === MARKET_STATES.BOOM) askingPriceOfferChance = 0.4;
                            else if (marketState === MARKET_STATES.BUST) askingPriceOfferChance = 0.01;

                            if (prop.askingPrice < buyerOffer && prop.askingPrice > 0 && Math.random() < askingPriceOfferChance) {
                                buyerOffer = prop.askingPrice + Math.random() * (buyerOffer - prop.askingPrice); // Offer between asking and their calculated offer
                            } else if (prop.askingPrice > 0 && buyerOffer > prop.askingPrice) {
                                buyerOffer = prop.askingPrice * (0.95 + Math.random() * 0.05); // Don't offer significantly MORE than asking
                            }

                            currentOfferForProperty = Math.round(Math.max(0, buyerOffer));
                            addLogEntry(`OFFER RECEIVED for ${prop.name}! Buyer offers $${formatCurrency(currentOfferForProperty)} (Asking: $${formatCurrency(prop.askingPrice)}).`);
                            openOfferModal(index, currentOfferForProperty);
                        }
                    } else if (!prop.isListedForSale) {
                        if (prop.isRented) {
                            if (prop.tenantFirstMonthFree) {
                                prop.tenantFirstMonthFree = false;
                                addLogEntry(`New tenant at ${prop.name} gets their first month free (marketing deal).`);
                            } else {
                                let tenantPaidThisMonth = true;
                                if (prop.isDelinquent) {
                                    // *** MODIFIED: Use DELINQUENT_NON_PAYMENT_BASE_CHANCE which changes with market state ***
                                    let nonPaymentChance = DELINQUENT_NON_PAYMENT_BASE_CHANCE + (prop.delinquentMonths * DELINQUENT_NON_PAYMENT_ESCALATION_PER_MONTH);
                                    nonPaymentChance = Math.min(nonPaymentChance, DELINQUENT_MAX_NON_PAYMENT_CHANCE);
                                    if (Math.random() < nonPaymentChance) {
                                        tenantPaidThisMonth = false; prop.delinquentMonths++;
                                        addLogEntry(`BAD TENANT: ${prop.name} did not pay rent (Cond: ${prop.condition.toFixed(1)}%). ${prop.delinquentMonths} months unpaid.`);
                                        showModal("Rent Not Paid!", `Tenant at ${prop.name} is delinquent and did not pay rent. Improve property condition!`, 'warning');
                                    } else { player.cash += prop.currentRent; totalRentalIncome += prop.currentRent; addLogEntry(`Delinquent tenant at ${prop.name} paid $${formatCurrency(prop.currentRent)}.`); }
                                } else if (prop.condition < BAD_TENANT_CONDITION_THRESHOLD && Math.random() < CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION) { // *** MODIFIED: Use CHANCE_BECOME_DELINQUENT_IF_LOW_CONDITION which changes ***
                                    prop.isDelinquent = true; prop.delinquentMonths = 1; tenantPaidThisMonth = false;
                                    addLogEntry(`WARNING: Tenant at ${prop.name} became delinquent (Cond: ${prop.condition.toFixed(1)}%) and stopped paying!`);
                                    showModal("Tenant Delinquent!", `Tenant at ${prop.name} became delinquent due to poor condition and has not paid rent!`, 'warning');
                                }
                                if (tenantPaidThisMonth && !prop.isDelinquent) { player.cash += prop.currentRent; totalRentalIncome += prop.currentRent; }
                            }

                            if (prop.isDelinquent && prop.condition >= CONDITION_THRESHOLD_TO_CURE_DELINQUENCY) {
                                if (Math.random() < CHANCE_CURE_DELINQUENCY_IF_RENOVATED) {
                                    prop.isDelinquent = false; prop.delinquentMonths = 0;
                                    addLogEntry(`GOOD NEWS: Tenant at ${prop.name} resumed payments after renovation!`);
                                    showModal("Tenant Recovered!", `Tenant at ${prop.name} is no longer delinquent and resumed payments.`, 'success');
                                }
                            }
                            prop.tenantMonths++;
                            if (prop.tenantMonths >= MIN_TENANT_STAY_MONTHS && Math.random() < CHANCE_TENANT_LEAVES_AFTER_MIN) {
                                addLogEntry(`Tenant left ${prop.name}.`); showModal("Tenant Left", `Tenant at ${prop.name} moved out.`, 'info');
                                prop.isRented = false; prop.isListedForRent = true; prop.currentRent = 0; prop.tenantMonths = 0;
                                prop.isDelinquent = false; prop.delinquentMonths = 0;
                                const cleaningFee = CLEANING_FEE_MIN + Math.random() * (CLEANING_FEE_MAX - CLEANING_FEE_MIN);
                                player.cash -= cleaningFee; totalPropertyExpenses += cleaningFee;
                                addLogEntry(`Paid $${formatCurrency(cleaningFee)} cleaning fee for ${prop.name}.`);
                                prop.condition -= Math.random() * 5; prop.condition = Math.max(0, prop.condition);
                                if (prop.condition < 30) addLogEntry(`${prop.name} poor condition (${prop.condition.toFixed(1)}%) after tenant. Renovate?`);
                            }
                        } else if (prop.isListedForRent) {
                            const effectiveRentability = prop.baseRentability * (prop.condition / 100);
                            // *** MODIFIED: Use BASE_TENANT_FIND_CHANCE which changes with market state ***
                            if (Math.random() < BASE_TENANT_FIND_CHANCE * effectiveRentability) {
                                prop.isRented = true; prop.isListedForRent = false; prop.isDelinquent = false; prop.delinquentMonths = 0;
                                prop.currentRent = getEstimatedMonthlyRent(prop.currentMarketValue, prop.condition);
                                prop.tenantMonths = 0;
                                addLogEntry(`${prop.name} rented for $${formatCurrency(prop.currentRent)}/month!`);
                                showModal("Tenant Found!", `Tenant for ${prop.name} at $${formatCurrency(prop.currentRent)}/month.`, 'success');
                            }
                        }
                    }
                });
                if (totalRentalIncome > 0) addLogEntry(`Total rental income: $${formatCurrency(totalRentalIncome)}.`);
                if (totalPropertyExpenses > 0) addLogEntry(`Total property expenses: $${formatCurrency(totalPropertyExpenses)}.`);

                if (currentMonth > MIN_MONTHS_FOR_LOAN_AD && Math.random() < LOAN_AD_CHANCE && externalLoanModal.style.display !== 'block' && loanAdModal.style.display !== 'block' && messageModal.style.display !== 'block') {
                    openLoanAdModal();
                }

                generateNewProperties();
                generateJobOpportunities();

                player.lastMonthCashChange = player.cash - cashBeforeMonth;

                updateAllUI();
                saveGame();

                if (player.cash < BANKRUPTCY_THRESHOLD && !nextMonthBtn.disabled) {
                    gameOverTitleEl.textContent = "Game Over: Bankruptcy!";
                    gameOverMessageEl.textContent = `Your cash fell below $${formatCurrency(BANKRUPTCY_THRESHOLD)}! Your final net worth was $${formatCurrency(player.netWorth)}.`;
                    gameOverOverlayEl.style.display = 'flex';
                    addLogEntry("GAME OVER: You are bankrupt!");
                    nextMonthBtn.disabled = true; nextMonthBtn.classList.add('button-disabled'); nextMonthBtn.textContent = "Game Over";
                } else if (player.ageMonths >= player.deathAgeMonths && !nextMonthBtn.disabled) {
                    const finalAgeYears = Math.floor(player.ageMonths / 12);
                    gameOverTitleEl.textContent = "Time's Up!";
                    gameOverMessageEl.textContent = `You lived a full life to the age of ${finalAgeYears}! Your final net worth is $${formatCurrency(player.netWorth)}. Thanks for playing!`;
                    gameOverOverlayEl.style.display = 'flex';
                    addLogEntry(`GAME ENDED: Reached age ${finalAgeYears}. Final Net Worth: $${formatCurrency(player.netWorth)}`);
                    nextMonthBtn.disabled = true; nextMonthBtn.classList.add('button-disabled'); nextMonthBtn.textContent = "Game Ended";
                }

            } catch (e) {
                console.error("Critical error in advanceMonth:", e);
                showModal("Critical Error", "A critical error occurred. Please check the console and consider refreshing.", 'error');
            }
        }

		function forceFindTenant(prop) {
            prop.isRented = true;
            prop.isListedForRent = false;
            prop.isDelinquent = false;
            prop.delinquentMonths = 0;
            const newRent = getEstimatedMonthlyRent(prop.currentMarketValue, prop.condition);
            prop.currentRent = newRent;
            prop.tenantMonths = 0;
            prop.tenantFirstMonthFree = true;
            addLogEntry(`MARKETING SUCCESS: ${prop.name} rented for $${formatCurrency(prop.currentRent)}/month! (First month free).`);
            showModal("Tenant Found!", `Marketing campaign found a tenant for ${prop.name} at $${formatCurrency(prop.currentRent)}/month. They get the first month free as part of the deal.`, 'success');
        }

        function forceFindBuyer(prop, index) {
            let buyerOffer = prop.askingPrice * (0.95 + Math.random() * 0.05);
            currentOfferForProperty = Math.round(Math.max(0, buyerOffer));
            prop.isListedForSale = true;
            addLogEntry(`MARKETING SUCCESS: Offer for ${prop.name}! Buyer offers $${formatCurrency(currentOfferForProperty)} (Asking: $${formatCurrency(prop.askingPrice)}).`);
            openOfferModal(index, currentOfferForProperty);
        }

        // --- ACTION/MODAL FUNCTIONS ---

        window.openLoanTermModal = function(index) {
            propertyToManageIndex = index;
            const prop = availableProperties[index];
            if (!prop) return;
            const downPayment = prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
            if (player.cash < downPayment) {
                showModal("Not Enough Cash", `Need $${formatCurrency(downPayment)}, have $${formatCurrency(player.cash)}.`, 'warning'); return;
            }
            loanTermModalTitleEl.textContent = `Finance Purchase: ${prop.name}`;
            loanPropertyDetailsEl.innerHTML = `<p><strong>Price:</strong> $${formatCurrency(prop.price)}</p><p><strong>Est. Rent:</strong> $${formatCurrency(prop.estimatedRent)}/month</p><p><strong>Down Payment (20%):</strong> $${formatCurrency(downPayment)}</p><p><strong>Loan Amount:</strong> $${formatCurrency(prop.price - downPayment)}</p><p><strong>Initial Condition:</strong> ${prop.initialCondition.toFixed(1)}%</p>`;
            loanTermOptionsContainerEl.innerHTML = '';
            AVAILABLE_LOAN_TERMS.forEach(term => {
                const loanAmount = prop.price - downPayment; const monthlyPayment = loanAmount / term.months;
                const optionDiv = document.createElement('div'); optionDiv.className = 'loan-term-option';
                optionDiv.innerHTML = `<input type="radio" id="term-${term.months}" name="loanTerm" value="${term.months}" ${term.months === selectedLoanTermMonths ? 'checked' : ''}><label for="term-${term.months}">${term.years} Years (Monthly: $${formatCurrency(monthlyPayment)})</label>`;
                loanTermOptionsContainerEl.appendChild(optionDiv);
            });
            document.querySelectorAll('input[name="loanTerm"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedLoanTermMonths = parseInt(this.value);
                    const loanAmount = prop.price - (prop.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE);
                    loanTermSelectedPaymentEl.textContent = formatCurrency(loanAmount / selectedLoanTermMonths);
                });
            });
            const defaultRadio = document.querySelector('input[name="loanTerm"]:checked');
            if(defaultRadio) defaultRadio.dispatchEvent(new Event('change'));
            loanTermModal.style.display = 'block';
        }

        confirmLoanBtn.onclick = function() {
            const propToBuy = availableProperties[propertyToManageIndex];
            if (!propToBuy) return;
            const downPayment = propToBuy.price * PROPERTY_DOWN_PAYMENT_PERCENTAGE;
            const loanAmount = propToBuy.price - downPayment;
            const chosenTermMonths = parseInt(document.querySelector('input[name="loanTerm"]:checked').value);
            const monthlyInstallment = loanAmount / chosenTermMonths;
            const monthlyFees = (propToBuy.price * PROPERTY_FEES_PERCENTAGE_ANNUAL) / 12;
            player.cash -= downPayment;

            // *** NEW: Add disasterIcon flags to new property ***
            const newOwnedProperty = {
                id: propToBuy.id, name: propToBuy.name, purchasePrice: propToBuy.price,
                currentMarketValue: propToBuy.price, baseRentability: propToBuy.baseRentability,
                downPaymentPaid: downPayment, loanAmount: loanAmount, remainingLoan: loanAmount,
                monthlyInstallment: monthlyInstallment, monthlyFees: monthlyFees, monthsPaid: 0,
                condition: propToBuy.initialCondition, isRented: false, isListedForRent: false,
                currentRent: 0, tenantMonths: 0, isDelinquent: false, delinquentMonths: 0,
                isListedForSale: false, askingPrice: 0, timeOnMarket: 0, loanTermMonths: chosenTermMonths,
                isBeingMarketed: false, marketingMonths: 0, wasListedForRent: false, tenantFirstMonthFree: false,
                monthsOwned: 0,
                hasDisasterIcon: false, // NEW
                disasterIcon: ''        // NEW
            };
            // *** END NEW ***

            player.properties.push(newOwnedProperty);
            addLogEntry(`Bought ${propToBuy.name} for $${formatCurrency(propToBuy.price)} (${chosenTermMonths/12}-yr loan).`);
            showModal("Purchase Successful!", `Bought ${propToBuy.name}! Cash: $${formatCurrency(player.cash)}.`, 'success');
            availableProperties.splice(propertyToManageIndex, 1);
            loanTermModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI(); saveGame();
        }
        cancelLoanBtn.onclick = function() { loanTermModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.toggleListingStatus = function(index) {
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop || prop.isRented || prop.isDelinquent || prop.isListedForSale || prop.isBeingMarketed) {
                 if(prop.isDelinquent) showModal("Action Blocked", "Cannot change listing status while tenant is delinquent.", 'warning');
                 if(prop.isListedForSale) showModal("Action Blocked", "Property is currently listed for sale. De-list it first to manage rentals.", 'warning');
                 if(prop.isBeingMarketed) showModal("Action Blocked", "Property is currently being marketed.", 'warning');
                return;
            }
            prop.isListedForRent = !prop.isListedForRent;
            addLogEntry(prop.isListedForRent ? `${prop.name} listed for rent.` : `Cancelled rent listing for ${prop.name}.`);
            updateAllUI(); saveGame();
        }

        window.openManageRentalModal = function(index) {
            propertyToManageIndex = index;
            const prop = player.properties[index];
            if (!prop) return;

            if (prop.isDelinquent) {
                evictTenantModalTitleEl.textContent = `Evict Delinquent Tenant: ${prop.name}`;
                evictTenantPropertyInfoEl.innerHTML = `<p class="font-bold text-red-600">This tenant is ${prop.delinquentMonths} months behind on rent.</p><p>Property Condition: ${prop.condition.toFixed(1)}%</p>`;
            } else {
                evictTenantModalTitleEl.textContent = `Manage Rental: ${prop.name}`;
                evictTenantPropertyInfoEl.innerHTML = `<p>Tenant has been paying rent for ${prop.tenantMonths} months.</p><p>Property Condition: ${prop.condition.toFixed(1)}%</p>`;
            }
            evictTenantModal.style.display = 'block';
        }

        confirmEvictBtn.onclick = function() {
            if (propertyToManageIndex === -1) return;
            const prop = player.properties[propertyToManageIndex];
            if (!prop) return;

            prop.isRented = false;
            prop.isListedForRent = false;
            prop.currentRent = 0;
            prop.tenantMonths = 0;
            prop.isDelinquent = false;
            prop.delinquentMonths = 0;
            prop.tenantFirstMonthFree = false;

            let damageMessage = `Tenant has been evicted from ${prop.name}. The property is now vacant.`;

            if (Math.random() < EVICTION_DAMAGE_CHANCE) {
                const damagePercent = EVICTION_DAMAGE_MIN_PERCENT + Math.random() * (EVICTION_DAMAGE_MAX_PERCENT - EVICTION_DAMAGE_MIN_PERCENT);
                prop.condition -= damagePercent;
                prop.condition = Math.max(0, prop.condition);
                damageMessage = `The evicted tenant from ${prop.name} got angry and caused ${damagePercent.toFixed(1)}% damage! Condition is now ${prop.condition.toFixed(1)}%.`;
                // *** NEW: Add disaster icon ***
                prop.hasDisasterIcon = true;
                prop.disasterIcon = 'üò†';
                addLogEntry(`ALERT: Evicted tenant damaged ${prop.name} by ${damagePercent.toFixed(1)}%.`);
                showModal("Tenant Evicted (Damaged)!", damageMessage, 'error');
            } else {
                addLogEntry(`Evicted tenant from ${prop.name}. Property is vacant.`);
                showModal("Tenant Evicted", damageMessage, 'success');
            }

            evictTenantModal.style.display = 'none';
            propertyToManageIndex = -1;
            updateAllUI();
            saveGame();
        }

        cancelEvictBtn.onclick = function() {
            evictTenantModal.style.display = 'none';
            propertyToManageIndex = -1;
        }


        window.openRenovationModal = function(index) {
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop) return;

            const costPerPoint = getRenovationCostPerPoint(prop);
            const pointsToMax = 100 - prop.condition;

            renovationModalTitleEl.textContent = `Renovate ${prop.name}`;
            renovationModalTextEl.textContent = `Current Condition: ${prop.condition.toFixed(1)}%`;
            renovationModalInfoEl.textContent = `Cost per 1% repair: $${formatCurrency(costPerPoint)}.`;

            let cost10 = costPerPoint * 10;
            let pointsToGain10 = 10;
            if (prop.condition + 10 > 100) {
                pointsToGain10 = pointsToMax;
                cost10 = costPerPoint * pointsToGain10;
            }
            renovate10CostEl.textContent = `Cost: $${formatCurrency(cost10)}`;
            if (player.cash < cost10 || pointsToGain10 <= 0.01) {
                renovate10Btn.disabled = true;
                renovate10Btn.classList.add('button-disabled');
                if (pointsToGain10 <= 0.01) renovate10CostEl.textContent = "Fully Repaired";
                else if (player.cash < cost10) renovate10CostEl.textContent = `Cost: $${formatCurrency(cost10)} (Not enough cash)`;
            } else {
                renovate10Btn.disabled = false;
                renovate10Btn.classList.remove('button-disabled');
            }

            let cost20 = costPerPoint * 20;
            let pointsToGain20 = 20;
            if (prop.condition + 20 > 100) {
                pointsToGain20 = pointsToMax;
                cost20 = costPerPoint * pointsToGain20;
            }
            renovate20CostEl.textContent = `Cost: $${formatCurrency(cost20)}`;
            if (player.cash < cost20 || pointsToGain20 <= 0.01) {
                renovate20Btn.disabled = true;
                renovate20Btn.classList.add('button-disabled');
                if (pointsToGain20 <= 0.01) renovate20CostEl.textContent = "Fully Repaired";
                else if (player.cash < cost20) renovate20CostEl.textContent = `Cost: $${formatCurrency(cost20)} (Not enough cash)`;
            } else {
                renovate20Btn.disabled = false;
                renovate20Btn.classList.remove('button-disabled');
            }

            const costMax = costPerPoint * pointsToMax;
            renovateMaxPercentEl.textContent = pointsToMax.toFixed(1);
            renovateMaxCostEl.textContent = `Cost: $${formatCurrency(costMax)}`;
            if (player.cash < costMax || pointsToMax <= 0.01) {
                renovateMaxBtn.disabled = true;
                renovateMaxBtn.classList.add('button-disabled');
                if (pointsToMax <= 0.01) renovateMaxCostEl.textContent = "Fully Repaired";
                else if (player.cash < costMax) renovateMaxCostEl.textContent = `Cost: $${formatCurrency(costMax)} (Not enough cash)`;
            } else {
                renovateMaxBtn.disabled = false;
                renovateMaxBtn.classList.remove('button-disabled');
            }

            renovationModal.style.display = 'block';
        }

        function processRenovation(percentToRepair) {
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            const costPerPoint = getRenovationCostPerPoint(prop);

            const pointsToMax = 100 - prop.condition;
            let pointsToRepair = Math.min(percentToRepair, pointsToMax);
            pointsToRepair = Math.max(0, pointsToRepair);

            let amountSpent = costPerPoint * pointsToRepair;

            if (amountSpent > player.cash) {
                 showModal("Error", "You do not have enough cash for this renovation.", 'error');
                 return;
            }
            if (pointsToRepair <= 0.01) {
                 showModal("Already Perfect", `${prop.name} is already at or near 100% condition.`, 'info');
                 renovationModal.style.display = 'none'; propertyToManageIndex = -1; return;
            }

            player.cash -= amountSpent;
            const conditionImproved = pointsToRepair;
            prop.condition = Math.min(100, prop.condition + conditionImproved);

            addLogEntry(`Spent $${formatCurrency(amountSpent)} renovating ${prop.name} by ${conditionImproved.toFixed(1)}%. Cond: ${prop.condition.toFixed(1)}%.`);
            showModal("Renovation Complete", `${prop.name} cond: ${prop.condition.toFixed(1)}%.`, 'success');
            renovationModal.style.display = 'none'; propertyToManageIndex = -1; updateAllUI(); saveGame();
        }

        renovate10Btn.onclick = function() {
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            let pointsToGain10 = 10;
            if (prop.condition + 10 > 100) {
                pointsToGain10 = 100 - prop.condition;
            }
            processRenovation(pointsToGain10);
        }

        renovate20Btn.onclick = function() {
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            let pointsToGain20 = 20;
            if (prop.condition + 20 > 100) {
                pointsToGain20 = 100 - prop.condition;
            }
            processRenovation(pointsToGain20);
        }

        renovateMaxBtn.onclick = function() {
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            processRenovation(100 - prop.condition);
        }

        cancelRenovationBtn.onclick = function() { renovationModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.openListSaleModal = function(index, isAdjusting = false) {
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop) return;
            if (prop.isDelinquent) { showModal("Cannot List", "Property has a delinquent tenant. Resolve this issue before listing for sale.", 'warning'); return; }
            if (prop.isRented) { showModal("Cannot List", `${prop.name} is currently rented. Evict the tenant before listing for sale.`, 'warning'); return; }
            if (prop.isBeingMarketed) { showModal("Cannot List", "Property is currently being marketed.", 'warning'); return; }

            listSaleModalTitleEl.textContent = isAdjusting ? `Adjust Asking Price: ${prop.name}` : `List for Sale: ${prop.name}`;
            listSalePropertyInfoEl.innerHTML = `<p><strong>Original Purchase:</strong> $${formatCurrency(prop.purchasePrice)}</p><p><strong>Remaining Loan:</strong> $${formatCurrency(prop.remainingLoan)}</p><p><strong>Condition:</strong> ${prop.condition.toFixed(1)}%</p><p><strong>Months Owned:</strong> ${prop.monthsOwned}</p>`;
            listSaleMarketValueEl.textContent = formatCurrency(prop.currentMarketValue);
            askingPriceInputEl.value = prop.isListedForSale ? prop.askingPrice : Math.round(prop.currentMarketValue * 1.05);
            askingPriceInputEl.placeholder = `e.g., ${formatCurrency(Math.round(prop.currentMarketValue * 1.05))}`;
            confirmListSaleBtn.textContent = isAdjusting ? "Update Asking Price" : "List Property";
            listSaleModal.style.display = 'block';
        }
        confirmListSaleBtn.onclick = function() {
            const prop = player.properties[propertyToManageIndex]; if (!prop) return;
            const newAskingPrice = parseFloat(askingPriceInputEl.value);
            if (isNaN(newAskingPrice) || newAskingPrice <= 0) { showModal("Invalid Price", "Please enter a valid positive asking price.", 'warning'); return; }
            if (prop.isListedForSale) addLogEntry(`Asking price for ${prop.name} changed from $${formatCurrency(prop.askingPrice)} to $${formatCurrency(newAskingPrice)}.`);
            else { addLogEntry(`${prop.name} listed for sale with asking price $${formatCurrency(newAskingPrice)}.`); prop.timeOnMarket = 0; }
            prop.isListedForSale = true; prop.askingPrice = newAskingPrice; prop.isListedForRent = false;
            listSaleModal.style.display = 'none';
            updateAllUI(); saveGame();
        }
        cancelListSaleBtn.onclick = function() { listSaleModal.style.display = 'none'; propertyToManageIndex = -1; }

        window.deListProperty = function(index) {
            propertyToManageIndex = index; const prop = player.properties[propertyToManageIndex];
            if (!prop || !prop.isListedForSale) return;
            if (prop.isBeingMarketed) { showModal("Cannot De-list", "Property is currently being marketed. You cannot de-list it.", 'warning'); return; }

            prop.isListedForSale = false; prop.askingPrice = 0; prop.timeOnMarket = 0;
            addLogEntry(`${prop.name} has been de-listed from the sale market.`);
            showModal("Property De-listed", `${prop.name} is no longer for sale.`, 'info');
            propertyToManageIndex = -1; updateAllUI(); saveGame();
        }

        window.openOfferModal = function(index, buyerOfferAmount) {
            propertyToManageIndex = index; currentOfferForProperty = buyerOfferAmount;
            const prop = player.properties[propertyToManageIndex]; if (!prop || !prop.isListedForSale) return;
            offerModalTitleEl.textContent = `Buyer's Offer for ${prop.name}!`;
            offerPropertyInfoEl.innerHTML = `<p><strong>Market Value:</strong> $${formatCurrency(prop.currentMarketValue)}</p><p><strong>Condition:</strong> ${prop.condition.toFixed(1)}%</p><p><strong>Months Owned:</strong> ${prop.monthsOwned}</p>`;
            offerAskingPriceEl.textContent = formatCurrency(prop.askingPrice);
            offerBuyerOfferValueEl.textContent = formatCurrency(currentOfferForProperty);
            offerCounterInputEl.value = ''; offerCounterInputEl.placeholder = `e.g., ${formatCurrency(Math.round(currentOfferForProperty * 1.03))}`;
            offerModal.style.display = 'block';
        }

        acceptOfferBtn.onclick = function() {
            if (propertyToManageIndex === -1 || currentOfferForProperty === null) return;
            const prop = player.properties[propertyToManageIndex];
            if (prop.monthsOwned < 12) {
                openFlippingPenaltyModal(propertyToManageIndex, currentOfferForProperty);
            } else {
                finalizeSale(propertyToManageIndex, currentOfferForProperty);
            }
        }

        rejectOfferBtn.onclick = function() {
            if (propertyToManageIndex === -1) return;
            const prop = player.properties[propertyToManageIndex];
            addLogEntry(`You rejected offer of $${formatCurrency(currentOfferForProperty)} for ${prop.name}. Remains listed.`);
            showModal("Offer Rejected", `You rejected the buyer's offer. ${prop.name} remains on the market.`, 'warning');
            offerModal.style.display = 'none'; propertyToManageIndex = -1; currentOfferForProperty = null; updateAllUI();
        }

        submitOfferCounterBtn.onclick = function() {
            if (propertyToManageIndex === -1 || currentOfferForProperty === null) return;
            const prop = player.properties[propertyToManageIndex];
            const playerCounter = parseFloat(offerCounterInputEl.value);

            if (isNaN(playerCounter) || playerCounter <= 0) {
                showModal("Invalid Counter", "Please enter a valid positive amount.", 'warning'); return;
            }
            if (playerCounter <= currentOfferForProperty) {
                 showModal("Buyer Accepts!", `The buyer was happy to accept your lower counter of $${formatCurrency(playerCounter)}!`, 'success');
                 if (prop.monthsOwned < 12) {
                    openFlippingPenaltyModal(propertyToManageIndex, playerCounter);
                 } else {
                    finalizeSale(propertyToManageIndex, playerCounter);
                 }
                 return;
            }

            addLogEntry(`Countered $${formatCurrency(playerCounter)} for ${prop.name} (Offer: $${formatCurrency(currentOfferForProperty)}).`);

            let chanceOfAcceptance = 0;
            const buyerOffer = currentOfferForProperty;
            const askingPrice = prop.askingPrice;

            if (playerCounter > askingPrice) {
                chanceOfAcceptance = COUNTER_OFFER_MIN_ACCEPT_CHANCE;
            } else {
                const negotiationRange = askingPrice - buyerOffer;
                const counterPosition = playerCounter - buyerOffer;
                if (negotiationRange <= 0) {
                    chanceOfAcceptance = COUNTER_OFFER_MIN_ACCEPT_CHANCE;
                } else {
                    const percentIntoRange = counterPosition / negotiationRange;
                    const chanceRange = COUNTER_OFFER_NEGOTIATION_MAX_CHANCE - COUNTER_OFFER_NEGOTIATION_MIN_CHANCE;
                    chanceOfAcceptance = COUNTER_OFFER_NEGOTIATION_MAX_CHANCE - (percentIntoRange * chanceRange);
                }
            }
             // *** MODIFIED: Counter offer chance affected by market state ***
            if (marketState === MARKET_STATES.BOOM) {
                chanceOfAcceptance *= 0.8; // Buyers less likely to accept high counters in boom
            } else if (marketState === MARKET_STATES.BUST) {
                 chanceOfAcceptance *= 1.5; // Buyers more desperate, more likely to accept in bust
            }

            chanceOfAcceptance = Math.max(COUNTER_OFFER_MIN_ACCEPT_CHANCE, Math.min(COUNTER_OFFER_NEGOTIATION_MAX_CHANCE, chanceOfAcceptance));
            console.log(`Counter debug: Offer=${buyerOffer}, Asking=${askingPrice}, Counter=${playerCounter}, Chance=${chanceOfAcceptance}`);

            if (Math.random() < chanceOfAcceptance) {
                addLogEntry(`Buyer accepted counter of $${formatCurrency(playerCounter)} for ${prop.name}!`);
                if (prop.monthsOwned < 12) {
                    openFlippingPenaltyModal(propertyToManageIndex, playerCounter);
                } else {
                    finalizeSale(propertyToManageIndex, playerCounter);
                }
            } else {
                addLogEntry(`Buyer rejected counter of $${formatCurrency(playerCounter)} for ${prop.name}. Remains listed.`);
                showModal("Counter Rejected", `The buyer rejected your counter of $${formatCurrency(playerCounter)} (${(chanceOfAcceptance*100).toFixed(0)}% chance). ${prop.name} remains on the market.`, 'warning');
            }
            offerModal.style.display = 'none'; propertyToManageIndex = -1; currentOfferForProperty = null; updateAllUI();
        }


        function openFlippingPenaltyModal(propertyIndex, salePrice) {
            const prop = player.properties[propertyIndex];
            if (!prop || prop.monthsOwned >= 12) {
                finalizeSale(propertyIndex, salePrice);
                return;
            }

            const basePenaltyPercent = 0.12;
            const penaltyReductionPerMonth = 0.01;
            const currentPenaltyPercent = basePenaltyPercent - (prop.monthsOwned * penaltyReductionPerMonth);
            const penaltyAmount = prop.purchasePrice * currentPenaltyPercent;

            confirmFlippingSaleBtn.dataset.propertyIndex = propertyIndex;
            confirmFlippingSaleBtn.dataset.salePrice = salePrice;
            confirmFlippingSaleBtn.dataset.penaltyAmount = penaltyAmount;

            flippingPenaltyMessage.innerHTML = `
                You have only owned this property for <strong>${prop.monthsOwned} months</strong>.
                <br>Selling before 12 months incurs a penalty.
                <br>Your current penalty is <strong>${(currentPenaltyPercent * 100).toFixed(1)}%</strong> of the purchase price.
                <br><br>Purchase Price: $${formatCurrency(prop.purchasePrice)}
                <br><strong>Flipping Penalty: $${formatCurrency(penaltyAmount)}</strong>
                <br><br>Sale Price: $${formatCurrency(salePrice)}
                <br><strong>Net Sale (before loan): $${formatCurrency(salePrice - penaltyAmount)}</strong>
                <br><br>Do you want to proceed?`;

            flippingPenaltyModal.style.display = 'block';
            offerModal.style.display = 'none';
        }

        confirmFlippingSaleBtn.onclick = function() {
            const propertyIndex = parseInt(this.dataset.propertyIndex);
            const salePrice = parseFloat(this.dataset.salePrice);
            const penaltyAmount = parseFloat(this.dataset.penaltyAmount);

            if (isNaN(propertyIndex) || isNaN(salePrice) || isNaN(penaltyAmount)) {
                console.error("Flipping penalty modal error: Invalid data.");
                flippingPenaltyModal.style.display = 'none';
                return;
            }

            player.cash -= penaltyAmount;
            addLogEntry(`Paid a flipping penalty of $${formatCurrency(penaltyAmount)} for selling ${player.properties[propertyIndex].name} too early.`);

            finalizeSale(propertyIndex, salePrice);
            flippingPenaltyModal.style.display = 'none';
        }

        cancelFlippingSaleBtn.onclick = function() {
            flippingPenaltyModal.style.display = 'none';
            propertyToManageIndex = -1;
            currentOfferForProperty = null;
            addLogEntry("Sale cancelled to avoid flipping penalty.");
            showModal("Sale Cancelled", "You decided not to sell the property and avoid the flipping penalty.", 'info');
        }

        function finalizeSale(propertyIndex, salePrice) {
            const prop = player.properties[propertyIndex];
            const netCashFromSale = salePrice - prop.remainingLoan;
            player.cash += netCashFromSale;
            addLogEntry(`SOLD ${prop.name} for $${formatCurrency(salePrice)}. Net cash (after loan): $${formatCurrency(netCashFromSale)}.`);
            showModal("Property Sold!", `${prop.name} sold for $${formatCurrency(salePrice)}. Received $${formatCurrency(netCashFromSale)} after loan payoff.`, 'success');
            player.properties.splice(propertyIndex, 1);
            propertyToManageIndex = -1; currentOfferForProperty = null;
            listSaleModal.style.display = 'none'; offerModal.style.display = 'none';
            updateAllUI(); saveGame();
        }

        window.openMarketingConfirmModal = function(index) {
            propertyToManageIndex = index;
            const prop = player.properties[index];
            if (!prop) return;

            if (!prop.isListedForRent && !prop.isListedForSale) {
                showModal("Cannot Market", "You must list the property for rent or for sale before starting a marketing campaign.", 'warning');
                return;
            }

            let fee = 0; let campaignType = ""; let details = ""; let canMarket = true;

            if (prop.isListedForRent) {
                const estimatedRent = getEstimatedMonthlyRent(prop.currentMarketValue, prop.condition);
                fee = estimatedRent;
                campaignType = "Fast Rent Campaign";
                details = `This campaign will find a tenant within 2 months (50% chance next month, 100% chance by the 2nd month). The tenant will get their first month of rent free.`;
                marketingConfirmModalTitleEl.textContent = `Market for Rent: ${prop.name}`;

            } else if (prop.isListedForSale) {
                const price = prop.askingPrice;
                if (price <= 0) {
                    showModal("Invalid Price", "You must set a valid Asking Price before marketing for sale.", 'warning');
                    openListSaleModal(index);
                    return;
                }

                 const maxAllowedPrice = prop.currentMarketValue * MARKETING_ASKING_PRICE_CAP_PERCENT;
                 if (price > maxAllowedPrice) {
                     showModal("Price Too High for Marketing", `Your asking price ($${formatCurrency(price)}) is more than ${MARKETING_ASKING_PRICE_CAP_PERCENT * 100}% of the market value ($${formatCurrency(prop.currentMarketValue)}). Max allowed for marketing: $${formatCurrency(maxAllowedPrice)}. Please adjust the price first.`, 'warning');
                     canMarket = false;
                     openListSaleModal(index, true);
                     return;
                 }

                if (price < 100000) { fee = 1000; }
                else if (price >= 100000 && price <= 1000000) { fee = price * 0.01; }
                else { fee = 10000 + (price * 0.01); }
                fee = Math.round(fee);

                campaignType = "Fast Sale Campaign";
                details = `This campaign has a 70% chance to find a buyer within 2 months (50% chance next month, 40% chance the 2nd month). The buyer will make an offer between 95-100% of your asking price. If unsuccessful after 2 months, the campaign ends.`;
                marketingConfirmModalTitleEl.textContent = `Market for Sale: ${prop.name}`;
            }

            if (player.cash < fee) {
                showModal("Not Enough Cash", `You need $${formatCurrency(fee)} to start this marketing campaign. You only have $${formatCurrency(player.cash)}.`, 'error');
                return;
            }


            marketingConfirmPropertyInfoEl.innerHTML = `
                <p><strong>Property:</strong> ${prop.name}</p>
                <p><strong>Campaign Type:</strong> ${campaignType}</p>
                <p><strong>Condition:</strong> ${prop.condition.toFixed(1)}%</p>
                ${prop.isListedForSale ? `<p><strong>Asking Price:</strong> $${formatCurrency(prop.askingPrice)}</p>` : ''}
            `;
            marketingConfirmDetailsEl.textContent = details;
            marketingConfirmFeeEl.textContent = `$${formatCurrency(fee)}`;
            marketingConfirmModal.style.display = 'block';
        }
		
		confirmMarketingBtn.onclick = function() {
            if (propertyToManageIndex === -1) return;
            const prop = player.properties[propertyToManageIndex];
            if (!prop) return;

            let fee = 0; let logMessage = "";

            if (prop.isListedForRent) {
                fee = getEstimatedMonthlyRent(prop.currentMarketValue, prop.condition);
                prop.wasListedForRent = true;
                logMessage = `Paid $${formatCurrency(fee)} marketing campaign fee to find a tenant for ${prop.name}.`;
            } else if (prop.isListedForSale) {
                 const price = prop.askingPrice;
                 const maxAllowedPrice = prop.currentMarketValue * MARKETING_ASKING_PRICE_CAP_PERCENT;
                 if (price > maxAllowedPrice) {
                     showModal("Price Too High for Marketing", `Market value changed! Your asking price ($${formatCurrency(price)}) is now more than ${MARKETING_ASKING_PRICE_CAP_PERCENT * 100}% of the market value ($${formatCurrency(prop.currentMarketValue)}). Max allowed for marketing: $${formatCurrency(maxAllowedPrice)}. Please adjust the price first.`, 'error');
                     marketingConfirmModal.style.display = 'none';
                     openListSaleModal(propertyToManageIndex, true);
                     return;
                 }

                if (price < 100000) fee = 1000;
                else if (price >= 100000 && price <= 1000000) fee = price * 0.01;
                else fee = 10000 + (price * 0.01);
                fee = Math.round(fee);

                prop.wasListedForRent = false;
                logMessage = `Paid $${formatCurrency(fee)} marketing campaign fee to find a buyer for ${prop.name}.`;
            }

            if (player.cash < fee) {
                showModal("Error", "You no longer have enough cash for this campaign.", 'error');
                marketingConfirmModal.style.display = 'none';
                return;
            }

            player.cash -= fee;
            prop.isBeingMarketed = true;
            prop.marketingMonths = 0;
            prop.isListedForRent = false;
            prop.isListedForSale = false;
            addLogEntry(logMessage);
            showModal("Campaign Started!", `Your 2-month marketing campaign for ${prop.name} has begun! The fee of $${formatCurrency(fee)} has been paid.`, 'success');
            marketingConfirmModal.style.display = 'none';
            propertyToManageIndex = -1;
            updateAllUI();
            saveGame();
        }

        cancelMarketingBtn.onclick = function() {
            marketingConfirmModal.style.display = 'none';
            propertyToManageIndex = -1;
        }

        // --- LOAN FUNCTIONS ---

        externalLoanBtn.addEventListener('click', () => {
            externalLoanModalTitleEl.textContent = "Take Risky Cash Loan";
            externalLoanAmountInputEl.value = ''; externalLoanEstPaymentEl.textContent = '0';
            externalLoanModal.style.display = 'block';
        });

        bankLoanBtn.addEventListener('click', () => {
            if (player.bankLoanCooldown > 0) {
                showModal("On Cooldown", `You must wait ${player.bankLoanCooldown} more months to apply for a bank loan.`, 'warning');
                return;
            }
            if (player.properties.length === 0) {
                showModal("Collateral Required", "You must own at least one property to use as collateral for a bank loan.", 'warning');
                return;
            }
            if (player.cash < BANK_LOAN_APPLICATION_FEE) {
                showModal("Insufficient Funds", `You need $${formatCurrency(BANK_LOAN_APPLICATION_FEE)} cash for the application fee.`, 'warning');
                return;
            }

            bankLoanFeeTextEl.innerHTML = `A non-refundable application fee of <strong>$${formatCurrency(BANK_LOAN_APPLICATION_FEE)}</strong> will be charged.`;
            bankLoanAmountInputEl.value = '';
            bankLoanEstPaymentEl.textContent = '0';
            bankLoanModal.style.display = 'block';
        });

        window.setExternalLoanAmount = function(amount) {
            externalLoanAmountInputEl.value = amount; updateExternalLoanEstPayment();
        }
        externalLoanAmountInputEl.addEventListener('input', updateExternalLoanEstPayment);

        function updateExternalLoanEstPayment() {
            const principal = parseFloat(externalLoanAmountInputEl.value) || 0;
            if (principal <=0) { externalLoanEstPaymentEl.textContent = '0'; return; }
            const avgMonthlyInterest = (EXTERNAL_LOAN_MIN_MONTHLY_INTEREST + EXTERNAL_LOAN_MAX_MONTHLY_INTEREST) / 2;
            const n = EXTERNAL_LOAN_TERM_MONTHS;
            let monthlyPayment = calculateMonthlyPayment(principal, avgMonthlyInterest * 12, n);
            externalLoanEstPaymentEl.textContent = formatCurrency(monthlyPayment) + " (approx.)";
        }


	        bankLoanAmountInputEl.addEventListener('input', () => {
            const principal = parseFloat(bankLoanAmountInputEl.value) || 0;
            if (principal <= 0) {
                bankLoanEstPaymentEl.textContent = '0';
                return;
            }
            const monthlyPayment = calculateMonthlyPayment(principal, BANK_LOAN_ANNUAL_INTEREST_RATE, BANK_LOAN_TERM_MONTHS);
            bankLoanEstPaymentEl.textContent = formatCurrency(monthlyPayment);
        });

        confirmExternalLoanBtn.onclick = function() {
            const principal = parseFloat(externalLoanAmountInputEl.value);
            if (isNaN(principal) || principal <= 0) { showModal("Invalid Amount", "Please enter a valid positive loan amount.", 'warning'); return; }
            if (principal > player.netWorth * 2 && principal > 50000) { showModal("Loan Too Large", "Lenders are hesitant to offer such a large loan.", 'warning'); return; }

            const monthlyInterestRate = EXTERNAL_LOAN_MIN_MONTHLY_INTEREST + Math.random() * (EXTERNAL_LOAN_MAX_MONTHLY_INTEREST - EXTERNAL_LOAN_MIN_MONTHLY_INTEREST);
            const n = EXTERNAL_LOAN_TERM_MONTHS;
            let monthlyPayment = calculateMonthlyPayment(principal, monthlyInterestRate * 12, n);
            monthlyPayment = Math.round(monthlyPayment);

            const newLoan = {
                type: 'risky',
                id: `RISKY${Date.now().toString().slice(-5)}`,
                principal: principal, remainingBalance: principal,
                monthlyInterestRate: monthlyInterestRate, monthlyPayment: monthlyPayment,
                termMonths: EXTERNAL_LOAN_TERM_MONTHS, monthsPaid: 0
            };
            player.externalLoans.push(newLoan); player.cash += principal;
            addLogEntry(`RISKY MOVE: Took a risky loan of $${formatCurrency(principal)}. Monthly payment: $${formatCurrency(monthlyPayment)} for ${EXTERNAL_LOAN_TERM_MONTHS} months.`);
            showModal("Risky Loan Acquired", `You borrowed $${formatCurrency(principal)}. The (very high) monthly interest rate is ${(monthlyInterestRate * 100).toFixed(2)}%! Payment: $${formatCurrency(monthlyPayment)}.`, 'warning');
            externalLoanModal.style.display = 'none'; updateAllUI(); saveGame();
        }
        cancelExternalLoanBtn.onclick = function() { externalLoanModal.style.display = 'none'; }

        confirmBankLoanBtn.onclick = function() {
            const principal = parseFloat(bankLoanAmountInputEl.value);
            if (isNaN(principal) || principal <= 0) {
                showModal("Invalid Amount", "Please enter a valid positive loan amount.", 'warning');
                return;
            }
            if (player.cash < BANK_LOAN_APPLICATION_FEE) {
                showModal("Insufficient Funds", `You no longer have $${formatCurrency(BANK_LOAN_APPLICATION_FEE)} for the application fee.`, 'error');
                bankLoanModal.style.display = 'none';
                return;
            }

            player.cash -= BANK_LOAN_APPLICATION_FEE;
            addLogEntry(`Paid $${formatCurrency(BANK_LOAN_APPLICATION_FEE)} non-refundable bank loan application fee.`);

            if (Math.random() < BANK_LOAN_SUCCESS_CHANCE) {
                const monthlyInterestRate = BANK_LOAN_ANNUAL_INTEREST_RATE / 12;
                const monthlyPayment = Math.round(calculateMonthlyPayment(principal, BANK_LOAN_ANNUAL_INTEREST_RATE, BANK_LOAN_TERM_MONTHS));

                const newLoan = {
                    type: 'bank',
                    id: `BANK${Date.now().toString().slice(-5)}`,
                    principal: principal, remainingBalance: principal,
                    monthlyInterestRate: monthlyInterestRate, monthlyPayment: monthlyPayment,
                    termMonths: BANK_LOAN_TERM_MONTHS, monthsPaid: 0
                };
                player.externalLoans.push(newLoan);
                player.cash += principal;

                addLogEntry(`BANK LOAN APPROVED! Received $${formatCurrency(principal)}. Monthly payment: $${formatCurrency(monthlyPayment)} for ${BANK_LOAN_TERM_MONTHS} months.`);
                showModal("Loan Approved!", `Your bank loan for $${formatCurrency(principal)} was approved! Monthly payment: $${formatCurrency(monthlyPayment)}.`, 'success');

            } else {
                addLogEntry(`BANK LOAN REJECTED. You lost the $${formatCurrency(BANK_LOAN_APPLICATION_FEE)} fee and must wait 3 months.`);
                showModal("Loan Rejected", `Unfortunately, the bank rejected your application. You are on cooldown for ${BANK_LOAN_COOLDOWN_MONTHS} months.`, 'error');
                player.bankLoanCooldown = BANK_LOAN_COOLDOWN_MONTHS;
            }

            bankLoanModal.style.display = 'none';
            updateAllUI();
            saveGame();
        }

        cancelBankLoanBtn.onclick = function() { bankLoanModal.style.display = 'none'; }

        function openLoanAdModal() {
            loanAdModal.style.display = 'block';
        }
        loanAdTakeLoanBtn.onclick = function() { loanAdModal.style.display = 'none'; externalLoanBtn.click(); };
        loanAdDismissBtn.onclick = function() { loanAdModal.style.display = 'none'; };

        window.openJobApplicationConfirmModal = function(jobId) {
            jobToApplyForId = jobId;
            // *** MODIFIED: Use gameJobs ***
            const targetJob = gameJobs.find(j => j.id === jobId);
            if (!targetJob) {
                console.error("Target job not found for confirmation:", jobId);
                return;
            }
            jobConfirmModalTitleEl.textContent = `Confirm Application: ${targetJob.title}`;
            jobConfirmDetailsEl.innerHTML = `
                <p><strong>Job Title:</strong> ${targetJob.title}</p>
                <p><strong>Field:</strong> ${targetJob.field}</p>
                <p><strong>Salary:</strong> $${formatCurrency(targetJob.salary)}/month</p>
            `;
            jobApplicationConfirmModal.style.display = 'block';
        }

        confirmJobApplicationBtn.onclick = function() {
            if (jobToApplyForId) {
                processJobApplication(jobToApplyForId);
            }
            jobApplicationConfirmModal.style.display = 'none';
            jobToApplyForId = null;
        }
        cancelJobApplicationBtn.onclick = function() {
            jobApplicationConfirmModal.style.display = 'none';
            jobToApplyForId = null;
        }

        function processJobApplication(jobId) {
            // *** MODIFIED: Use gameJobs ***
            const targetJob = gameJobs.find(j => j.id === jobId);
            const currentPlayerJob = gameJobs.find(j => j.id === player.currentJobId);
            if (!targetJob || !currentPlayerJob) {
                console.error("Job application error: Target or current job not found.");
                return;
            }

            let canApply = true; let reason = "";
            if (targetJob.prerequisites) {
                const currentJobField = currentPlayerJob.field;
                if (targetJob.prerequisites.field && currentJobField !== targetJob.prerequisites.field && targetJob.level > 0) {
                    canApply = false; reason = "Not in the required field for this level.";
                }
                if (canApply && targetJob.prerequisites.previousJobLevel !== undefined && currentPlayerJob.level < targetJob.prerequisites.previousJobLevel) {
                    canApply = false; reason = `Requires a higher job level (current: ${currentPlayerJob.level}, needed: ${targetJob.prerequisites.previousJobLevel}).`;
                }
                if (canApply && targetJob.prerequisites.minExperienceInFieldMonths) {
                    let experienceInTargetField = (currentJobField === targetJob.field) ? player.totalExperienceInFieldMonths : 0;
                    if (experienceInTargetField < targetJob.prerequisites.minExperienceInFieldMonths) {
                         canApply = false; reason = `Requires ${(targetJob.prerequisites.minExperienceInFieldMonths / 12).toFixed(1)} years experience in ${targetJob.field}. You have ${(experienceInTargetField / 12).toFixed(1)} in this field.`;
                    }
                }
            }
            if (!canApply) {
                showModal("Cannot Apply", `You do not meet the prerequisites for ${targetJob.title}. Reason: ${reason}`, 'warning'); return;
            }
            let successChance = JOB_APPLICATION_BASE_SUCCESS_CHANCE;
            if (targetJob.prerequisites && targetJob.prerequisites.minExperienceInFieldMonths) {
                const experienceInTargetField = (currentPlayerJob.field === targetJob.field) ? player.totalExperienceInFieldMonths : 0;
                const extraExperienceFactor = Math.max(0, (experienceInTargetField - targetJob.prerequisites.minExperienceInFieldMonths) / 12);
                successChance += extraExperienceFactor * 0.05;
            }
            if (targetJob.field === currentPlayerJob.field && targetJob.level === currentPlayerJob.level + 1) successChance += 0.15;

            // *** MODIFIED: Job application chance affected by market state ***
            if (marketState === MARKET_STATES.BUST) {
                successChance *= 0.6; // Harder to get jobs in a bust
            } else if (marketState === MARKET_STATES.BOOM) {
                 successChance *= 1.2; // Easier to get jobs in a boom
            }

            successChance = Math.min(0.95, successChance);

            if (Math.random() < successChance) {
                addLogEntry(`üéâ Got the job! You are now a ${targetJob.title} with a salary of $${formatCurrency(targetJob.salary)}.`);
                showModal("Application Successful!", `Congratulations! You've been hired as a ${targetJob.title}. Your new salary is $${formatCurrency(targetJob.salary)}.`, 'success');
                const oldJobField = currentPlayerJob.field;
                player.currentJobId = targetJob.id;
                player.salary = targetJob.salary;
                player.experienceInCurrentJobMonths = 0;
                if (oldJobField !== targetJob.field) {
                    player.totalExperienceInFieldMonths = 0;
                }
                availableJobs = [];
                addLogEntry("Job search concluded for this month.");
            } else {
                addLogEntry(`Application for ${targetJob.title} was rejected.`);
                showModal("Application Unsuccessful", `Unfortunately, your application for ${targetJob.title} was not successful this time.`, 'warning');
                const rejectedJobIndex = availableJobs.findIndex(job => job.id === jobId);
                if (rejectedJobIndex > -1) {
                    availableJobs.splice(rejectedJobIndex, 1);
                    addLogEntry(`Job opening for ${targetJob.title} removed for this month.`);
                }
            }
            updateAllUI(); saveGame();
        }

        // --- GAME STATE & INITIALIZATION ---

        const SAVE_KEY = "propertyTycoonSaveData";

        // *** MODIFIED: Save new inflation and market data ***
        function saveGame() {
            try {
                const gameState = {
                    player: player,
                    currentMonth: currentMonth,
                    gameLog: gameLog,
                    firstMonthAdvanced: firstMonthAdvanced,
                    availableProperties: availableProperties,
                    availableJobs: availableJobs,
                    // Inflation-related data
                    gamePropertyTypes: gamePropertyTypes,
                    gameJobs: gameJobs,
                    currentInflationRate: currentInflationRate,
                    CLEANING_FEE_MIN: CLEANING_FEE_MIN,
                    CLEANING_FEE_MAX: CLEANING_FEE_MAX,
                    BANK_LOAN_APPLICATION_FEE: BANK_LOAN_APPLICATION_FEE,
                    // Market Cycle data
                    marketState: marketState,
                    marketStateMonths: marketStateMonths
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error("Error saving game:", e);
                showModal("Save Error", "Could not save game progress to local storage.", 'error');
            }
        }

        // *** MODIFIED: Load new inflation and market data w/ backwards compatibility ***
        function loadGame() {
            try {
                const savedData = localStorage.getItem(SAVE_KEY);
                if (savedData) {
                    const gameState = JSON.parse(savedData);

                    player = { ...player, ...gameState.player };
                    player.properties = gameState.player.properties || [];
                    player.externalLoans = gameState.player.externalLoans || [];
                    player.bankLoanCooldown = gameState.player.bankLoanCooldown || 0;
                    player.lastMonthCashChange = gameState.player.lastMonthCashChange || 0;

                    // Backwards compatibility for disaster icons & monthsOwned
                    player.properties.forEach(prop => {
                        if (prop.isBeingMarketed === undefined) prop.isBeingMarketed = false;
                        if (prop.marketingMonths === undefined) prop.marketingMonths = 0;
                        if (prop.wasListedForRent === undefined) prop.wasListedForRent = false;
                        if (prop.tenantFirstMonthFree === undefined) prop.tenantFirstMonthFree = false;
                        if (prop.monthsOwned === undefined) {
                            prop.monthsOwned = prop.monthsPaid || 0;
                        }
                        if (prop.hasDisasterIcon === undefined) prop.hasDisasterIcon = false;
                        if (prop.disasterIcon === undefined) prop.disasterIcon = '';
                    });

                    currentMonth = gameState.currentMonth;
                    gameLog = gameState.gameLog || ["Game loaded."];
                    firstMonthAdvanced = gameState.firstMonthAdvanced || false;

                    availableProperties = gameState.availableProperties || [];
                    availableJobs = gameState.availableJobs || [];

                    // Load inflation data, with fallback for old saves
                    if (gameState.gameJobs) {
                        gameJobs = gameState.gameJobs;
                    } else {
                        gameJobs = JSON.parse(JSON.stringify(JOBS)); // Deep copy
                    }
                    if (gameState.gamePropertyTypes) {
                        gamePropertyTypes = gameState.gamePropertyTypes;
                    } else {
                        gamePropertyTypes = JSON.parse(JSON.stringify(PROPERTY_TYPES)); // Deep copy
                    }
                    currentInflationRate = gameState.currentInflationRate || 0.0;
                    CLEANING_FEE_MIN = gameState.CLEANING_FEE_MIN || 100;
                    CLEANING_FEE_MAX = gameState.CLEANING_FEE_MAX || 500;
                    BANK_LOAN_APPLICATION_FEE = gameState.BANK_LOAN_APPLICATION_FEE || 500;

                    // *** NEW: Load Market Cycle data, with fallback ***
                    marketState = gameState.marketState || MARKET_STATES.NORMAL;
                    marketStateMonths = gameState.marketStateMonths || 0;
                    applyMarketStateEffects(); // Apply effects from loaded state
                    // *** END NEW ***

                    if (firstMonthAdvanced && gameHeaderEl) {
                        gameHeaderEl.classList.add('header-hidden');
                    } else if (gameHeaderEl) {
                        gameHeaderEl.classList.remove('header-hidden');
                    }

                    addLogEntry("Game progress loaded successfully.");
                    console.log("Loaded player data:", JSON.parse(JSON.stringify(player)));
                    return true;
                }
            } catch (e) {
                console.error("Error loading game:", e);
                showModal("Load Error", "Could not load saved game. Starting a new game.", 'error');
                localStorage.removeItem(SAVE_KEY);
            }
            return false;
        }

        newLifeBtn.addEventListener('click', () => {
            resetConfirmModal.style.display = 'block';
        });

        confirmResetBtn.onclick = function() {
            localStorage.removeItem(SAVE_KEY);
            addLogEntry("Progress reset. Starting a new life!");
            showModal("New Life Started", "Your progress has been reset.", "info");
            resetConfirmModal.style.display = 'none';
            initializeGame(true);
        }
        cancelResetBtn.onclick = function() {
            resetConfirmModal.style.display = 'none';
        }


        function updateAllUI() {
            try {
                renderPlayerStats(); // Updated to show market state
                calculateAndRenderCashflow();
                renderPropertyListings();
                renderOwnedProperties();
                renderJobMarket();
                renderGameLog();
                renderLoanButtons();
            } catch (e) {
                console.error("Error during updateAllUI:", e);
                const body = document.querySelector('body');
                if (body) {
                    let errorDiv = document.getElementById('global-error-message');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.id = 'global-error-message';
                        errorDiv.style.position = 'fixed'; errorDiv.style.top = '10px'; errorDiv.style.left = '10px';
                        errorDiv.style.padding = '10px'; errorDiv.style.backgroundColor = 'red'; errorDiv.style.color = 'white';
                        errorDiv.style.zIndex = '2000';
                        errorDiv.textContent = 'A critical error occurred updating the game UI. Please check console.';
                        body.appendChild(errorDiv);
                    }
                }
            }
        }
        nextMonthBtn.addEventListener('click', advanceMonth);
        restartGameBtn.addEventListener('click', () => {
            gameOverOverlayEl.style.display = 'none';
            initializeGame(true);
        });

        // *** MODIFIED: Initialize new game state vars, including market state ***
        function initializeGame(forceNew = false) {
            try {
                let gameWasLoaded = false;
                if (!forceNew) {
                    gameWasLoaded = loadGame();
                }

                if (gameWasLoaded) {
                    console.log("Game was loaded. Skipping full new game initialization.");
                    if (!availableProperties || availableProperties.length === 0) generateNewProperties();
                    if (!availableJobs || availableJobs.length === 0) generateJobOpportunities();
                    loanSectionToggleBtn.classList.add('collapsed');
                    loanSectionContentEl.classList.add('collapsed');
                    updateAllUI();
                    showTab('market');
                    return;
                }

                console.log("Initializing a new game...");

                // Deep copy const data into mutable game state
                gamePropertyTypes = JSON.parse(JSON.stringify(PROPERTY_TYPES));
                gameJobs = JSON.parse(JSON.stringify(JOBS));
                currentInflationRate = 0.0;
                CLEANING_FEE_MIN = 100;
                CLEANING_FEE_MAX = 500;
                BANK_LOAN_APPLICATION_FEE = 500;

                // *** NEW: Initialize market state ***
                marketState = MARKET_STATES.NORMAL;
                marketStateMonths = 0;
                applyMarketStateEffects(); // Apply initial normal effects
                // *** END NEW ***

                const startingJob = gameJobs.find(j => j.id === "unskilled0");
                if (!startingJob) {
                    console.error("CRITICAL ERROR: Starting job 'unskilled0' not found in gameJobs array!");
                    alert("CRITICAL ERROR: Starting job definition missing. Game cannot start.");
                    return;
                }
                const deathAgeYears = 60 + Math.floor(Math.random() * 31);
                const deathAgeMonths = deathAgeYears * 12;

                player = {
                    ageMonths: 18 * 12, cash: INITIAL_CASH,
                    currentJobId: "unskilled0", experienceInCurrentJobMonths: 0, totalExperienceInFieldMonths: 0,
                    salary: startingJob.salary,
                    netWorth: INITIAL_CASH, properties: [], externalLoans: [],
                    deathAgeYears: deathAgeYears,
                    deathAgeMonths: deathAgeMonths,
                    bankLoanCooldown: 0,
                    lastMonthCashChange: 0
                };
                availableProperties = []; availableJobs = [];
                gameLog = ["Game started. Good luck!"]; currentMonth = 0;
                firstMonthAdvanced = false;
                selectedLoanTermMonths = AVAILABLE_LOAN_TERMS.find(t => t.years === 20).months;
                propertyToManageIndex = -1; currentOfferForProperty = null; jobToApplyForId = null;
                nextMonthBtn.disabled = false; nextMonthBtn.classList.remove('button-disabled'); nextMonthBtn.textContent = "Advance to Next Month";

                if (gameHeaderEl) {
                    gameHeaderEl.classList.remove('header-hidden');
                }
                gameOverOverlayEl.style.display = 'none';
                loanSectionToggleBtn.classList.add('collapsed');
                loanSectionContentEl.classList.add('collapsed');

                generateNewProperties();
                generateJobOpportunities();
                updateAllUI();
                cashChangeIndicatorEl.classList.remove('visible');

                const initialJobTitle = startingJob.title;
                addLogEntry(`Welcome to Property Tycoon! Start with $${formatCurrency(INITIAL_CASH)} as ${initialJobTitle}. You will live to be ${player.deathAgeYears}.`);

                showTab('market');
                saveGame();
            } catch (e) {
                console.error("Error during initializeGame:", e);
                const body = document.querySelector('body');
                if (body) {
                    body.innerHTML = '<div style="color: red; padding: 20px; font-size: 1.2em;">Critical Error during Game Initialization. Please check the console and refresh.</div>';
                }
            }
        }
        // *** END MODIFIED FUNCTION ***

        window.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM fully loaded and parsed. Initializing game...');
            initializeGame();

            if(tabBtnMarket && tabBtnJobs) {
                tabBtnMarket.addEventListener('click', () => showTab('market'));
                tabBtnJobs.addEventListener('click', () => showTab('jobs'));
            } else {
                console.error("Could not find tab buttons to attach listeners.");
            }

            if (loanSectionToggleBtn && loanSectionContentEl) {
                loanSectionToggleBtn.addEventListener('click', () => {
                    loanSectionToggleBtn.classList.toggle('collapsed');
                    loanSectionContentEl.classList.toggle('collapsed');
                });
            } else {
                console.error("Could not find loan section toggle elements.");
            }
        });


    </script>
</body>
</html>

